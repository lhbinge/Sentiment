---
output: 
    pdf_document:
        fig_caption: yes
        number_sections: true
fontsize: 11pt
geometry: margin=1in
header-includes:
   - \usepackage{multirow}
bibliography: References.bib
csl: harvard.csl
---

\begin{center}
\Large\scshape{Research Report on the BER Business Tendency Surveys} \\ 
\vspace{1em}
\large\normalfont{Laurie Binge}\\
\normalsize\normalfont{This draft: \today} 
\end{center}

#Introduction
This reports presents the results from our research on the microdata from BER business tendency surveys. After cleaning the microdata, we calculate the balance statistics for all of the sectors and check that the microdata provides results that are consistent with the BER's published results. Next, we calculate new series for all of the questions, for the main sectors, subsectors, and the three main regions. In many cases the new series use updated weights and a two-step weighting procedure. Finally, we compare each set of results to their respective reference series, to evaluate the tracking record of responses to the activity questions. In all cases the new series are calculated in R and exported to Excel.

We have interpolated a few missing values by replacing the missing values with the published series, where available. In the cases where there were no published series we have just used simple linear interpolation to create complete continuous series. All the duplicates have been removed from the calculations. Duplications may arise due to some respondents answering in both email/fax format, as well as via post. The BER only uses the first response that it receives.

The latecomers are excluded from the calculations, as we have decided to stick to the BER's convention. The results below illustrate that the inclusion of latecomers does not influence the results substantially, with only slight changes at the subsector level. Since 2016Q2, however, the BER has included imputed values, in order to increase the number of responses and to decrease the volatility of the balance series. An imputed value refers to a latecomer in period $t-1$, who had not responded in time in period $t$. For example, all the latecomers in 2017Q1, who had not responded in time in 2017Q2, were added to the 2017Q2 responses. If such a firm was also a latecomer in 2017Q2, the response may potentially be an imputed value in 2017Q3, if it is a latecomer again. The imputed values are reflected in the published results since 2016Q2, and are therefore included in the comparisons below. The balances calculated with more stable samples of firms, i.e. firms that responded in consecutive quarters or firms that responded to more than half of all surveys, were remarkably similar to the balances using the full sample. This suggests that the results are quite robust.

The report proceeds as follows: the survey results for the main sectors are evaluated separately. The report discusses the changes to the raw microdata that were necessary to produce results consistent with the BER's published series. The balances calculated from the microdata are then compared to the published series. The new series are then calculated with alternative weighting procedures. Each set of series is then compared to their respective references series to evaluate their tracking record. Finally, the different series are compared in terms of their volatility. 

```{r readdata, echo=FALSE, results='hide', message=FALSE, warning=FALSE, cache = TRUE}
setwd("C:\\Users\\Laurie\\OneDrive\\Documents\\BING\\BER Confidence Surveys\\Sentiment")
#change the working directory

suppressMessages(library(ggplot2))
suppressMessages(library(plyr))
suppressMessages(library(dplyr))
suppressMessages(library(reshape2))
suppressMessages(library(stargazer))
suppressMessages(library(xtable))
suppressMessages(library(scales))
suppressMessages(library(quantmod))
suppressMessages(library(vars))
suppressMessages(library(tseries))
suppressMessages(library(urca))
suppressMessages(library(zoo))

##=====================##
## READING IN THE DATA ##
##=====================##

datums <- read.csv("dates.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
datums$Datum <- as.Date(datums$Datum, format = "%Y/%m/%d")

##=====================##
##Define Functions
##=====================##

ongeweeg <- function(data,sektor,streek,d) {
    data <- data[data$sector %in% sektor & data$region %in% streek,]
    sector <- aggregate(data[,(match("surveyQ",colnames(data))+1):ncol(data)], 
                        by=list(data$surveyQ), FUN=mean, na.rm=TRUE)
    sector$Obs <- aggregate(data$Q2A, by=list(data$surveyQ), FUN=length)[,2]
    sector <- merge(datums[d,],sector, by.x="Date", by.y="Group.1", all=TRUE)
    sector <- sector[,c(1:2,ncol(sector),3:(ncol(sector)-1))]
    sector[,-1:-3] <- na.approx(sector[,-1:-3]*100)
    return(sector)
}


geweeg <- function(data,sektor,streek,d) {
    weeg <- function(temp) {  #calculate weighted mean for each quarter for all columns
        temp <- cbind(factor=temp$factor,temp$factor*temp[(match("surveyQ",colnames(temp))+1):ncol(temp)])
        temp <- colSums(temp, na.rm=TRUE, dims = 1)/    #calculate the sum(wi*xi)/sum(wi)
            sapply(colnames(temp), function(x) sum(temp$factor[!is.na(temp[colnames(temp) == x])]))
        return(temp) #weight only by those that responded to a specific question
    }
    
    data <- data[data$sector %in% sektor & data$region %in% streek,]
    sector <- data.frame()
    for(kwartaal in levels(data$surveyQ)) {
        sector <- rbind(sector,weeg(data[data$surveyQ==kwartaal,]))
    }
    sector[,1] <- levels(data$surveyQ)
    colnames(sector) <- colnames(data)[(match("surveyQ",colnames(data))):ncol(data)]
    sector$Obs <- aggregate(data$Q2A, by=list(data$surveyQ), FUN=length)[,2]
    sector <- merge(datums[d,],sector, by.x="Date", by.y="surveyQ", all=TRUE)
    sector <- sector[,c(1:2,ncol(sector),3:(ncol(sector)-1))]
    sector[,-1:-3] <- na.approx(sector[,-1:-3]*100)
    return(sector)
}


#Explicit 2-step weighting
geweeg2 <- function(sektor=all,streek=streke) {
    weeg2 <- function(temp) {  #calculate weighted mean for each quarter for all columns
        sectorw=temp$sectorw[1]
        temp <- cbind(firmw=temp$firmw,temp$firmw*temp[(match("surveyQ",colnames(temp))+1):ncol(temp)])
        #temp <- colSums(temp, na.rm=TRUE, dims = 1)/sum(temp$factor, na.rm=TRUE)
        #calculate the sum(wi*xi)/sum(wi)
        temp <- colSums(temp, na.rm=TRUE, dims = 1)/    
            sapply(colnames(temp), function(x) sum(temp$firmw[!is.na(temp[colnames(temp) == x])]))
        temp <- c(sectorw,temp)
        #weight only by those that responded to a specific question
        return(temp)
    }
    man <- BER.M2[BER.M2$sector %in% sektor & BER.M2$region %in% streek,]
    sector <- data.frame()
    for(kwartaal in levels(man$surveyQ)) {
        sector <- rbind(sector,weeg2(man[man$surveyQ==kwartaal,]))
    }
    sector <- sector *100
    sector[,2] <- levels(man$surveyQ)
    colnames(sector) <- colnames(man)[c(7,9:ncol(man))]
    sector <- merge(datums,sector, by.x="Date", by.y="surveyQ", all=TRUE)
    #sector <- as.data.frame(t(sapply(levels(man$surveyQ), function(kwartaal) weeg(man[man$surveyQ==kwartaal,]))))
    sector[,3:58] <- na.approx(sector[,3:58],na.rm = FALSE)
    return(sector)
}

maak.index <- function(sektor=all,streek=streke) {
    lys <- list()
    t <- 0
    for(k in sektor) {
        t <- t+1
        lys[[t]] <- geweeg2(k)
    }
    saam <- lys[[1]]
    for(j in 4:60) {
        for(i in 1:100) {
            x <- NULL
            w <- NULL
            for(t in 1:length(sektor)) {
                x <- c(x,lys[[t]][i,j])
                w <- c(w,lys[[t]][i,3])
            }
            saam[i,j] <- weighted.mean(x,w,na.rm=TRUE) 
        }
    }
    saam <- saam[,-3]
    return(saam)
}
```

#The Building Survey
```{r B.build, echo=FALSE, results='hide', message=FALSE, warning=FALSE, cache = TRUE}
pub_b <- read.csv("Building_BER_Published.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
ref_b <- read.csv("Ref Series_Build.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)

pub_a <- read.csv("Arc_Published.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)

#BUILDING
BER.B <- read.csv("Building_93Q2-17Q2.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
#BER.B <- read.csv("Building_full.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
colnames(BER.B)[1:6] <- c("region","id","sector","weight","factor","surveyQ")
BER.B$surveyQ <- toupper(BER.B$surveyQ)
BER.B$sector <- factor(BER.B$sector) #could include labels
BER.B$id <- factor(BER.B$id)
BER.B$region <- factor(BER.B$region)

#Clean SurveyQ variable
BER.B$temp <- NULL
for(i in 1:nrow(BER.B)) {
    ifelse(substr(BER.B$surveyQ[i], 1, 1)==9, 
           BER.B$temp[i] <- paste0("19",BER.B$surveyQ[i],sep=""),
           BER.B$temp[i] <- paste0("20",BER.B$surveyQ[i],sep=""))
}
BER.B$surveyQ <- BER.B$temp
BER.B <- BER.B[,-ncol(BER.B)]
BER.B$surveyQ <- factor(BER.B$surveyQ)

#Clean regions
#Mode <- function(x) {
#    ux <- na.remove(unique(x))
#    ux[which.max(tabulate(match(x, ux)))]
#}
#fout <- c("1995Q1")
#for(i in levels(BER.B$id)) {
#    BER.B$region[(BER.B$surveyQ %in% fout) & (BER.B$id == i)] <- Mode(BER.B$region[(BER.B$id == i)]) 
#    
#}

#Exclude Latecomers and old quesions
BER.B <- BER.B[BER.B$Latecomer == FALSE | is.na(BER.B$Latecomer),]
BER.B <- BER.B[,1:20]
BER.B <- BER.B[,!grepl("X",colnames(BER.B))]    

#Replace Values
for(i in 7:16) {
    BER.B[,i] <- replace(BER.B[,i], BER.B[,i]==2, 0)
    BER.B[,i] <- replace(BER.B[,i], BER.B[,i]==3,-1)
}
for(i in 17:20) {
    BER.B[,i] <- replace(BER.B[,i], BER.B[,i]==1, 1)
    BER.B[,i] <- replace(BER.B[,i], BER.B[,i]==2, 0.5)
    BER.B[,i] <- replace(BER.B[,i], BER.B[,i]==3, 0)
}

#Impute Latecomers
#Dit lyk asof die Latecomers klaar gedupliseer is en gemerk is as Imputed

#--------------------------
#Architects, QSs and Civil Engineers
skoon <- function(data) {
    colnames(data)[1:6] <- c("region","id","sector","weight","factor","surveyQ")
    data$surveyQ <- toupper(data$surveyQ)
    data$sector <- factor(data$sector) #could include labels
    data$id <- factor(data$id)
    data$region <- factor(data$region)
    
    data$temp <- NULL
    for(i in 1:nrow(data)) {
        data$temp[i] <- paste0("20",data$surveyQ[i],sep="")
    }
    data$surveyQ <- data$temp
    data <- data[,-ncol(data)]
    data$surveyQ <- factor(data$surveyQ)
    
    for(i in 7:(ncol(data)-6)) {
        data[,i] <- replace(data[,i], data[,i]==2, 0)
        data[,i] <- replace(data[,i], data[,i]==3,-1)
    }
    
    if(ncol(data)>23) {
        for(i in 17:20) {
            data[,i] <- replace(data[,i], data[,i]==0, 0.5)
            data[,i] <- replace(data[,i], data[,i]==-1, 0)
        }
    }
    
    data <- data[data$Latecomer == FALSE | is.na(data$Latecomer),]
    data <- data[,1:(ncol(data)-6)]
    return(data)
}

arc <- skoon(read.csv("Argitekte.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE))
qs <- skoon(read.csv("QS.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE))
civil <- skoon(read.csv("Civils.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE))[,-21:-22]

#BUILDING
residential <- c(5000,6000)
non_residential <- c(5010,6010)
contractor_res <- 5000
contractor_nonres <- 5010
contractor <- c(5000,5010)
subcon_res <- 6000
subcon_nonres <- 6010
subcon <- c(6000,6010)
all_b <- c(5000,5010,6000,6010)
streke <- unique(BER.B$region)

arcs <- 99
civils <- c(700,701,702,703)
qss <- 88

##======================##
## CALCULATE INDICATORS ##
##======================##
#BUILDING
Building <- ongeweeg(BER.B,all_b,streke,6:102)
BER.B$factor <- BER.B$weight
Building_w <- geweeg(BER.B,all_b,streke,6:102)

Residential <- ongeweeg(BER.B,residential,streke,6:102)
Non_residential <- ongeweeg(BER.B,non_residential,streke,6:102)
Contractor_res <- ongeweeg(BER.B,contractor_res,streke,6:102)
Contractor_nonres <- ongeweeg(BER.B,contractor_nonres,streke,6:102)
Contractor <- ongeweeg(BER.B,contractor,streke,6:102)
Subcon_res <- ongeweeg(BER.B,subcon_res,streke,6:102)
Subcon_nonres <- ongeweeg(BER.B,subcon_nonres,streke,6:102)
Subcon <- ongeweeg(BER.B,subcon,streke,6:102)

WC.B <- ongeweeg(BER.B,all_b,1,6:102)
KZN.B <- ongeweeg(BER.B,all_b,5,6:102)
GP.B <- ongeweeg(BER.B,all_b,6,6:102)

#Interpolasie
Contractor[c(3,22,29,51),c(4,5,7,9,11,13)] <- pub_b[c(3,22,29,51),2:7]
Contractor_res[c(3,22,29,51),c(4,5,7,9,11,13)] <- pub_b[c(3,22,29,51),11:16]
Contractor_nonres[c(3,22,29,51),c(4,5,7,9,11,13)] <- pub_b[c(3,22,29,51),20:25]
Subcon[c(3,22,29,51),c(4,5,7,9,11,13)] <- pub_b[c(3,22,29,51),29:34]
Subcon_res[c(3,22,29,51),c(4,5,7,9,11,13)] <- pub_b[c(3,22,29,51),38:43]
Subcon_nonres[c(3,22,29,51),c(4,5,7,9,11,13)] <- pub_b[c(3,22,29,51),47:52]

#----------------------------
Architects <- ongeweeg(arc,arcs,streke,38:102)
Civils <- ongeweeg(civil,civils,streke,38:102)
QSs <- ongeweeg(qs,qss,streke,38:102)

#Interpolasie
#Architects[c(19),c(3,4,6,8,10,12)] <- pub_a[c(19),2:7]
#QSs[c(11,19),c(3,4,6,8,10,12)] <- pub_a[c(11,19),8:13]
#Civils[c(19),c(3,4,6,8,10,12:15)] <- pub_a[c(19),14:22]
```

In this section we examine the Building sector surveys and results. We have used the Building survey microdata to calculate the results for the period 1993Q2-2017Q2. 

##Collating and Cleaning the Microdata
In order to match the questions and responses in the different versions of the surveys, the surveys in the old records were compared to the current incarnations. We identified and marked the questions in the old (pre-2001) Building surveys and then matched them to the new survey questions. The old questionnaires have been uploaded to the Dropbox folder.[^1] 

There were a number of errors in the raw microdata files.[^2] We corrected the errors relating to the questionnaires in the raw microdata files. There were also a number of errors relating to the region codes[^3], which have been corrected. For instance, there was a clear change in region codes in 1995Q1, and region code before that (1993Q2-1994Q4) differ again. We have corrected these region codes by taking the mode for each individual respondent, i.e. the codes with the highest frequencies for each ID code. The corrected Excel files have been uploaded to the Dropbox folder.

[^1]: In the scanned copies, X's denote questions that are no longer asked. Yellow denotes the Q1 consistency check - all the responses must be either 1s or 2s. Green denotes the questions that were only asked in earlier (pre-1996Q3) surveys. Red denotes apparent coding mistakes that we have corrected.

[^2]: In the pre-2001 data, Q8 and Q6 seemed to have changed, which led to large spikes (e.g. in 1995Q1). In the post-2001, responses for Q11 were recorded, but the question does not seem to exist.

[^3]: In the pre-2001 sample there were 9 region codes, but in the post-2001 sample there were 8 region codes. We assume that the following key holds in both samples: 01=WC, 05=KZN, 06=GP. 

Table 1 reports some characteristics of the Building survey microdata. The Building microdata are missing for the following quarters: 1993Q4, 1998Q3, 2000Q2 and 2005Q4. Where published series were available, we used the published values for those missing values. Where they were unavailable, we used simple linear interpolation to create complete continuous series. We compared the substitution of the published values (for the series that are available) with simple linear interpolation. There is very little difference (only a few values were missing).

```{r table1, echo=FALSE, results='asis', warning=FALSE, message=FALSE, cache = TRUE}
ave <- mean(aggregate(BER.B$id, by=list(BER.B$surveyQ), FUN = length)[,2])
tafel <- cbind("1993Q2-2017Q2",length(BER.B$id),round(ave,2),
               "1993Q4,1998Q3,2000Q2,2005Q4")
colnames(tafel) <- c("Sample","Total Obs","Obs/Quarter","Missing Quarters")     
row.names(tafel) <- "Building Survey"
xt <- xtable(tafel, caption="Sample characteristics")
print(xt, "latex",comment=FALSE, caption.placement = getOption("xtable.caption.placement", "top"), scalebox = 0.8,
      include.rownames=TRUE)
```

Table 2 reports the subsector codes that were used to split the sample. The subsectors that the BER calculated before are *contractors* (total, residential and non-residential), and *subcontractors* (total, residential and non-residential). The new sectors are the *residential*, *non-residential* and *total building* sectors. These aggregations are added to make the survey results comparable to the official data. Official data is only available for the residential sector, non-residential sector and the total construction sector. No high frequency series for contractors and sub-contractors are published. Figure 1 illustrates the number of respondents to the Building survey, by subsector.


##The Building Sector Indicators
Formally, one can define a $k$-period-ahead expectations measure $(C_t^k)$ at time $t$ as: $C _t^k = E_t f(\Delta^h Y_{t+k})$, where $Y_{t+k}$ is a measure of real activity at time $t+k$ and $\Delta^h Y_{t+k} = Y_{t+k} - Y_{t+k-h}$. A common definition of $f(\Delta^h Y_{t+k})$ relies on an up, unchanged, or down classification (e.g. Q2A in the BER surveys): 
$$ f(\Delta^h Y_{t+k}) = \begin{cases} -1,& \text{if } \Delta^h Y_{t+k} < 0\\ 0,& \text{if } \Delta^h Y_{t+k} = 0\\ 1,& \text{if } \Delta^h Y_{t+k} > 0\\ \end{cases} $$

An alternative would be to use a binary classification in levels (e.g. Q1 in the BER survey): $$ f(Y_{t+k}) = \begin{cases} 0,& \text{if } Y_{t+k} < a\\ 1,& \text{if } Y_{t+k} \geq a\\ \end{cases}$$ where $a$ is determined by the preferences of the agent. In this case $a$ is the subjective benchmark or threshold that determines when conditions are 'satisfactory', and the measure of confidence simplifies to: $C _t^k = E_t f(Y_{t+k})$.

```{r figure1, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="The number of respondents by subsector (1993Q2-2017Q2)"}
#Weights
BERplot <- BER.B
BERplot$Sector[BERplot$sector %in% contractor_res] <- "Contractor (Residential)" 
BERplot$Sector[BERplot$sector %in% contractor_nonres] <- "Contractor (Non-Residential)" 
BERplot$Sector[BERplot$sector %in% subcon_res] <- "Sub-contractor (Residential)" 
BERplot$Sector[BERplot$sector %in% subcon_nonres] <- "Sub-contractor (Non-Residential)" 
BERplot$sectorw <- BERplot$factor/BERplot$weight

BERplot1 <- aggregate(BERplot$id, by=list(BERplot$surveyQ,BERplot$Sector), FUN = length)
BERplot1$Group.1 <- as.Date(as.yearqtr(BERplot1$Group.1, format = "%YQ%q"))
g <- ggplot(BERplot1, aes(x=Group.1, y=x,fill=Group.2))
g <- g + geom_bar(stat="identity")
g <- g + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g <- g + scale_fill_discrete(name="Subsector")
g <- g + scale_y_continuous(labels=comma)
g <- g + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g <- g + ylab("Number of Respondents")
g <- g + xlab("Date")
g
```

\begin{table}[]
\centering
\caption{Building sector codes}
\label{my-label}
\scalebox{0.8}{
\begin{tabular}{|l|l|}
\hline
\textbf{Sector}                  & \textbf{Code} \\ \hline
Contractors: Residential         & 5000          \\ \hline
Contractors: Non-Residential     & 5010          \\ \hline
Sub-Contractors: Residential     & 6000          \\ \hline
Sub-Contractors: Non-Residential & 6010          \\ \hline
\end{tabular}}
\end{table} 


We make a distinction between indicators of current conditions $C_t^k$ when $k=0$, and indicators of expected conditions $C_t^k$ when $k=1$. The BER business tendency surveys make this distinction possible by asking for separate responses relating to current and expected future conditions. 

The series are based on balance statistics, which present a single figure summarising the responses of all participants to a particular question. It is the cross-sectional mean of survey responses if the standard quantification system is used: 'better' is quantified by +1, 'the same' by 0, and 'poorer' by -1. The balances in period $t$ relating to current conditions $C_t^{0}$, and the balances in period $t$ relating to expected conditions $C_t^{1}$, may be defined as: 
$$C^{0}_t = \frac{1}{W_t} \sum^N_{i=1} w_{it} E_t f(\Delta^4 Y_{i,t })$$ 
$$C^{1}_t = \frac{1}{W_t} \sum^N_{i=1} w_{it} E_t f(\Delta^4 Y_{i,t+1}) ,$$ 
where $Y_{i,t+k}$ is a measure of real activity at time $t+k$ for firm $i = 1,...,N$; $\Delta^h Y_{i,t+k} = Y_{i,t+k} - Y_{i,t+k-h}$ for firm $i$; $w_{it}$ is the weight that each firm $i$ receives at time $t$; and $W_{t} = \sum^N_{i=1}w_i$ is the sum of the weights. 

###New Indicators
The Building survey responses do not receive weights (i.e. responses are weighted equally). The indicators (balances) for a number of groupings were calculated, as is illustrated below. A selection of the indicators are illustrated below, although balances have been calculated for all of the questions, and are included in the Excel files. Figure 2 illustrates the results for Q1 (confidence) in the three new subsector classifications. Figure 3 illustrates the balances for total construction in the Western Cape, KwaZulu-Natal and Gauteng.

```{r figure2, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Building results for Q1 (confidence) in the new categories"}
indicator_plot <- cbind(Building[,c("Datum","Q1")],Residential[,"Q1"],Non_residential[,"Q1"]) 
colnames(indicator_plot) <- c("Date","Building","Residential","Non-residential")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g <- g + geom_line()
g <- g + ylab("Indicator") + xlab("")
#g <- g + ggtitle("New Building Categories")
g <- g + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g <- g + theme(legend.title=element_blank()) 
g <- g + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g <- g + theme(legend.position="bottom")
g
```

```{r figure3, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Building results for Q1 (confidence) for the main provinces"}
indicator_plot <- cbind(WC.B[,c("Datum","Q1")],KZN.B[,"Q1"],GP.B[,"Q1"])
colnames(indicator_plot) <- c("Date","WC","KZN","GP")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g <- g + geom_line()
g <- g + ylab("Indicator") + xlab("")
g <- g + ggtitle("Q1: Provinces")
g <- g + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g <- g + theme(legend.title=element_blank()) 
g <- g + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g <- g + theme(legend.position="bottom")
g
```

###Latecomers
This section illustrates the impact of the inclusion of the latecomers on the indicators. The latecomers are not identified in the pre-2001 sample. We compare the post-2001 results, with and without latecomers included. The results illustrate that the inclusion of latecomers does not influence the results substantially, with only slight changes at the subsector level, which is consistent with [@Kershoff2015]. Figure 4 shows that the inclusion of a large number of latecomers (10% on average) had a small effect on the survey results. Although this is not entirely unexpected at the higher levels of aggregation, it is surprising that it also had almost no effect at high levels of disaggregation. This result supports the assumption that the distribution of missing responses corresponded with that of responding firms, i.e. the so-called missing-at-random (MAR) assumption holds [@EC2006]. We therefore decided to stick with the convention of excluding latecomers from all of the calculations going forward, which means that the BER does not need to revise the series when they are updated.

```{r late, echo=FALSE, results='hide', message=FALSE, warning=FALSE, cache = TRUE}
BER.B <- read.csv("Building_93Q2-17Q2.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
colnames(BER.B)[1:6] <- c("region","id","sector","weight","factor","surveyQ")
BER.B$surveyQ <- toupper(BER.B$surveyQ)
BER.B$sector <- factor(BER.B$sector) #could include labels
BER.B$id <- factor(BER.B$id)
BER.B$region <- factor(BER.B$region)

BER.B$temp <- NULL
for(i in 1:nrow(BER.B)) {
    ifelse(substr(BER.B$surveyQ[i], 1, 1)==9, 
           BER.B$temp[i] <- paste0("19",BER.B$surveyQ[i],sep=""),
           BER.B$temp[i] <- paste0("20",BER.B$surveyQ[i],sep=""))
}
BER.B$surveyQ <- BER.B$temp
BER.B <- BER.B[,-ncol(BER.B)]
BER.B$surveyQ <- factor(BER.B$surveyQ)

#==============================
BER.B <- BER.B[,!grepl("X",colnames(BER.B))]    

for(i in 7:16) {
    BER.B[,i] <- replace(BER.B[,i], BER.B[,i]==2, 0)
    BER.B[,i] <- replace(BER.B[,i], BER.B[,i]==3,-1)
}

for(i in 17:20) {
    BER.B[,i] <- replace(BER.B[,i], BER.B[,i]==1, 1)
    BER.B[,i] <- replace(BER.B[,i], BER.B[,i]==2, 0.5)
    BER.B[,i] <- replace(BER.B[,i], BER.B[,i]==3, 0)
}

BER.B <- BER.B[,1:20]

Building_l <- ongeweeg(BER.B,all_b,streke,6:102)

#Exclude Latecomers
BER.B <- BER.B[BER.B$Latecomer == FALSE | is.na(BER.B$Latecomer),]
```

```{r figure4, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Building results for Q1 (confidence) - including and excluding latecomers"}
indicator_plot <- cbind(Building[,c("Datum","Q1")],Building_l[,c("Q1")])
colnames(indicator_plot) <- c("Date","Total (excl. latecomers)","Total (incl. latecomers)")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Building: Q1") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Building[,c("Datum","Q2A")],Building_l[,c("Q2A")])
colnames(indicator_plot) <- c("Date","Total (excl. latecomers)","Total (incl. latecomers)")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("Building: Q2A") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(Building[,c("Datum","Q3A")],Building_l[,c("Q3A")])
colnames(indicator_plot) <- c("Date","Total (excl. latecomers)","Total (incl. latecomers)")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Building: Q3A") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))

indicator_plot <- cbind(Building[,c("Datum","Q8")],Building_l[,c("Q8")])
colnames(indicator_plot) <- c("Date","Total (excl. latecomers)","Total (incl. latecomers)")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Building: Q8") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

suppressMessages(library(gridExtra))
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

Since 2016Q2, the BER has included imputed values, in order to increase the number of responses and to decrease the volatility of the balances. An imputed value refers to a latecomer in period $t-1$, who had not responded in time in period $t$. For example, all the latecomers in 2017Q1, who had not responded in time in 2017Q2, were added to the 2017Q2 responses. If such a firm was also a latecomer in 2017Q2, the response may potentially be an imputed value in 2017Q3, if it is a latecomer again. The imputed values are reflected in the published results after 2016Q2, and are therefore included in the comparisons below. In future research we can evaluate the impact of this inclusion going back to 2001.

##Published Series
In order to check that the microdata and the calculations are correct, we compare the estimated indicators using the microdata to the BER's published series, where available (the "BERdata_Build.xlsx" file on Dropbox).[^4] Figure 5 and Figure 6 compare the series calculated with the microdata to the BER's published series. The results are very similar, albeit with a few small discrepancies. In addition, the microdata provides longer series for the questions on the constraints than the published series. The microdata therefore seems to be adequate for calculating the new balance statistics for all the questions, as well as for the updates. 

[^4]: The "published" series for the constraints (Q7-Q9) in the Excel file "BERdata_Build.xlsx" have a few strange values, but these are not published on Quantec. We decided to exclude these values.

```{r figure5, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Microdata results compared to the published results"}
indicator_plot <- cbind(Contractor[,c("Datum","Q1")],pub_b[,"con_totalQ1"])
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Q1: Contractors") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Contractor[,c("Datum","Q2A")],pub_b[,c("con_totalQ2A")])
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("Q2A: Contractors") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(Subcon[,c("Datum","Q1")],pub_b[,c("subcon_totalQ1")])
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Q1: Subcontractors") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))

indicator_plot <- cbind(Subcon[,c("Datum","Q8")],pub_b[,c("subcon_totalQ8")])
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Q8: Subcontractors") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

suppressMessages(library(gridExtra))
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)

```

```{r figure6, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Microdata results compared to the published results"}
indicator_plot <- cbind(Contractor_res[,c("Datum","Q3A")],pub_b[,"con_resQ3A"])
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Q3A: Contractors (Residential)") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Contractor_nonres[,c("Datum","Q4A")],pub_b[,c("con_nonresQ4A")])
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("Q4A: Contractors (Non-Residential)") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(Subcon_res[,c("Datum","Q5A")],pub_b[,c("subcon_resQ5A")])
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Q5A: Subcontractors (Residential)") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))

indicator_plot <- cbind(Subcon_nonres[,c("Datum","Q7")],pub_b[,c("subcon_nonresQ7")])
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Q6: Subcontractors (Non-Residential)") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

##Alternative Weights
The balances for the Building surveys are calculated without applying weights (i.e. an equal weighting procedure). The results are similar when the firm size weights are used. In order to be consistent throughout all the BER surveys, I would suggest that in future research we should create a weighted version of the Building indictors. We would need to calculate subsector size weights and the firm size weights should also be converted to four categories, as we have done with the other surveys. Once we have these weights we can apply the 2-step weighting procedure.

##Reference Series
In this section the series are assessed in terms of their tracking record, i.e. their correlations to their respective reference series. We compare the series graphically and calculated simple correlations with alternative potential reference series form official statistics. 

The question is which reference series should be used. The SA Reserve Bank (SARB) produces quarterly data on residential and non-residential fixed investment, while Stats SA produces monthly data on building plans passed and completed. These data all have their respective advantages and disadvantages. The SARB's data is the best match for the BER's survey, as it provides for the spread of activity over time (using an S-curve for adjustments). However, its disadvantage is that the recent data is revised extensively when more information becomes available and no provincial data is available. Stats SA published a series for building plans passed, which is a good leading indicator, but postponements and the stock of plans makes this data problematic as a reference series (or benchmark) for the BER's building survey. Building plans passed would not necessarily have a stable relationship with activity, as plans that are approved are not necessarily completed. Building plans completed are useful, bearing in mind that Stats SA only records the activity upon completion, while the BER's survey records the progress from start to completion. 

A comparison of the SARB and Stats SA data shows that they are closely correlated, even though Stats SA record activity only at the end of the period, while the SARB spreads it over the whole period of construction. The comparison also shows that the Stats SA data is more volatile, especially for non-residential activity. This is to be expected, given the lumpy nature of non-residential construction.

Stats SA publishes data for residential buildings, non-residential buildings, additions and alterations, and total activity. To make this data comparable to those of the SARB and the BER, additions and alterations were divided between residential and non-residential buildings. As a final step, other residential (e.g. hotels and casinos) and non-residential buildings (e.g. schools, sport clubs, churches and hospitals) were excluded to make the data even more comparable to the BER's, as such buildings may have a big impact on the growth rate in specific periods and the BER does not always cover them effectively. However, the "other" category has little impact on the series over longer time periods.

In this case we compare the series for general business conditions (Q2A) and total activity (Q3A) to the following reference series:

- YoY% change in the SARB's real residential & non-residential gross fixed capital formation (SARB GFCF)
- YoY% change in StatsSA's real building plans completed; 
- YoY% change in StatsSA's real building plans completed, excluding big hotels, casinos and alterations ("additions and alterations" do not require building plans).

###Residential Activity
Figure 7 illustrates the Residential series compared to the SARB and Stats SA references series. Table 3 reports that the correlations between the survey balances and the reference series are relatively high. This is confirmed by the cross-correlations illustrated in Figure 8. These show that the reference series with the highest correlations are Stats SA's building plans completed (excluding big hotels, casinos and alterations).

```{r figure7, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Residential results compared to the reference series"}
build <- cbind(Residential[,c("Datum","Q2A","Q3A")],ref_b[,c("GFCF.Residential","Residential.building","Res..excl..h.c.a.")])
colnames(build) <- c("Date","Q2A","Q3A","GFCF.Residential","Residential.building","Res Building (excl.hca)")

build[,2:6] <- scale(build[,2:6])
plot <- melt(build, id="Date")  # convert to long format
g <- ggplot(data=plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g <- g + geom_line()
g <- g + ylab("Indicator")+ xlab("")
g <- g + ggtitle("Residential")
g <- g + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g <- g + theme(legend.title=element_blank()) 
g <- g + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g <- g + theme(legend.position="bottom")
g
```

```{r table3, echo=FALSE, results='asis', warning=FALSE, message=FALSE, cache = TRUE}
source("corstarsl.R")
xt <- xtable(corstarsl(build[,-1])[3:5,1:2], caption="Residential series correlations")
print(xt, "latex",comment=FALSE, caption.placement = getOption("xtable.caption.placement", "top"),scalebox = 0.9)
```

```{r figure8, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Residential series cross-correlations"}
Q2A <- build[,2]
Q3A <- build[,3] 
GFCF <- build[,4]
Build.Plans <- build[,5]

par(mfrow=c(2,2))
ccf(Q2A, GFCF, na.action = na.pass, ylim=c(-0.2, 0.8), 
    ylab = "Correlation", xlab = "Number of Lags")
ccf(Q2A, Build.Plans, na.action = na.pass, ylim=c(-0.2, 0.8), 
    ylab = "Correlation", xlab = "Number of Lags")
ccf(Q3A, GFCF, na.action = na.pass, ylim=c(-0.2, 0.8), 
    ylab = "Correlation", xlab = "Number of Lags")
ccf(Q3A, Build.Plans, na.action = na.pass, ylim=c(-0.2, 0.8), 
    ylab = "Correlation", xlab = "Number of Lags")
```

###Non-Residential Activity
Figure 9 illustrates the Non-Residential series compared to the SARB and Stats SA references series. In this case the reference series are very volatile. Table 4 reports that the correlations between the survey balances and the reference series are relatively low, although the cross-correlations in Figure 10 show that the correlations are higher when the balances are lagged, i.e. the survey results have a leading relationship with the reference series. The highest correlations with the SARB series are when they lead by around 2 quarters and with the Stats SA series when they lead by around 4 quarters.

```{r figure9, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Non-residential results compared to the reference series"}
build <- cbind(Non_residential[,c("Datum","Q2A","Q3A")],ref_b[,c("GFCF.Non.residential","Non.residential.building",
                                                               "Non.res..excl..h.c.a.")])
colnames(build) <- c("Date","Q2A","Q3A","GFCF.Non-residential","Non.residential.building","Non-Res Building (excl.hca)")

build[,2:6] <- scale(build[,2:6])
plot <- melt(build, id="Date")  # convert to long format
g <- ggplot(data=plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g <- g + geom_line()
g <- g + ylab("Indicator")+ xlab("")
g <- g + ggtitle("Non-Residential")
g <- g + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g <- g + theme(legend.title=element_blank()) 
g <- g + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g <- g + theme(legend.position="bottom")
g
```

```{r table4, echo=FALSE, results='asis', warning=FALSE, message=FALSE, cache = TRUE}
xt <- xtable(corstarsl(build[,-1])[3:5,1:2], caption="Non-residential series correlations")
print(xt, "latex",comment=FALSE, caption.placement = getOption("xtable.caption.placement", "top"),scalebox = 0.9)
```

```{r figure10, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Non-residential series cross-correlations"}
Q2A <- build[,2]
Q3A <- build[,3] 
GFCF <- build[,4]
Build.Plans <- build[,5]

par(mfrow=c(2,2))
ccf(Q2A, GFCF, na.action = na.pass, ylim=c(-0.2, 0.6))
ccf(Q2A, Build.Plans, na.action = na.pass, ylim=c(-0.2, 0.6))
ccf(Q3A, GFCF, na.action = na.pass, ylim=c(-0.2, 0.6))
ccf(Q3A, Build.Plans, na.action = na.pass, ylim=c(-0.2, 0.6))
```

###Total Building Activity
Figure 11 illustrates the Total Building Activity series compared to the SARB and Stats SA references series. Table 5 reports that the contemporaneous correlations between the survey balances and the reference series are relatively high. The correlations of the survey balances with the residential plus non-residential GFCF series are much higher than the correlation with the total GFCF series. The high correlations are confirmed by the cross-correlations illustrated in Figure 12, which show again that the survey balances lead the Stats SA reference series (building plans completed) by a few quarters. 

```{r figure11, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Total results compared to the reference series"}
build <- cbind(Building[,c("Datum","Q2A","Q3A")],ref_b[,c("GFCF.Res_Non.res","GFCF.Total","Total.building","Total..excl..h.c.a.")])
colnames(build) <- c("Date","Q2A","Q3A","GFCF: Res & Non-res (SARB)", "GFCF: Total (SARB)", "Total building (StatsSA)","Total (excl.hca)")

build[,2:7] <- scale(build[,2:7])
plot <- melt(build, id="Date")  # convert to long format
g <- ggplot(data=plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g <- g + geom_line()
g <- g + ylab("Indicator")+ xlab("")
g <- g + ggtitle("Total Building")
g <- g + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g <- g + theme(legend.title=element_blank()) 
g <- g + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g <- g + theme(legend.position="bottom")
g
```

```{r table5, echo=FALSE, results='asis', warning=FALSE, message=FALSE, cache = TRUE}
xt <- xtable(corstarsl(build[,-1])[3:6,1:2], caption="Total series correlations")
print(xt, "latex",comment=FALSE, caption.placement = getOption("xtable.caption.placement", "top"),scalebox = 0.9)
```

```{r figure12, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Total series cross-correlations"}
Q2A <- build[,2]
Q3A <- build[,3] 
GFCF <- build[,4]
Build.Plans <- build[,6]

par(mfrow=c(2,2))
ccf(Q2A, GFCF, na.action = na.pass, ylim=c(-0.2, 0.8))
ccf(Q2A, Build.Plans, na.action = na.pass, ylim=c(-0.2, 0.8))
ccf(Q3A, GFCF, na.action = na.pass, ylim=c(-0.2, 0.8))
ccf(Q3A, Build.Plans, na.action = na.pass, ylim=c(-0.2, 0.8))
```

###Regional Activity
Figure 13 illustrates the Regional series compared to the Stats SA references series (the only one that is available). In this case the reference series are extremely volatile. Table 6 reports that the correlations between the survey balances and the reference series are relatively low due to this volatility, although they are marginally higher when the survey balance series are lagged, illustrated in Figure 14. 

```{r figure13, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Regional results compared to the reference series"}
build <- cbind(WC.B[,c("Datum","Q2A","Q3A")],KZN.B[,c("Q2A","Q3A")],GP.B[,c("Q2A","Q3A")],ref_b[,c("Building_WC","Building_KN","Building_GP")])
colnames(build) <- c("Date","WC.Q2A","WC.Q3A","KZN.Q2A","KZN.Q3A","GP.Q2A","GP.Q3A","Building_WC","Building_KZN","Building_GP")

#Published series
indicator_plot <- cbind(build[,c("Date","WC.Q2A","WC.Q3A","Building_WC")])
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Western Cape") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(build[,c("Date","KZN.Q2A","KZN.Q3A","Building_KZN")])
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("KZN") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(build[,c("Date","GP.Q2A","GP.Q3A","Building_GP")])
colnames(indicator_plot) <- c("Date","Q2A","Q3A","Building")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Gauteng") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))

library(gridExtra)
grid.arrange(g1, g2, g3, ncol=2, nrow =2)
```

```{r table6, echo=FALSE, results='asis', warning=FALSE, message=FALSE, cache = TRUE}
tafel <- cbind(corstarsl(build[,-1])[7,1:2],corstarsl(build[,-1])[8,3:4],
               corstarsl(build[,-1])[9,5:6])
row.names(tafel) <- "Building"
tafel <- t(tafel)
xt <- xtable(tafel, caption="Regional series correlations")
print(xt, "latex",comment=FALSE, caption.placement = getOption("xtable.caption.placement", "top"),scalebox = 0.9)
```

```{r figure14, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Regional series cross-correlations"}
WC.Q3A <- build[,3] 
WC.Build <- build[,8]
KZN.Q3A <- build[,5] 
KZN.Build <- build[,9]
GP.Q3A <- build[,7] 
GP.Build <- build[,10]

par(mfrow=c(2,2))
ccf(WC.Q3A, WC.Build, na.action = na.pass, ylim=c(-0.2, 0.4))
ccf(KZN.Q3A, KZN.Build, na.action = na.pass, ylim=c(-0.2, 0.4))
ccf(GP.Q3A, GP.Build, na.action = na.pass, ylim=c(-0.2, 0.6))
```

For simplicity, and because the disaggregated data are available by province, we decided to use the simple Stats SA building plans completed as reference series. This means that we do not make adjustments for big projects, such as hotels and casinos, or alterations, even though such an adjustment increases the tracking record of the series somewhat. The Stats SA series is also the one that is published by province, which simplifies the comparison and makes it consistent for all the series. For the remainder of the document, therefore, where possible we focus on the Stats SA reference series.

This section has demonstrated that the Building survey microdata are consistent with the published series. The survey balances seem to track the reference series relatively well. In future research we should calculate weighted versions of the Building balance series, in order to make all the calculations consistent.

##Architects, Quantity Surveyors and Civil Construction
The microdata for the surveys of architects, quantity surveyors and civil engineers is only available from 2001 (Argitekte_01Q2-17Q2.xlsx, Civils_01Q2-17Q2.xlsx and Quantity_01Q2-17Q2.xlsx). These series do not form part of the overall business confidence indicator. As with the Building survey, the responses do not receive weights (equal weighting procedure), even though firm size weights are available. Figure 15 compares the results from the microdata to the published series. They are very similar and the microdata seem to be correct. In future we should consider incorporating (weighted versions) of these three surveys into the Building sector results.

```{r figure15, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Architect, QS and Civil Engineer results compared to the published results"}
indicator_plot <- cbind(Architects[,c("Datum","Q1")],pub_a[,"Arc_Q1"])
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Q1: Architects") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Architects[,c("Datum","Q2A")],pub_a[,c("Arc_Q2A")])
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("Q2A: Architects") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(QSs[,c("Datum","Q4A")],pub_a[,c("QS_Q4A")])
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Q4A: QSs") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))

indicator_plot <- cbind(Civils[,c("Datum","Q6")],pub_a[,c("CE_Q6")])
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Q6: CEs") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

##Summary
After some corrections the microdata seems to provide series that correspond very closely to the published series. We have decided to exclude latecomers to make updating easier and avoid revisions, because they make a small difference anyway. We have calculated new series and compared them to the reference series. We chose the Stats SA series as reference series, as it is widely available for many of the subsamples and has a relatively high correlation with the balances. The final series are written to an Excel file. The updates can and should be fully automated.

\newpage
#The Manufacturing Survey
In this section we examine the Manufacturing sector surveys and results. We have used the Manufacturing survey microdata to update the results for the period 1992Q1-2017Q2. 

##Collating and Cleaning the Microdata
Similar to the Building Survey, in order to match the questions and responses in the different versions of the surveys, the surveys in the old records were compared to the current incarnations. We identified and marked the questions in the old (pre-2001) Manufacturing surveys and then matched them to the new survey questions. The old questionnaires have been uploaded to the Dropbox folder.

There were many clear mistakes in the sector and regions codes in the microdata, especially for the period 2000Q4-2001Q1. To correct the region codes we used the codes with the highest frequencies for each ID around that period (i.e. the mode for each individual respondent).

```{r read.man, echo=FALSE, results='hide', message=FALSE, warning=FALSE, cache = TRUE}
pub_m <- read.csv("Manufacturing_BER_Published.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
ref_m <- read.csv("Ref Series_Manufac.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
ref_me <- read.csv("Ref Series_Manufac_exp.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)

##=============================
#Correcting the old faktor variable 
BER.M <- read.csv("Manufacturing_current faktor.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
colnames(BER.M)[1:7] <- c("region","id","sector","weight","turnover","factor","surveyQ")
BER.M$surveyQ <- toupper(BER.M$surveyQ)
BER.M$sector <- factor(BER.M$sector) #could include labels
BER.M$id <- factor(BER.M$id)
BER.M$surveyQ <- factor(BER.M$surveyQ)

#Clean faktor
Mode <- function(x) {
    ux <- na.remove(unique(x))
    ux[which.max(tabulate(match(x, ux)))]
}
foute <- c("2000Q2","2000Q3","2000Q4","2001Q1")
korrek <- c("1999Q1","1999Q2","1999Q3","1999Q4",
            "2001Q2","2001Q3","2001Q4","2002Q1","2002Q2","2002Q3","2002Q4",
            "2003Q1","2003Q2","2003Q3","2003Q4")#,"2004Q1","2004Q2","2004Q3","2004Q4",
#"2005Q1","2005Q2","2005Q3","2006Q1","2006Q2","2006Q3","2006Q4")
for(i in levels(BER.M$id)) {
    if(!is.na(Mode(BER.M$factor[(BER.M$surveyQ %in% korrek) & (BER.M$id == i)]))) {
        BER.M$factor[(BER.M$surveyQ %in% foute) & (BER.M$id == i)] <- Mode(BER.M$factor[(BER.M$surveyQ %in% korrek) & (BER.M$id == i)]) 
    }
}
#BER.M <- read.csv("Manufacturing_corrected.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
#colnames(BER.M)[1:7] <- c("region","id","sector","weight","turnover","factor","surveyQ")
#BER.M$surveyQ <- toupper(BER.M$surveyQ)
#BER.M$sector <- factor(BER.M$sector) #could include labels
#BER.M$id <- factor(BER.M$id)
#BER.M$surveyQ <- factor(BER.M$surveyQ)

#Exlcude Latecomers and old questions
BER.M <- BER.M[BER.M$Latecomer == FALSE | is.na(BER.M$Latecomer),]
BER.M <- BER.M[,!grepl("X",colnames(BER.M))]    
BER.M <- BER.M[,1:64]
# replace 1,2,3 (Up, Same, Down) responses with 1,0,-1
for(i in 8:64) {
    BER.M[,i] <- replace(BER.M[,i], BER.M[,i]==2, 0)
    BER.M[,i] <- replace(BER.M[,i], BER.M[,i]==3,-1)
}

for(i in 43:49) {
    BER.M[,i] <- replace(BER.M[,i], BER.M[,i]==0, 0.5)
    BER.M[,i] <- replace(BER.M[,i], BER.M[,i]==-1, 0)
}

#-----------------------
#New faktor variable 
BER.Mn <- read.csv("Manufacturing_new faktor.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
colnames(BER.Mn)[1:7] <- c("region","id","sector","weight","turnover","factor","surveyQ")
BER.Mn$surveyQ <- toupper(BER.Mn$surveyQ)
BER.Mn$sector <- factor(BER.Mn$sector) #could include labels
BER.Mn$id <- factor(BER.Mn$id)

#Clean SurveyQ variable
BER.Mn$temp <- NULL
for(i in 1:nrow(BER.Mn)) {
    ifelse(substr(BER.Mn$surveyQ[i], 1, 1)==9, 
           BER.Mn$temp[i] <- paste0("19",BER.Mn$surveyQ[i],sep=""),
           BER.Mn$temp[i] <- paste0("20",BER.Mn$surveyQ[i],sep=""))
}
BER.Mn$surveyQ <- BER.Mn$temp
BER.Mn <- BER.Mn[,-ncol(BER.Mn)]
BER.Mn$surveyQ <- factor(BER.Mn$surveyQ)

#Exlcude Latecomers and old questions
BER.Mn <- BER.Mn[BER.Mn$Latecomer == FALSE | is.na(BER.Mn$Latecomer),]
BER.Mn <- BER.Mn[,!grepl("X",colnames(BER.Mn))]    
BER.Mn <- BER.Mn[,1:64]

# replace 1,2,3 (Up, Same, Down) responses with 1,0,-1
for(i in 8:64) {
    BER.Mn[,i] <- replace(BER.Mn[,i], BER.Mn[,i]==2, 0)
    BER.Mn[,i] <- replace(BER.Mn[,i], BER.Mn[,i]==3,-1)
}
for(i in 43:49) {
    BER.Mn[,i] <- replace(BER.Mn[,i], BER.Mn[,i]==0, 0.5)
    BER.Mn[,i] <- replace(BER.Mn[,i], BER.Mn[,i]==-1, 0)
}

#-----------------------
#New 2-step weighting 
BER.M2 <- read.csv("Manufacturing_new faktor_sep.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
colnames(BER.M2)[1:9] <- c("region","id","sector","weight","turnover","firmw","sectorw","factor","surveyQ")
BER.M2$surveyQ <- toupper(BER.M2$surveyQ)
BER.M2$sector <- factor(BER.M2$sector) #could include labels
BER.M2$id <- factor(BER.M2$id)
BER.M2$surveyQ <- factor(BER.M2$surveyQ)
BER.M2$factor <- as.numeric(as.character(BER.M2$factor))
#BER.M$factor <- BER.M$firmw * BER.M$sectorw

BER.M2 <- BER.M2[BER.M2$Latecomer == FALSE | is.na(BER.M2$Latecomer),]
BER.M2 <- BER.M2[,!grepl("X",colnames(BER.M2))]    
BER.M2 <- BER.M2[,1:66]

#Maak factor reg
Ej <- aggregate(BER.M2$firmw, by=list(BER.M2$surveyQ,BER.M2$sector), FUN=sum)
BER.M2 <-  merge(BER.M2, Ej, by.x=c("surveyQ","sector"), by.y=c("Group.1","Group.2"),all = TRUE)
BER.M2$factor <- BER.M2$factor/BER.M2$x
BER.M2 <- BER.M2[,c(3,4,2,5:9,1,10:66)]

for(i in 10:66) {
    BER.M2[,i] <- replace(BER.M2[,i], BER.M2[,i]==2, 0)
    BER.M2[,i] <- replace(BER.M2[,i], BER.M2[,i]==3,-1)
}
for(i in 45:51) {
    BER.M2[,i] <- replace(BER.M2[,i], BER.M2[,i]==0, 0.5)
    BER.M2[,i] <- replace(BER.M2[,i], BER.M2[,i]==-1, 0)
}


#-----------------------
#Exports: New faktor variable 
BER.Mne <- read.csv("Manufacturing_new faktor_exp.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)[,c(-6,-7)]
colnames(BER.Mne)[1:7] <- c("region","id","sector","weight","turnover","factor","surveyQ")
BER.Mne$surveyQ <- toupper(BER.Mne$surveyQ)
BER.Mne$sector <- factor(BER.Mne$sector) #could include labels
BER.Mne$id <- factor(BER.Mne$id)

#Clean SurveyQ variable
BER.Mne$temp <- NULL
for(i in 1:nrow(BER.Mne)) {
    ifelse(substr(BER.Mne$surveyQ[i], 1, 1)==9, 
           BER.Mne$temp[i] <- paste0("19",BER.Mne$surveyQ[i],sep=""),
           BER.Mne$temp[i] <- paste0("20",BER.Mne$surveyQ[i],sep=""))
}
BER.Mne$surveyQ <- BER.Mne$temp
BER.Mne <- BER.Mne[,-ncol(BER.Mne)]
BER.Mne$surveyQ <- factor(BER.Mne$surveyQ)

#Exlcude Latecomers and old questions
BER.Mne <- BER.Mne[BER.Mne$Latecomer == FALSE | is.na(BER.Mne$Latecomer),]
BER.Mne <- BER.Mne[,!grepl("X",colnames(BER.Mne))]    
BER.Mne <- BER.Mne[,1:64]

# replace 1,2,3 (Up, Same, Down) responses with 1,0,-1
for(i in 8:64) {
    BER.Mne[,i] <- replace(BER.Mne[,i], BER.Mne[,i]==2, 0)
    BER.Mne[,i] <- replace(BER.Mne[,i], BER.Mne[,i]==3,-1)
}
for(i in 43:49) {
    BER.Mne[,i] <- replace(BER.Mne[,i], BER.Mne[,i]==0, 0.5)
    BER.Mne[,i] <- replace(BER.Mne[,i], BER.Mne[,i]==-1, 0)
}

#-----------------------
#Exports: New 2-step weighting 
BER.M2e <- read.csv("Manufacturing_new faktor_exp.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
colnames(BER.M2e)[1:9] <- c("region","id","sector","weight","turnover","firmw","sectorw","factor","surveyQ")
BER.M2e$surveyQ <- toupper(BER.M2e$surveyQ)
BER.M2e$sector <- factor(BER.M2e$sector) #could include labels
BER.M2e$id <- factor(BER.M2e$id)
BER.M2e$temp <- NULL
for(i in 1:nrow(BER.M2e)) {
    ifelse(substr(BER.M2e$surveyQ[i], 1, 1)==9, 
           BER.M2e$temp[i] <- paste0("19",BER.M2e$surveyQ[i],sep=""),
           BER.M2e$temp[i] <- paste0("20",BER.M2e$surveyQ[i],sep=""))
}
BER.M2e$surveyQ <- BER.M2e$temp
BER.M2e <- BER.M2e[,-ncol(BER.M2e)]
BER.M2e$surveyQ <- factor(BER.M2e$surveyQ)
BER.M2e$factor <- as.numeric(as.character(BER.M2e$factor))
BER.M2e <- BER.M2e[BER.M2e$Latecomer == FALSE | is.na(BER.M2e$Latecomer),]
BER.M2e <- BER.M2e[,!grepl("X",colnames(BER.M2e))]    
BER.M2e <- BER.M2e[,1:66]

#Maak factor reg
Ej <- aggregate(BER.M2e$firmw, by=list(BER.M2e$surveyQ,BER.M2e$sector), FUN=sum)
BER.M2e <-  merge(BER.M2e, Ej, by.x=c("surveyQ","sector"), by.y=c("Group.1","Group.2"),all = TRUE)
BER.M2e$factor <- BER.M2e$factor/BER.M2e$x
BER.M2e <- BER.M2e[,c(3,4,2,5:9,1,10:66)]

for(i in 10:66) {
    BER.M2e[,i] <- replace(BER.M2e[,i], BER.M2e[,i]==2, 0)
    BER.M2e[,i] <- replace(BER.M2e[,i], BER.M2e[,i]==3,-1)
}
for(i in 45:51) {
    BER.M2e[,i] <- replace(BER.M2e[,i], BER.M2e[,i]==0, 0.5)
    BER.M2e[,i] <- replace(BER.M2e[,i], BER.M2e[,i]==-1, 0)
}
```

```{r M.man, echo=FALSE, results='hide', message=FALSE, warning=FALSE, cache = TRUE}
##======================##
## CALCULATE INDICATORS ##
##======================##
#MANUFACTURING
food <- c(1010, 1011,1013,1019,1020,1021)
textiles <- c(1120,1040,1049,1042,1060,1070)
wood <- c(1109,1110,1080,1081)
chemicals <- c(1130,1140,1149,1219)
glass <- c(1153,1159)
metals <- c(1160,1161,1170,1179,1181,1182,1189)
electrical <- c(1190,1191,1199,1192,1194)
transport.m <- c(1200,1201,1209)
furniture <- c(1090,1099)
all_m <- as.numeric(as.character(unique(BER.M$sector)))

consumer <- c(1010,1011,1019,1049,1060,1070,1090,1099,1110,1120,1149,1189,1192,1020,1021)
intermediate <- c(1013,1040,1042,1080,1081,1109,1130,1140,1153,1159,1160,1161,
                  1179,1191,1199,1219)
capital <- c(1170,1181,1182,1189,1190,1194,1200,1201,1209)
streke <- unique(BER.M$region)


ongeweeg <- function(data,sektor,streek,d) {
    data <- data[data$sector %in% sektor & data$region %in% streek,]
    sector <- aggregate(data[,(match("surveyQ",colnames(data))+1):ncol(data)], 
                        by=list(data$surveyQ), FUN=mean, na.rm=TRUE)
    sector$Obs <- aggregate(data$Q2A, by=list(data$surveyQ), FUN=length)[,2]
    sector <- merge(datums[d,],sector, by.x="Date", by.y="Group.1", all=TRUE)
    sector <- sector[,c(1:2,ncol(sector),3:(ncol(sector)-1))]
    sector[,-1:-3] <- na.approx(sector[,-1:-3]*100)
    return(sector)
}


geweeg <- function(data,sektor,streek,d) {
    weeg <- function(temp) {  #calculate weighted mean for each quarter for all columns
        temp <- cbind(factor=temp$factor,temp$factor*temp[(match("surveyQ",colnames(temp))+1):ncol(temp)])
        temp <- colSums(temp, na.rm=TRUE, dims = 1)/    #calculate the sum(wi*xi)/sum(wi)
            sapply(colnames(temp), function(x) sum(temp$factor[!is.na(temp[colnames(temp) == x])]))
        return(temp) #weight only by those that responded to a specific question
    }
    
    data <- data[data$sector %in% sektor & data$region %in% streek,]
    sector <- data.frame()
    for(kwartaal in levels(data$surveyQ)) {
        sector <- rbind(sector,weeg(data[data$surveyQ==kwartaal,]))
    }
    sector[,1] <- levels(data$surveyQ)
    colnames(sector) <- colnames(data)[(match("surveyQ",colnames(data))):ncol(data)]
    sector$Obs <- aggregate(data$Q2A, by=list(data$surveyQ), FUN=length)[,2]
    sector <- merge(datums[d,],sector, by.x="Date", by.y="surveyQ", all=TRUE)
    sector <- sector[,c(1:2,ncol(sector),3:(ncol(sector)-1))]
    sector[,-1:-3] <- na.approx(sector[,-1:-3]*100)
    return(sector)
}
#MANUFACTURING
Manufacturing <- geweeg(BER.M,all_m,streke,1:100)

Food <- geweeg(BER.M,food,streke,1:100)
Textiles <- geweeg(BER.M,textiles,streke,1:100)
Wood <- geweeg(BER.M,wood,streke,1:100)
Chemicals <- geweeg(BER.M,chemicals,streke,1:100)
Glass <- geweeg(BER.M,glass,streke,1:100)
Metals <- geweeg(BER.M,metals,streke,1:100)
Electrical <- geweeg(BER.M,electrical,streke,1:100)
Transport <- geweeg(BER.M,transport.m,streke,1:100)
Furniture <- geweeg(BER.M,furniture,streke,1:100)

Consumer <- geweeg(BER.M,consumer,streke,1:100)
Intermediate <- geweeg(BER.M,intermediate,streke,1:100)
Capital <- geweeg(BER.M,capital,streke,1:100)

WC.M <- geweeg(BER.M,all_m,1,1:100)
KZN.M <- geweeg(BER.M,all_m,5,1:100)
GP.M <- geweeg(BER.M,all_m,6,1:100)

#Interpolasie
Manufacturing[24,c(seq(4,32,by=2),34:49)] <- pub_m[24,2:32]
Manufacturing[33,c(seq(4,32,by=2),34:49)] <- pub_m[33,2:32]
Manufacturing[56,c(seq(4,32,by=2),34:49)] <- pub_m[56,2:32]

#-------------------
#Unweighted
Manufacturing_u <- ongeweeg(BER.M,all_m,streke,1:100)

Food_u <- ongeweeg(BER.M,food,streke,1:100)
Textiles_u <- ongeweeg(BER.M,textiles,streke,1:100)
Wood_u <- ongeweeg(BER.M,wood,streke,1:100)
Chemicals_u <- ongeweeg(BER.M,chemicals,streke,1:100)
Glass_u <- ongeweeg(BER.M,glass,streke,1:100)
Metals_u <- ongeweeg(BER.M,metals,streke,1:100)
Electrical_u <- ongeweeg(BER.M,electrical,streke,1:100)
Transport_u <- ongeweeg(BER.M,transport.m,streke,1:100)
Furniture_u <- ongeweeg(BER.M,furniture,streke,1:100)

Consumer_u <- ongeweeg(BER.M,consumer,streke,1:100)
Intermediate_u <- ongeweeg(BER.M,intermediate,streke,1:100)
Capital_u <- ongeweeg(BER.M,capital,streke,1:100)

WC.M_u <- ongeweeg(BER.M,all_m,1,1:100)
KZN.M_u <- ongeweeg(BER.M,all_m,5,1:100)
GP.M_u <- ongeweeg(BER.M,all_m,6,1:100)

Manufacturing_u[24,c(seq(4,32,by=2),34:49)] <- pub_m[24,2:32]
Manufacturing_u[33,c(seq(4,32,by=2),34:49)] <- pub_m[33,2:32]
Manufacturing_u[56,c(seq(4,32,by=2),34:49)] <- pub_m[56,2:32]

#------------------
#New faktor
Manufacturing_n <- geweeg(BER.Mn,all_m,streke,1:100)

Food_n <- geweeg(BER.Mn,food,streke,1:100)
Textiles_n <- geweeg(BER.Mn,textiles,streke,1:100)
Wood_n <- geweeg(BER.Mn,wood,streke,1:100)
Chemicals_n <- geweeg(BER.Mn,chemicals,streke,1:100)
Glass_n <- geweeg(BER.Mn,glass,streke,1:100)
Metals_n <- geweeg(BER.Mn,metals,streke,1:100)
Electrical_n <- geweeg(BER.Mn,electrical,streke,1:100)
Transport_n <- geweeg(BER.Mn,transport.m,streke,1:100)
Furniture_n <- geweeg(BER.Mn,furniture,streke,1:100)

Consumer_n <- geweeg(BER.Mn,consumer,streke,1:100)
Intermediate_n <- geweeg(BER.Mn,intermediate,streke,1:100)
Capital_n <- geweeg(BER.Mn,capital,streke,1:100)

WC.M_n <- geweeg(BER.Mn,all_m,1,1:100)
KZN.M_n <- geweeg(BER.Mn,all_m,5,1:100)
GP.M_n <- geweeg(BER.Mn,all_m,6,1:100)

Manufacturing_n[24,c(seq(4,32,by=2),34:49)] <- pub_m[24,2:32]
Manufacturing_n[33,c(seq(4,32,by=2),34:49)] <- pub_m[33,2:32]
Manufacturing_n[56,c(seq(4,32,by=2),34:49)] <- pub_m[56,2:32]

#-------------------
#Two-step
BER.M2 <- BER.M2[,-6:-7]
Manufacturing_2 <- geweeg(BER.M2,all_m,streke,1:100)

Food_2 <- geweeg(BER.M2,food,streke,1:100)
Textiles_2 <- geweeg(BER.M2,textiles,streke,1:100)
Wood_2 <- geweeg(BER.M2,wood,streke,1:100)
Chemicals_2 <- geweeg(BER.M2,chemicals,streke,1:100)
Glass_2 <- geweeg(BER.M2,glass,streke,1:100)
Metals_2 <- geweeg(BER.M2,metals,streke,1:100)
Electrical_2 <- geweeg(BER.M2,electrical,streke,1:100)
Transport_2 <- geweeg(BER.M2,transport.m,streke,1:100)
Furniture_2 <- geweeg(BER.M2,furniture,streke,1:100)

Consumer_2 <- geweeg(BER.M2,consumer,streke,1:100)
Intermediate_2 <- geweeg(BER.M2,intermediate,streke,1:100)
Capital_2 <- geweeg(BER.M2,capital,streke,1:100)

WC.M_2 <- geweeg(BER.M2,all_m,1,1:100)
KZN.M_2 <- geweeg(BER.M2,all_m,5,1:100)
GP.M_2 <- geweeg(BER.M2,all_m,6,1:100)

Manufacturing_2[24,c(seq(4,32,by=2),34:49)] <- pub_m[24,2:32]
Manufacturing_2[33,c(seq(4,32,by=2),34:49)] <- pub_m[33,2:32]
Manufacturing_2[56,c(seq(4,32,by=2),34:49)] <- pub_m[56,2:32]

#-------------
#Exports
#New faktor
Manufacturing_ne <- geweeg(BER.Mne,all_m,streke,1:100)

Food_ne <- geweeg(BER.Mne,food,streke,1:100)
Textiles_ne <- geweeg(BER.Mne,textiles,streke,1:100)
Wood_ne <- geweeg(BER.Mne,wood,streke,1:100)
Chemicals_ne <- geweeg(BER.Mne,chemicals,streke,1:100)
Glass_ne <- geweeg(BER.Mne,glass,streke,1:100)
Metals_ne <- geweeg(BER.Mne,metals,streke,1:100)
Electrical_ne <- geweeg(BER.Mne,electrical,streke,1:100)
Transport_ne <- geweeg(BER.Mne,transport.m,streke,1:100)
Furniture_ne <- geweeg(BER.Mne,furniture,streke,1:100)

#-------------------
#Two-step
#Manufacturing_n2e <- maak.index(all_m)[1:100,]
BER.M2e <- BER.M2e[,-6:-7]
Manufacturing_2e <- geweeg(BER.M2e,all_m,streke,1:100)
Food_2e <- geweeg(BER.M2e,food,streke,1:100)
Textiles_2e <- geweeg(BER.M2e,textiles,streke,1:100)
Wood_2e <- geweeg(BER.M2e,wood,streke,1:100)
Chemicals_2e <- geweeg(BER.M2e,chemicals,streke,1:100)
Glass_2e <- geweeg(BER.M2e,glass,streke,1:100)
Metals_2e <- geweeg(BER.M2e,metals,streke,1:100)
Electrical_2e <- geweeg(BER.M2e,electrical,streke,1:100)
Transport_2e <- geweeg(BER.M2e,transport.m,streke,1:100)
Furniture_2e <- geweeg(BER.M2e,furniture,streke,1:100)
```

Table 7 reports some characteristics of the Manufacturing survey microdata. The Manufacturing microdata are missing for the following quarters: 1997Q4, 2000Q1 and 2005Q4. Where published series were available, we used the published values for those missing values. Where they were unavailable, we used simple linear interpolation to create complete continuous series. There is very little difference between the substitution of the published values and simple linear interpolation.

```{r table7, echo=FALSE, results='asis', warning=FALSE, message=FALSE, cache = TRUE}
ave <- mean(aggregate(BER.M$id, by=list(BER.M$surveyQ), FUN = length)[,2])
tafel <- cbind("1992Q1-2017Q2",length(BER.M$id),round(ave,2),
               "1997Q4,2000Q1,2005Q4")
colnames(tafel) <- c("Sample","Total Obs","Obs/Quarter","Missing Quarters")     
row.names(tafel) <- "Manufacturing Survey"
xt <- xtable(tafel, caption="Sample characteristics")
print(xt, "latex",comment=FALSE, caption.placement = getOption("xtable.caption.placement", "top"), scalebox = 0.8,
      include.rownames=TRUE)
```

Table 8 reports the new subsector codes that are used to calculate balances. The aggregation is increased by decreasing the number of subsectors from 21 (22 including petroleum) to 10. Figure 16 illustrates the number of respondents by subsector, according to the new sector classifications. In addition, three new overarching subsector series are calculated for consumer, intermediate and capital goods, reported in Table 9. Many of the original sector codes were not included in the new sector classifications and these were reclassified to correspond to the new sector code classifications. 

\begin{table}[]
\centering
\caption{Manufacturing subsector weights}
\label{my-label}
\scalebox{0.9}{
\begin{tabular}{|l|l|l|}
\hline
\textbf{New BER classification}                                                                             & \textbf{Old BER classification}        & \textbf{Sectors}       \\ \hline
\multirow{2}{*}{Food \& beverages}                                                                          & Food                                   & 1010, 1011, 1013, 1019 \\ \cline{2-3} 
                                                                                                            & Beverages                              & 1020, 1021             \\ \hline
\multirow{4}{*}{\begin{tabular}[c]{@{}l@{}}Textiles, clothing, \\ leather \& footwear\end{tabular}}         & Leather                                & 1120                   \\ \cline{2-3} 
                                                                                                            & Textiles                               & 1040, 1049             \\ \cline{2-3} 
                                                                                                            & Clothing                               & 1042, 1060             \\ \cline{2-3} 
                                                                                                            & Footwear                               & 1070                   \\ \hline
\multirow{3}{*}{\begin{tabular}[c]{@{}l@{}}Wood, paper, \\ printing and publishing\end{tabular}}            & Paper \& prod                          & 1109                   \\ \cline{2-3} 
                                                                                                            & Print \& publishing                    & 1110                   \\ \cline{2-3} 
                                                                                                            & Wood                                   & 1080, 1081             \\ \hline
\multirow{4}{*}{\begin{tabular}[c]{@{}l@{}}Petroleum, chemical \\ products, rubber \& plastic\end{tabular}} & Rubber                                 & 1130                   \\ \cline{2-3} 
                                                                                                            & Chemicals                              & 1140, 1149             \\ \cline{2-3} 
                                                                                                            & Plastics                               & 1219                   \\ \cline{2-3} 
                                                                                                            & Petroleum                              & Missing (1220)         \\ \hline
\begin{tabular}[c]{@{}l@{}}Glass and non-metallic \\ mineral products\end{tabular}                          & Non-metal minerals                     & 1153, 1159             \\ \hline
\multirow{3}{*}{\begin{tabular}[c]{@{}l@{}}Basic metal, metal \\ products and machinery\end{tabular}}       & Basic metals                           & 1160, 1161             \\ \cline{2-3} 
                                                                                                            & Metal products                         & 1170, 1179             \\ \cline{2-3} 
                                                                                                            & Machinery (excl. electrical machinery) & 1181, 1182, 1189       \\ \hline
Electrical machinery                                                                                        & \multirow{2}{*}{Electrical machinery}  & 1190, 1191, 1199       \\ \cline{1-1} \cline{3-3} 
\begin{tabular}[c]{@{}l@{}}Radio, TV and \\ professional equipment\end{tabular}                             &                                        & 1192, 1194             \\ \hline
\begin{tabular}[c]{@{}l@{}}Motor vehicles, parts and \\ accessories \& transport \\ equipment\end{tabular}  & Transport equipment                    & 1200, 1201, 1209       \\ \hline
\begin{tabular}[c]{@{}l@{}}Furniture and other, \\ incl. tobacco\end{tabular}                               & Furniture                              & 1090, 1099             \\ \hline
\end{tabular}}
\end{table}

```{r figure16, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="The number of respondents in the manufacturing sector by subsector (1992Q1-2017Q2)"}
BERplot <- BER.M
BERplot$Sector[BERplot$sector %in% food] <- "Food" 
BERplot$Sector[BERplot$sector %in% textiles] <- "Textiles" 
BERplot$Sector[BERplot$sector %in% wood] <- "Wood" 
BERplot$Sector[BERplot$sector %in% chemicals] <- "Chemicals" 
BERplot$Sector[BERplot$sector %in% glass] <- "Glass" 
BERplot$Sector[BERplot$sector %in% metals] <- "Metals" 
BERplot$Sector[BERplot$sector %in% electrical] <- "Eelectrical" 
BERplot$Sector[BERplot$sector %in% transport.m] <- "Transport" 
BERplot$Sector[BERplot$sector %in% furniture] <- "Furniture" 
BERplot$sectorw <- BERplot$factor/BERplot$weight

BERplot1 <- aggregate(BERplot$id, by=list(BERplot$surveyQ,BERplot$Sector), FUN = length)
BERplot1$Group.1 <- as.Date(as.yearqtr(BERplot1$Group.1, format = "%YQ%q"))
g <- ggplot(BERplot1, aes(x=Group.1, y=x,fill=Group.2))
g <- g + geom_bar(stat="identity")
g <- g + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g <- g + scale_fill_discrete(name="Subsector")
g <- g + scale_y_continuous(labels=comma)
g <- g + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g <- g + ylab("Number of Respondents")
g <- g + xlab("Date")
g
```

\begin{table}[]
\centering
\caption{Main industrial groupings}
\label{my-label}
\scalebox{0.9}{
\begin{tabular}{|l|l|l|}
\hline
\textbf{Main Industrial Group}       & \textbf{BER code} & \textbf{Description}                                \\ \hline
\multirow{14}{*}{Consumer Goods}     & 1010              & Meat, fish, fruit, vegetables, oils                 \\ \cline{2-3} 
                                     & 1011              & Dairy products                                      \\ \cline{2-3} 
                                     & 1019              & Other food                                          \\ \cline{2-3} 
                                     & 1049              & Other textiles                                      \\ \cline{2-3} 
                                     & 1060              & Wearing apparel \& articles of fur                  \\ \cline{2-3} 
                                     & 1070              & Footwear                                            \\ \cline{2-3} 
                                     & 1090              & Furniture                                           \\ \cline{2-3} 
                                     & 1099              & Other (incl. tobacco)                               \\ \cline{2-3} 
                                     & 1110              & Printing \& reproduction of recorded media          \\ \cline{2-3} 
                                     & 1120              & Leather \& leather products                         \\ \cline{2-3} 
                                     & 1149              & Other chemical products                             \\ \cline{2-3} 
                                     & 1189              & Domestic appliances                                 \\ \cline{2-3} 
                                     & 1192              & Radio, TV \& communication apparatus                \\ \cline{2-3} 
                                     & 1020, 1021        & Beverages                                           \\ \hline
\multirow{16}{*}{Intermediate Goods} & 1013              & Grain mill products                                 \\ \cline{2-3} 
                                     & 1040              & Spinning, weaving, yarns                            \\ \cline{2-3} 
                                     & 1042              & Knitted \& crocheted articles                       \\ \cline{2-3} 
                                     & 1080              & Wood \& wood products                               \\ \cline{2-3} 
                                     & 1081              & Sawmilling                                          \\ \cline{2-3} 
                                     & 1109              & Paper \& paper products                             \\ \cline{2-3} 
                                     & 1130              & Rubber                                              \\ \cline{2-3} 
                                     & 1140              & Chemical products                                   \\ \cline{2-3} 
                                     & 1153              & Glass                                               \\ \cline{2-3} 
                                     & 1159              & Other non-metallic mineral products                 \\ \cline{2-3} 
                                     & 1160              & Basic iron \& steel \& castings thereof             \\ \cline{2-3} 
                                     & 1161              & Basic precious \& non-ferrous metal products        \\ \cline{2-3} 
                                     & 1179              & Other fabricated metal products                     \\ \cline{2-3} 
                                     & 1191              & Electricity distribution apparatus                  \\ \cline{2-3} 
                                     & 1199              & Batteries                                           \\ \cline{2-3} 
                                     & 1219              & Plastic                                             \\ \hline
\multirow{9}{*}{Capital Goods}       & 1170              & Structural metal products                           \\ \cline{2-3} 
                                     & 1181              & Special purpose machinery                           \\ \cline{2-3} 
                                     & 1182              & General purpose machinery                           \\ \cline{2-3} 
                                     & 1189              & Office machinery, computers                         \\ \cline{2-3} 
                                     & 1190              & Electrical motors, generators, transformers         \\ \cline{2-3} 
                                     & 1194              & Medical appliances, photographic equipment, watches \\ \cline{2-3} 
                                     & 1200              & Motor cars                                          \\ \cline{2-3} 
                                     & 1201              & Parts \& accessories for motor vehicles             \\ \cline{2-3} 
                                     & 1209              & Other transport equipment                           \\ \hline
\end{tabular}}
\end{table}

##The Manufacturing Sector Indicators
As discussed above, the balances are calculated as: 
$$C^{0}_t = \frac{1}{W_t} \sum^N_{i=1} w_{it} E_t f(\Delta^4 Y_{i,t })$$ 
$$C^{1}_t = \frac{1}{W_t} \sum^N_{i=1} w_{it} E_t f(\Delta^4 Y_{i,t+1}) ,$$ 
where $Y_{i,t+k}$ is again a measure of real activity at time $t+k$ for firm $i = 1,...,N$; $\Delta^h Y_{i,t+k} = Y_{i,t+k} - Y_{i,t+k-h}$ for firm $i$; $w_{it}$ is the weight that each firm $i$ receives at time $t$; and $W_{t} = \sum^N_{i=1}w_i$ is the sum of the weights. 

For the Manufacturing survey we have created four versions of the indicators - i.e. the balance statistics for all of the questions. These balances only differ in their weighting procedure, as follows:

The baseline balance statistics for all of the questions in the Manufacturing sector are calculated in the same way as the normal BER procedure. The weights are calculated as: $w_{it} = f_{it} s_{jt} ,$ where $f_{it}$ the firm size weight (i.e. the inner weight reflecting turnover or number of employees) for firm $i$ at time $t$; and $s_{jt}$ is the subsector weight (i.e. the outer weight reflecting the share of total value added) for subsector $j$ at time $t$. The firm size weights are divided into nine categories, based on the size of the workforce, and each corresponds to an exponentially increasing weight (from 1 to 700). The subsector size weights are updated periodically by the BER, based on the turnover or the number of employees in each subsector. These series are then compared to the BER's published series to ensure that the microdata is correct.

The second set of indicators are based on unweighted means, i.e. the responses are weighted equally. The third set of indicators is based on a new 4-part firm classification, which are less exponential than the previous weights. The four firm size weight categories are based on Stats SA's and the DTI's categories and thresholds of micro, small, medium and large enterprises and the classification is based on turnover rather than the size of the workforce. The idea is to see if the weighting procedure imparts unnecessary increased volatility into the series. 

The final set of indicators is based on a 2-step weighting procedure, recommended by the OECD and the UN Handbooks [@OECD2003; @UN2015]. In this version the weights are calculated as: $w_{it} = f_{it} s_{jt} / F_{jt} ,$ where $f_{it}$ the firm size weight (i.e. the new 4-part classification) for firm $i$ at time $t$; $s_{jt}$ is the subsector weight for subsector $j$ at time $t$; and $F_{jt} = \sum^N_{i=1} f_{it}$ is the total firm weight for subsector $j$ at time $t$. In other words, the only difference is that we divide by $F_{jt}$. These weights are equivalent to an explicit 2-step weighting procedure, whereby weighted means are calculated for each subsector separately (using firm size weights), and then aggregated with the subsector weightings [@UN2015]. 

###Published Series
The first step is to check that the series calculated with the microdata corresponds to the BER's published series. Figure 17 compares the microdata series to the published series for a number of questions. In some cases, the microdata provides longer series than the published series. Figure 18 compares the microdata series to the published series, specially relating to the questions on constraints. The microdata series are slightly higher than the published results (although the correlations are nearly unity), implying that some adjustment factors were added to the published results at some stage in the past. Although there are still a few small discrepancies, the microdata appears to broadly correspond to the published series, which implies that the microdata can be used in calculating the other sets of variables.

```{r figure17, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Manufacturing microdata results compared to the published results"}
indicator_plot <- cbind(Manufacturing[,c("Datum","Q1A")],pub_m[,c("Total_Q1A")])
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Q1A") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Manufacturing[,c("Datum","Q2A")],pub_m[,c("Total_Q2A")])
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("Q2A") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(Manufacturing[,c("Datum","Q3A")],pub_m[,c("Total_Q3A")])
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Q3A") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))

indicator_plot <- cbind(Manufacturing[,c("Datum","Q6A")],pub_m[,c("Total_Q6A")])
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Q6A") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)

```

```{r figure18, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Manufacturing microdata results compared to the published results for contraints"}
indicator_plot <- cbind(Manufacturing[,c("Datum","Q21")],pub_m[,c("Total_Q21")])
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Q21") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Manufacturing[,c("Datum","Q22")],pub_m[,c("Total_Q22")])
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("Q22") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(Manufacturing[,c("Datum","Q25")],pub_m[,c("Total_Q25")])
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Q25") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))

indicator_plot <- cbind(Manufacturing[,c("Datum","Q27")],pub_m[,c("Total_Q27")])
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Q27") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

###New Indicators
Figure 19 illustrates the results for Total Manufacturing for a selection of questions, comparing the three main weighting procedures. Figure 20 and Figure 21 compares the results for a selection of the new subsector classifications, using the three weighting procedures. Figure 22 presents the Total Manufacturing results for the three largest provinces, using the three main weighting procedures.

In general the series calculated with the new firm size weights are less volatile than the old series. The two-step procedure produces results that are very similar to those using the old weighting procedure with the new weights. The unweighted series are very similar to these series and generally exhibit the lowest volatility.

```{r figure19, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Total Manufacturing results for the alternative weighting procedures"}
indicator_plot <- cbind(Manufacturing[,c("Datum","Q1A")],
                        Manufacturing_n[,c("Q1A")],Manufacturing_2[,c("Q1A")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Q1A") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Manufacturing[,c("Datum","Q2A")],
                        Manufacturing_n[,c("Q2A")],Manufacturing_2[,c("Q2A")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("Q2A") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(Manufacturing[,c("Datum","Q3A")],
                        Manufacturing_n[,c("Q3A")],Manufacturing_2[,c("Q3A")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Q3A") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom")

indicator_plot <- cbind(Manufacturing[,c("Datum","Q20")],
                        Manufacturing_n[,c("Q20")],Manufacturing_2[,c("Q20")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Q20") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom")
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid_arrange_shared_legend <- function(...) {
    plots <- list(...)
    g <- ggplotGrob(plots[[1]] + theme(legend.position="bottom"))$grobs
    legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]
    lheight <- sum(legend$height)
    grid.arrange(
        do.call(arrangeGrob, lapply(plots, function(x)
            x + theme(legend.position="none"))),
        legend,
        ncol = 1,
        heights = unit.c(unit(1, "npc") - lheight, lheight))
}

grid_arrange_shared_legend(g1, g2, g3, g4, ncol=2, nrow =2)
```

```{r figure20, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Manufacturing subsector results for the alternative weighting procedures"}
indicator_plot <- cbind(Food[,c("Datum","Q20")],
                        Food_n[,c("Q20")],Food_2[,c("Q20")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Food") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Textiles[,c("Datum","Q20")],
                        Textiles_n[,c("Q20")],Textiles_2[,c("Q20")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("Textiles") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(Wood[,c("Datum","Q20")],
                        Wood_n[,c("Q20")],Wood_2[,c("Q20")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Wood") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom")

indicator_plot <- cbind(Chemicals[,c("Datum","Q20")],
                        Chemicals_n[,c("Q20")],Chemicals_2[,c("Q20")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Chemicals") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom")
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid_arrange_shared_legend <- function(...) {
    plots <- list(...)
    g <- ggplotGrob(plots[[1]] + theme(legend.position="bottom"))$grobs
    legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]
    lheight <- sum(legend$height)
    grid.arrange(
        do.call(arrangeGrob, lapply(plots, function(x)
            x + theme(legend.position="none"))),
        legend,
        ncol = 1,
        heights = unit.c(unit(1, "npc") - lheight, lheight))
}

grid_arrange_shared_legend(g1, g2, g3, g4, ncol=2, nrow =2)
```

```{r figure21, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Manufacturing subsector results for the alternative weighting procedures"}
#New Sector Classifications
indicator_plot <- cbind(Metals[,c("Datum","Q20")],
                        Metals_n[,c("Q20")],Metals_2[,c("Q20")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Metals") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Consumer[,c("Datum","Q20")],
                        Consumer_n[,c("Q20")],Consumer_2[,c("Q20")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("Consumer Goods") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(Intermediate[,c("Datum","Q20")],
                        Intermediate_n[,c("Q20")],Intermediate_2[,c("Q20")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Intermediate Goods") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))

indicator_plot <- cbind(Capital[,c("Datum","Q20")],
                        Capital_n[,c("Q20")],Capital_2[,c("Q20")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Capital Goods") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid_arrange_shared_legend <- function(...) {
    plots <- list(...)
    g <- ggplotGrob(plots[[1]] + theme(legend.position="bottom"))$grobs
    legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]
    lheight <- sum(legend$height)
    grid.arrange(
        do.call(arrangeGrob, lapply(plots, function(x)
            x + theme(legend.position="none"))),
        legend,
        ncol = 1,
        heights = unit.c(unit(1, "npc") - lheight, lheight))
}

grid_arrange_shared_legend(g1, g2, g3, g4, ncol=2, nrow =2)
```

```{r figure22, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Manufacturing regional results for the alternative weighting procedures"}
indicator_plot <- cbind(WC.M[,c("Datum","Q20")],
                        WC.M_n[,c("Q20")],WC.M_2[,c("Q20")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("WC") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(KZN.M[,c("Datum","Q20")],
                        KZN.M_n[,c("Q20")],KZN.M_2[,c("Q20")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("KZN") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(GP.M[,c("Datum","Q20")],
                        GP.M_n[,c("Q20")],GP.M_2[,c("Q20")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("GP") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))

indicator_plot <- cbind(WC.M[,c("Datum","Q20")],KZN.M[,c("Q20")],GP.M[,c("Q20")])
colnames(indicator_plot) <- c("Date","WC","KZN","GP") 
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Regions") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

###Exports
We have also calculated new weights specifically for the survey responses relating to the questions on exports (Q2A, Q2P, Q5A and Q5P). Figure 23 compares the balance series for one of these questions, using the old weights in the microdata, and the two new weighting procedures. The results are quite similar, although the new weights produce less volatile series.

```{r figure23, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Manufacturing export results for the alternative weighting procedures"}
indicator_plot <- cbind(Manufacturing[,c("Datum","Q2A")],
                        Manufacturing_ne[,c("Q2A")],Manufacturing_2e[,c("Q2A")])
colnames(indicator_plot) <- c("Date","Microdata","Exp Weight","Exp Weight: 2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g <- g + geom_line()
g <- g + ylab("Indicator") + xlab("")
g <- g + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g <- g + theme(legend.title=element_blank()) 
g <- g + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g <- g + theme(legend.position="bottom")
g
```

##Reference Series
In this section the series are assessed in terms of their tracking record, i.e. their correlations to their respective reference series. The SARB has two series available for total manufacturing production, based on sales values and volumes. Stats SA also publishes a series for total manufacturing volume. At the subsector level, only the Stats SA series for manufacturing production volumes are available. 

###Total Manufacturing Activity
Figure 24 illustrates the Total Manufacturing Activity series compared to the SARB and Stats SA references series. Table 10 reports that the contemporaneous correlations between the survey balances and the reference series are relatively high, which is confirmed by the cross-correlations (not shown). 

```{r figure24, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Total Manufacturing compared to the reference series"}
#Reference series
indicator_plot <- cbind(Manufacturing[,c("Datum","Q3A")],Manufacturing_2[,c("Q3A")],
                        ref_m[,c("RTotal_Sales.sa","Total_Vol.sa","Total.sa")])
colnames(indicator_plot) <- c("Date","Q3A:Micro","Q3A:2-step","SARB:Sales","SARB:Volume","StatsSA:Volume")
indicator_plot[,-1] <- scale(indicator_plot[,-1])
plot <- melt(indicator_plot, id="Date")  # convert to long format
g <- ggplot(data=plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g <- g + geom_line()
g <- g + ylab("Indicator") + xlab("")
g <- g + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g <- g + theme(legend.title=element_blank()) 
g <- g + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g <- g + theme(legend.position="bottom")
g
```

```{r table10, eval=FALSE, echo=FALSE, results='asis', warning=FALSE, message=FALSE, cache = TRUE}
source("corstarsl.R")
Manu <- cbind(Manufacturing[,c("Q1A","Q3A")],Manufacturing_u[,c("Q1A","Q3A")],
              Manufacturing_n[,c("Q1A","Q3A")],Manufacturing_2[,c("Q1A","Q3A")],
              ref_m[,c("RTotal_Sales.sa","Total_Vol.sa","Total.sa")])
colnames(Manu) <- c("Q1A","Q3A","Q1A_u","Q3A_u","Q1A_new","Q3A_new","Q1A_2s","Q3A_2s","SARB:Sales","SARB:Volume","StatsSA:Volume")

xt <- xtable(corstarsl(Manu)[9:11,1:8], caption="Total manufacturing correlations")
print(xt, "latex",comment=FALSE,scalebox = 0.9, caption.placement = getOption("xtable.caption.placement", "top"), include.rownames=TRUE)
```

\begin{table}[ht]
\centering
\caption{Correlations between total manufacturing and reference series}
\scalebox{0.8}{
\begin{tabular}{|l|llll|llll|}
  \hline
 & Q1A & Q1A\_u & Q1A\_new & Q1A\_2s & Q3A & Q3A\_u & Q3A\_new & Q3A\_2s \\ 
  \hline
SARB:Sales &  0.62*** &  0.57*** &  0.58*** &  0.59*** &  0.65*** &  0.60*** &  0.61*** &  0.64*** \\ 
  SARB:Volume &  0.72*** &  0.69*** &  0.71*** &  0.70*** &  0.74*** &  0.71*** &  0.72*** &  0.73*** \\ 
  StatsSA:Volume &  0.74*** &  0.70*** &  0.72*** &  0.72*** &  0.71*** &  0.70*** &  0.71*** &  0.72*** \\ 
   \hline
\end{tabular}
}
\end{table}

###Manufacturing Subsector Activity
Figure 25 and Figure 26 illustrates the Manufacturing subsector activity series compared to the SARB and Stats SA references series. Table 11 reports that the contemporaneous correlations between the survey balances and the reference series are relatively high. 

```{r figure25, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Manufacturing subsectors compared to the reference series"}
indicator_plot <- cbind(Food[,c("Datum","Q3A")],Food_2[,c("Q3A")],ref_m[,c("Food.sa")])
indicator_plot[,-1] <- scale(indicator_plot[,-1])
colnames(indicator_plot) <- c("Date","Microdata","2-step","StatsSA")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Food") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Textiles[,c("Datum","Q3A")],Textiles_2[,c("Q3A")],ref_m[,c("Textiles.sa")])
indicator_plot[,-1] <- scale(indicator_plot[,-1])
colnames(indicator_plot) <- c("Date","Microdata","2-step","StatsSA")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("Textiles") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(Wood[,c("Datum","Q3A")],Wood_2[,c("Q3A")],ref_m[,c("Wood.sa")])
indicator_plot[,-1] <- scale(indicator_plot[,-1])
colnames(indicator_plot) <- c("Date","Microdata","2-step","StatsSA")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Wood") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom")

indicator_plot <- cbind(Chemicals[,c("Datum","Q3A")],Chemicals_2[,c("Q3A")],ref_m[,c("Chemical")])
indicator_plot[,-1] <- scale(indicator_plot[,-1])
colnames(indicator_plot) <- c("Date","Microdata","2-step","StatsSA")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Chemicals") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom")
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

```{r figure26, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Manufacturing subsectors compared to the reference series"}
indicator_plot <- cbind(Glass[,c("Datum","Q3A")],Glass_2[,c("Q3A")],ref_m[,c("Glass.sa")])
indicator_plot[,-1] <- scale(indicator_plot[,-1])
colnames(indicator_plot) <- c("Date","Microdata","2-step","StatsSA")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Glass") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Metals[,c("Datum","Q3A")],Metals_2[,c("Q3A")],ref_m[,c("Metals.sa")])
indicator_plot[,-1] <- scale(indicator_plot[,-1])
colnames(indicator_plot) <- c("Date","Microdata","2-step","StatsSA")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("Metals") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")


ref_m$Elec_Radio <- rowMeans(ref_m[,c("Electrical.sa","Radio.sa")])
indicator_plot <- cbind(Electrical[,c("Datum","Q3A")],Electrical_2[,c("Q3A")],ref_m[,c("Elec_Radio")])
indicator_plot[,-1] <- scale(indicator_plot[,-1])
colnames(indicator_plot) <- c("Date","Microdata","2-step","StatsSA")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Electrical") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom")

indicator_plot <- cbind(Transport[,c("Datum","Q3A")],Transport_2[,c("Q3A")],ref_m[,c("Transport.sa")])
indicator_plot[,-1] <- scale(indicator_plot[,-1])
colnames(indicator_plot) <- c("Date","Microdata","2-step","StatsSA")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Transport") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom")
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

```{r table11, eval=FALSE, echo=FALSE, results='asis', warning=FALSE, message=FALSE, cache = TRUE}
source("corstarsl.R")

x1 <- corstarsl(cbind(Food[,c("Datum","Q1A","Q3A")],ref_m[,c("Food.sa")])[,-1])
x2 <- corstarsl(cbind(Textiles[,c("Datum","Q1A","Q3A")],ref_m[,c("Textiles")])[,-1])
x3 <- corstarsl(cbind(Wood[,c("Datum","Q1A","Q3A")],ref_m[,c("Wood.sa")])[,-1])
x4 <- corstarsl(cbind(Chemicals[,c("Datum","Q1A","Q3A")],ref_m[,c("Chemical")])[,-1])
x5 <- corstarsl(cbind(Glass[,c("Datum","Q1A","Q3A")],ref_m[,c("Glass.sa")])[,-1])
x6 <- corstarsl(cbind(Metals[,c("Datum","Q1A","Q3A")],ref_m[,c("Metals.sa")])[,-1])
x7 <- corstarsl(cbind(Electrical[,c("Datum","Q1A","Q3A")],ref_m[,c("Elec_Radio")])[,-1])
x8 <- corstarsl(cbind(Transport[,c("Datum","Q1A","Q3A")],ref_m[,c("Transport.sa")])[,-1])
x9 <- corstarsl(cbind(Furniture[,c("Datum","Q1A","Q3A")],ref_m[,c("Furniture_all.sa")])[,-1])

x_1 <- rbind(x1[3,],x2[3,],x3[3,],x4[3,],x5[3,],x6[3,],x7[3,],x8[3,],x9[3,])
row.names(x_1) <- c("Food","Textiles","Wood","Chemicals","Glass","Metals",
                  "Elec_radio","Transport","Furniture")


x1 <- corstarsl(cbind(Food_n[,c("Datum","Q1A","Q3A")],ref_m[,c("Food.sa")])[,-1])
x2 <- corstarsl(cbind(Textiles_n[,c("Datum","Q1A","Q3A")],ref_m[,c("Textiles")])[,-1])
x3 <- corstarsl(cbind(Wood_n[,c("Datum","Q1A","Q3A")],ref_m[,c("Wood.sa")])[,-1])
x4 <- corstarsl(cbind(Chemicals_n[,c("Datum","Q1A","Q3A")],ref_m[,c("Chemical")])[,-1])
x5 <- corstarsl(cbind(Glass_n[,c("Datum","Q1A","Q3A")],ref_m[,c("Glass.sa")])[,-1])
x6 <- corstarsl(cbind(Metals_n[,c("Datum","Q1A","Q3A")],ref_m[,c("Metals.sa")])[,-1])
x7 <- corstarsl(cbind(Electrical_n[,c("Datum","Q1A","Q3A")],ref_m[,c("Elec_Radio")])[,-1])
x8 <- corstarsl(cbind(Transport_n[,c("Datum","Q1A","Q3A")],ref_m[,c("Transport.sa")])[,-1])
x9 <- corstarsl(cbind(Furniture_n[,c("Datum","Q1A","Q3A")],ref_m[,c("Furniture_all.sa")])[,-1])

x_2 <- rbind(x1[3,],x2[3,],x3[3,],x4[3,],x5[3,],x6[3,],x7[3,],x8[3,],x9[3,])


x1 <- corstarsl(cbind(Food_u[,c("Datum","Q1A","Q3A")],ref_m[,c("Food.sa")])[,-1])
x2 <- corstarsl(cbind(Textiles_u[,c("Datum","Q1A","Q3A")],ref_m[,c("Textiles")])[,-1])
x3 <- corstarsl(cbind(Wood_u[,c("Datum","Q1A","Q3A")],ref_m[,c("Wood.sa")])[,-1])
x4 <- corstarsl(cbind(Chemicals_u[,c("Datum","Q1A","Q3A")],ref_m[,c("Chemical")])[,-1])
x5 <- corstarsl(cbind(Glass_u[,c("Datum","Q1A","Q3A")],ref_m[,c("Glass.sa")])[,-1])
x6 <- corstarsl(cbind(Metals_u[,c("Datum","Q1A","Q3A")],ref_m[,c("Metals.sa")])[,-1])
x7 <- corstarsl(cbind(Electrical_u[,c("Datum","Q1A","Q3A")],ref_m[,c("Elec_Radio")])[,-1])
x8 <- corstarsl(cbind(Transport_u[,c("Datum","Q1A","Q3A")],ref_m[,c("Transport.sa")])[,-1])
x9 <- corstarsl(cbind(Furniture_u[,c("Datum","Q1A","Q3A")],ref_m[,c("Furniture_all.sa")])[,-1])

x_3 <- rbind(x1[3,],x2[3,],x3[3,],x4[3,],x5[3,],x6[3,],x7[3,],x8[3,],x9[3,])

x1 <- corstarsl(cbind(Food_2[,c("Datum","Q1A","Q3A")],ref_m[,c("Food.sa")])[,-1])
x2 <- corstarsl(cbind(Textiles_2[,c("Datum","Q1A","Q3A")],ref_m[,c("Textiles")])[,-1])
x3 <- corstarsl(cbind(Wood_2[,c("Datum","Q1A","Q3A")],ref_m[,c("Wood.sa")])[,-1])
x4 <- corstarsl(cbind(Chemicals_2[,c("Datum","Q1A","Q3A")],ref_m[,c("Chemical")])[,-1])
x5 <- corstarsl(cbind(Glass_2[,c("Datum","Q1A","Q3A")],ref_m[,c("Glass.sa")])[,-1])
x6 <- corstarsl(cbind(Metals_2[,c("Datum","Q1A","Q3A")],ref_m[,c("Metals.sa")])[,-1])
x7 <- corstarsl(cbind(Electrical_2[,c("Datum","Q1A","Q3A")],ref_m[,c("Elec_Radio")])[,-1])
x8 <- corstarsl(cbind(Transport_2[,c("Datum","Q1A","Q3A")],ref_m[,c("Transport.sa")])[,-1])
x9 <- corstarsl(cbind(Furniture_2[,c("Datum","Q1A","Q3A")],ref_m[,c("Furniture_all.sa")])[,-1])

x_4 <- rbind(x1[3,],x2[3,],x3[3,],x4[3,],x5[3,],x6[3,],x7[3,],x8[3,],x9[3,])


x <- cbind(x_1,x_3,x_2,x_4)
colnames(x) <- c("Q1A","Q3A","Q1A_U","Q3A_U","Q1A_New","Q3A_New","Q1A_2s","Q3A_2s")

xt <- xtable(x, caption="Manufacturing subsector correlations")
print(xt, "latex",comment=FALSE,scalebox = 0.9, caption.placement = getOption("xtable.caption.placement", "top"), include.rownames=TRUE)
```

\begin{table}[ht]
\centering
\caption{Correlations between Manufacturing subsectors and reference series}
\scalebox{0.7}{
\begin{tabular}{|l|llll|llll|}
  \hline
 & Q1A & Q1A\_U & Q1A\_New & Q1A\_2s & Q3A & Q3A\_U & Q3A\_New & Q3A\_2s \\ 
  \hline
Food & -0.08  &  0.05  &  0.02  &  0.01  & -0.14  &  0.05  &  0.00  & -0.02  \\ 
  Textiles &  0.29**  &  0.63*** &  0.50*** &  0.63*** &  0.30**  &  0.65*** &  0.51*** &  0.62*** \\ 
  Wood &  0.41*** &  0.53*** &  0.47*** &  0.45*** &  0.41*** &  0.49*** &  0.42*** &  0.42*** \\ 
  Chemicals &  0.31*** &  0.30**  &  0.33*** &  0.36*** &  0.37*** &  0.34*** &  0.38*** &  0.41*** \\ 
  Glass &  0.57*** &  0.59*** &  0.61*** &  0.60*** &  0.47*** &  0.56*** &  0.55*** &  0.51*** \\ 
  Metals &  0.62*** &  0.68*** &  0.69*** &  0.67*** &  0.57*** &  0.69*** &  0.68*** &  0.66*** \\ 
  Elec\_radio &  0.01  &  0.22*  &  0.03  &  0.01  &  0.04  &  0.24**  &  0.07  &  0.07  \\ 
  Transport &  0.43*** &  0.48*** &  0.48*** &  0.50*** &  0.49*** &  0.47*** &  0.48*** &  0.54*** \\ 
  Furniture &  0.45*** &  0.48*** &  0.48*** &  0.54*** &  0.38*** &  0.41*** &  0.39*** &  0.44*** \\ 
   \hline
\end{tabular}
}
\end{table}


###Exports
For the series relating to exports we use the growth rates in the Rand values and Dollar volumes of manufacturing exports as reference series. Figure 27 compares the total export series to the reference series. Figure 28 illustrates the export balances and the reference series for a selection of subsectors. In both cases the reference series are very volatile. There is unrealistic decrease in the total exports reference series in 1994, which is not echoed in the sub-sector series. The subsector export reference series also seem to have unrealistic spikes. The correlations between the balances and the reference series are therefore relatively low, as reported in Table 12, and the correlations with the Dollar volume series are not significant. Still, the new weights seem to improve these correlations.

```{r figure27, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Total Manufacturing exports compared to the reference series"}
indicator_plot <- cbind(Manufacturing_ne[,c("Datum","Q2A")],Manufacturing_2e[,c("Q2A")],ref_me[,c("Manu_Rval","Manu_Dvol")])
colnames(indicator_plot) <- c("Date","Exp Weight","2-step","Rand Value","Dollar volume")
indicator_plot[,-1] <- scale(indicator_plot[,-1])
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g <- g + geom_line()
g <- g + ylab("Indicator") + xlab("")
g <- g + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g <- g + theme(legend.title=element_blank()) 
g <- g + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g <- g + theme(legend.position="bottom")
g
```

```{r figure28, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap= "Manufacturing subsector exports compared to the reference series"}
indicator_plot <- cbind(Food[,c("Datum","Q2A")],Food_ne[,c("Q2A")],ref_me[,c("Food_Rval","Food_Dvol")])
indicator_plot[,-1] <- scale(indicator_plot[,-1])
colnames(indicator_plot) <- c("Date","Microdata","New Weights","Rand value","Dollar volume")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Food") + theme(plot.title = element_text(hjust = 0.5))
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Textiles[,c("Datum","Q2A")],Textiles_ne[,c("Q2A")],ref_me[,c("Text_Rval","Text_Dvol")])
indicator_plot[,-1] <- scale(indicator_plot[,-1])
colnames(indicator_plot) <- c("Date","Microdata","New Weights","Rand value","Dollar volume")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("Textiles") + theme(plot.title = element_text(hjust = 0.5))
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(Wood[,c("Datum","Q2A")],Wood_ne[,c("Q2A")],ref_me[,c("Wood_Rval","Wood_Dvol")])
indicator_plot[,-1] <- scale(indicator_plot[,-1])
colnames(indicator_plot) <- c("Date","Microdata","New Weights","Rand value","Dollar volume")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Wood") + theme(plot.title = element_text(hjust = 0.5))
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom")

indicator_plot <- cbind(Chemicals[,c("Datum","Q2A")],Chemicals_ne[,c("Q2A")],ref_me[,c("Chem_Rval","Chem_Dvol")])
indicator_plot[,-1] <- scale(indicator_plot[,-1])
colnames(indicator_plot) <- c("Date","Microdata","New Weights","Rand value","Dollar volume")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Chemicals") + theme(plot.title = element_text(hjust = 0.5))
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom")
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

\begin{table}[ht]
\centering
\caption{Correlations between the sectoral exports and reference series} 
\scalebox{0.7}{
\begin{tabular}{|l|lll|lll|}
  \hline
 & Q2A & Q2A\_NExp & Q2A\_2Exp & Q5A & Q5A\_NExp & Q5A\_2Exp \\ 
  \hline
  Total\_Rval &  0.13 &  0.16 &  0.22** &  0.17* &  0.20* &  0.25** \\
Food\_Rval &  0.30*** &  0.36*** &  0.30*** &  0.31*** &  0.36*** &  0.31*** \\ 
  Text\_Rval &  0.10  &  0.18*  &  0.16  &  0.10  &  0.16  &  0.14  \\ 
  Wood\_Rval &  0.06  &  0.18*  &  0.17*  &  0.08  &  0.20**  &  0.21**  \\ 
  Chem\_Rval &  0.33*** &  0.37*** &  0.42*** &  0.36*** &  0.39*** &  0.46*** \\ 
  Glass\_Rval &  0.11  &  0.05  &  0.13  &  0.08  &  0.03  &  0.08  \\ 
  Metals\_Rval &  0.31*** &  0.32*** &  0.37*** &  0.41*** &  0.42*** &  0.44*** \\ 
  Elec\_Radio\_Rval &  0.19*  &  0.29*** &  0.23**  &  0.16  &  0.26*** &  0.21**  \\ 
  Motor\_Rval &  0.05  &  0.14  &  0.15  &  0.02  &  0.09  &  0.11  \\ 
  Furn\_Rval &  0.20**  &  0.18*  &  0.19*  &  0.18*  &  0.12  &  0.12  \\ 
   \hline
  \end{tabular} }
\end{table}

###Volatility
We can also compare the series in terms of volatility. Table 13 reports the volatilities of the series over time. In general the new weights produce series that are less volatile than the old series. The unweighted series are often the least volatile, implying that the weights impart some volatility to the series.

```{r table13, eval=FALSE, echo=FALSE, results='asis', warning=FALSE, message=FALSE, cache = TRUE}
V <- sapply(colnames(Manu),function(x) sd(Manu[,x], na.rm = TRUE))[1:8]
V <- t(as.data.frame(V))

data <- cbind(Food[,c("Q1A","Q3A")],Food_u[,c("Q1A","Q3A")],
              Food_n[,c("Q1A","Q3A")],Food_2[,c("Q1A","Q3A")])
V <- rbind(V,sapply(1:8,function(x) sd(data[,x], na.rm = TRUE))[1:8])

data <- cbind(Textiles[,c("Q1A","Q3A")],Textiles_u[,c("Q1A","Q3A")],
              Textiles_n[,c("Q1A","Q3A")],Textiles_2[,c("Q1A","Q3A")])
V <- rbind(V,sapply(1:8,function(x) sd(data[,x], na.rm = TRUE))[1:8])

data <- cbind(Wood[,c("Q1A","Q3A")],Wood_u[,c("Q1A","Q3A")],
              Wood_n[,c("Q1A","Q3A")],Wood_2[,c("Q1A","Q3A")])
V <- rbind(V,sapply(1:8,function(x) sd(data[,x], na.rm = TRUE))[1:8])

data <- cbind(Chemicals[,c("Q1A","Q3A")],Chemicals_u[,c("Q1A","Q3A")],
              Chemicals_n[,c("Q1A","Q3A")],Chemicals_2[,c("Q1A","Q3A")])
V <- rbind(V,sapply(1:8,function(x) sd(data[,x], na.rm = TRUE))[1:8])

data <- cbind(Glass[,c("Q1A","Q3A")],Glass_u[,c("Q1A","Q3A")],
              Glass_n[,c("Q1A","Q3A")],Glass_2[,c("Q1A","Q3A")])
V <- rbind(V,sapply(1:8,function(x) sd(data[,x], na.rm = TRUE))[1:8])

data <- cbind(Metals[,c("Q1A","Q3A")],Metals_u[,c("Q1A","Q3A")],
              Metals_n[,c("Q1A","Q3A")],Metals_2[,c("Q1A","Q3A")])
V <- rbind(V,sapply(1:8,function(x) sd(data[,x], na.rm = TRUE))[1:8])

data <- cbind(Electrical[,c("Q1A","Q3A")],Electrical_u[,c("Q1A","Q3A")],
              Electrical_n[,c("Q1A","Q3A")],Electrical_2[,c("Q1A","Q3A")])
V <- rbind(V,sapply(1:8,function(x) sd(data[,x], na.rm = TRUE))[1:8])

data <- cbind(Transport[,c("Q1A","Q3A")],Transport_u[,c("Q1A","Q3A")],
              Transport_n[,c("Q1A","Q3A")],Transport_2[,c("Q1A","Q3A")])
V <- rbind(V,sapply(1:8,function(x) sd(data[,x], na.rm = TRUE))[1:8])

data <- cbind(Furniture[,c("Q1A","Q3A")],Furniture_u[,c("Q1A","Q3A")],
              Furniture_n[,c("Q1A","Q3A")],Furniture_2[,c("Q1A","Q3A")])
V <- rbind(V,sapply(1:8,function(x) sd(data[,x], na.rm = TRUE))[1:8])

colnames(V) <- c("Q1A","Q3A","Q1A_U","Q3A_U","Q1A_New","Q3A_New","Q1A_2s","Q3A_2s")
row.names(V) <- c("Total","Food","Textiles","Wood","Chemicals","Glass","Metals","Electrical","Transport","Furniture")

xt <- xtable(V, caption="Volatility")
print(xt, "latex",comment=FALSE,scalebox = 0.9, caption.placement = getOption("xtable.caption.placement", "top"), include.rownames=TRUE)
```

\begin{table}[ht]
\centering
\caption{Volatility of the Manufacturing series} 
\scalebox{0.7}{
\begin{tabular}{|r|rrrr|rrrr|}
  \hline
 & Q1A & Q1A\_U & Q1A\_New & Q1A\_2s & Q3A & Q3A\_U & Q3A\_New & Q3A\_2s \\ 
  \hline
  Total & 27.18 & 22.99 & 23.20 & 24.45 & 24.98 & 21.58 & 21.71 & 22.66 \\ 
  Food & 35.81 & 22.77 & 24.00 & 26.79 & 35.76 & 20.65 & 23.21 & 25.05 \\ 
  Textiles & 36.12 & 26.12 & 26.96 & 27.43 & 36.62 & 26.24 & 27.25 & 28.45 \\ 
  Wood & 36.86 & 25.63 & 25.96 & 27.93 & 33.28 & 24.45 & 24.67 & 26.01 \\ 
  Chemicals & 32.16 & 23.39 & 24.16 & 24.75 & 30.83 & 22.37 & 22.59 & 23.04 \\ 
  Glass & 46.02 & 31.72 & 36.53 & 34.94 & 43.94 & 28.72 & 32.03 & 31.08 \\ 
  Metals & 37.79 & 28.06 & 29.60 & 30.59 & 34.96 & 27.29 & 28.18 & 29.36 \\ 
  Elec\_radio & 50.29 & 33.03 & 48.84 & 48.98 & 49.30 & 33.03 & 49.23 & 50.63 \\ 
  Transport & 55.88 & 32.70 & 38.78 & 43.61 & 52.29 & 32.52 & 38.30 & 41.92 \\ 
  Furniture & 44.71 & 31.50 & 35.29 & 35.01 & 43.07 & 30.42 & 34.10 & 33.45 \\ 
   \hline
\end{tabular}
}
\end{table}

##Summary
After some corrections the microdata seems to provide series that correspond very closely to the published series. We have calculated new series, using four weighting procedures, and compared them to the reference series. We chose the Stats SA series as reference series, as it is widely available for many of our subsectors and has a relatively high correlation with the balances. The final series still have to be written to an Excel file in a format that is convenient for processing. The updates can and should be fully automated.

\newpage
#The Trade Surveys 
In this section we examine the Trade sector surveys: Retail, Wholesale and Motor Vehicles. The Retail, Wholesale and Motor Vehicle microdata is available from 1992Q2-2017Q2. Similar to the other surveys, to match the questions and responses in the different versions of the surveys, the surveys in the old records were compared to the current incarnations. We identified and marked the questions in the old (pre-2001) surveys and matched them to the new survey questions. The old questionnaires have been uploaded to the Dropbox folder. 

Where published series were available, we used the published values for those missing values. Where they were unavailable, we used simple linear interpolation to create complete continuous series. There is very little difference between the substitution of the published values and simple linear interpolation. In all cases we corrected the clear errors in the microdata. Some of the original sector codes were not included in the new sector classifications and these were reclassified to correspond to the new sector code classifications. 

##The Retail Survey 
```{r R.retail, echo=FALSE, results='hide', message=FALSE, warning=FALSE, cache = TRUE}
pub_r <- read.csv("Retail_BER_Published.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
ref_r <- read.csv("Ref Series_Retail.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
ad_r <- read.csv("Retail_Adjustment.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
ad_r[,-1] <- ad_r[,-1]+pub_r[,-1]


#RETAIL
BER.R <- read.csv("Retail_92Q2-17Q2.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
colnames(BER.R)[1:6] <- c("region","id","sector","weight","factor","surveyQ")
BER.R$surveyQ <- toupper(BER.R$surveyQ)
BER.R$sector <- factor(BER.R$sector) #could include labels
BER.R$id <- factor(BER.R$id)

#Clean SurveyQ variable
BER.R$temp <- NULL
for(i in 1:nrow(BER.R)) {
    ifelse(substr(BER.R$surveyQ[i], 1, 1)==9, 
           BER.R$temp[i] <- paste0("19",BER.R$surveyQ[i],sep=""),
           BER.R$temp[i] <- paste0("20",BER.R$surveyQ[i],sep=""))
}
BER.R$surveyQ <- BER.R$temp
BER.R <- BER.R[,-ncol(BER.R)]
BER.R$surveyQ <- factor(BER.R$surveyQ)

#Clean regions
Mode <- function(x) {
    ux <- na.remove(unique(x))
    ux[which.max(tabulate(match(x, ux)))]
}
foute <- c("1997Q2")#,"2000Q3","2000Q4","2001Q1")
korrek <- c("1996Q1","1996Q2","1996Q3","1996Q4","1997Q1",
            "1997Q3","1997Q4","1998Q1","1998Q2","1998Q3",
            "1998Q4")#,"2004Q1","2004Q2","2004Q3","2004Q4",
#"2005Q1","2005Q2","2005Q3","2006Q1","2006Q2","2006Q3","2006Q4")
for(i in levels(BER.R$id)) {
    if(!is.na(Mode(BER.R$region[(BER.R$surveyQ %in% korrek) & (BER.R$id == i)]))) {
        BER.R$region[(BER.R$surveyQ %in% foute) & (BER.R$id == i)] <- Mode(BER.R$region[(BER.R$surveyQ %in% korrek) & (BER.R$id == i)]) 
    }
}
BER.R$region <- factor(BER.R$region)

BER.R <- BER.R[BER.R$Latecomer == FALSE | is.na(BER.R$Latecomer),]
#Exclude new recruits for 2010Q4
#BER.R$New2010Q4 <- FALSE
#BER.R$New2010Q4 <- replace(BER.R$New2010Q4, (BER.R$surveyQ=="2010Q4" & BER.R$NewRecruit==TRUE), TRUE)
#BER.R <- BER.R[BER.R$New2010Q4 == FALSE | is.na(BER.R$New2010Q4),]

BER.R <- BER.R[,1:21]
BER.R <- BER.R[,!grepl("X",colnames(BER.R))]    

for(i in 7:21) {
    BER.R[,i] <- replace(BER.R[,i], BER.R[,i]==2, 0)
    BER.R[,i] <- replace(BER.R[,i], BER.R[,i]==3,-1)
}

#---------------------
#New faktor variable 
#RETAIL
BER.Rn <- read.csv("Retail_new faktor.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
colnames(BER.Rn)[1:6] <- c("region","id","sector","weight","factor","surveyQ")
BER.Rn$surveyQ <- toupper(BER.Rn$surveyQ)
BER.Rn$sector <- factor(BER.Rn$sector) #could include labels
BER.Rn$id <- factor(BER.Rn$id)

#Clean SurveyQ variable
BER.Rn$temp <- NULL
for(i in 1:nrow(BER.Rn)) {
    ifelse(substr(BER.Rn$surveyQ[i], 1, 1)==9, 
           BER.Rn$temp[i] <- paste0("19",BER.Rn$surveyQ[i],sep=""),
           BER.Rn$temp[i] <- paste0("20",BER.Rn$surveyQ[i],sep=""))
}
BER.Rn$surveyQ <- BER.Rn$temp
BER.Rn <- BER.Rn[,-ncol(BER.Rn)]
BER.Rn$surveyQ <- factor(BER.Rn$surveyQ)
BER.Rn$factor <- as.numeric(as.character(BER.Rn$factor))    

#Clean regions
Mode <- function(x) {
    ux <- na.remove(unique(x))
    ux[which.max(tabulate(match(x, ux)))]
}
foute <- c("1997Q2")#,"2000Q3","2000Q4","2001Q1")
korrek <- c("1996Q1","1996Q2","1996Q3","1996Q4","1997Q1",
            "1997Q3","1997Q4","1998Q1","1998Q2","1998Q3",
            "1998Q4")#,"2004Q1","2004Q2","2004Q3","2004Q4",
#"2005Q1","2005Q2","2005Q3","2006Q1","2006Q2","2006Q3","2006Q4")
for(i in levels(BER.Rn$id)) {
    if(!is.na(Mode(BER.Rn$region[(BER.Rn$surveyQ %in% korrek) & (BER.Rn$id == i)]))) {
        BER.Rn$region[(BER.Rn$surveyQ %in% foute) & (BER.Rn$id == i)] <- Mode(BER.Rn$region[(BER.Rn$surveyQ %in% korrek) & (BER.Rn$id == i)]) 
    }
}
BER.Rn$region <- factor(BER.Rn$region)

BER.Rn <- BER.Rn[BER.Rn$Latecomer == FALSE | is.na(BER.Rn$Latecomer),]
#Exclude new recruits for 2010Q4
#BER.Rn$New2010Q4 <- FALSE
#BER.Rn$New2010Q4 <- replace(BER.Rn$New2010Q4, (BER.Rn$surveyQ=="2010Q4" & BER.Rn$NewRecruit==TRUE), TRUE)
#BER.Rn <- BER.Rn[BER.Rn$New2010Q4 == FALSE | is.na(BER.Rn$New2010Q4),]

BER.Rn <- BER.Rn[,1:21]
BER.Rn <- BER.Rn[,!grepl("X",colnames(BER.Rn))]    

for(i in 7:21) {
    BER.Rn[,i] <- replace(BER.Rn[,i], BER.Rn[,i]==2, 0)
    BER.Rn[,i] <- replace(BER.Rn[,i], BER.Rn[,i]==3,-1)
}


#-----------------------
#New 2-step weighting 
BER.R2 <- read.csv("Retail_new faktor_sep.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
colnames(BER.R2)[1:8] <- c("region","id","sector","weight","firmw","sectorw","factor","surveyQ")
BER.R2$surveyQ <- toupper(BER.R2$surveyQ)
BER.R2$sector <- factor(BER.R2$sector) #could include labels
BER.R2$id <- factor(BER.R2$id)

BER.R2$firmw <- as.numeric(as.character(BER.R2$firmw))
BER.R2$sectorw <- as.numeric(as.character(BER.R2$sectorw))
BER.R2$factor <- as.numeric(as.character(BER.R2$factor))    

#Clean SurveyQ variable
BER.R2$temp <- NULL
for(i in 1:nrow(BER.R2)) {
    ifelse(substr(BER.R2$surveyQ[i], 1, 1)==9, 
           BER.R2$temp[i] <- paste0("19",BER.R2$surveyQ[i],sep=""),
           BER.R2$temp[i] <- paste0("20",BER.R2$surveyQ[i],sep=""))
}
BER.R2$surveyQ <- BER.R2$temp
BER.R2 <- BER.R2[,-ncol(BER.R2)]
BER.R2$surveyQ <- factor(BER.R2$surveyQ)

#Clean regions
foute <- c("1997Q2")#,"2000Q3","2000Q4","2001Q1")
korrek <- c("1996Q1","1996Q2","1996Q3","1996Q4","1997Q1",
            "1997Q3","1997Q4","1998Q1","1998Q2","1998Q3",
            "1998Q4")#,"2004Q1","2004Q2","2004Q3","2004Q4",
#"2005Q1","2005Q2","2005Q3","2006Q1","2006Q2","2006Q3","2006Q4")
for(i in levels(BER.R2$id)) {
    if(!is.na(Mode(BER.R2$region[(BER.R2$surveyQ %in% korrek) & (BER.R2$id == i)]))) {
        BER.R2$region[(BER.R2$surveyQ %in% foute) & (BER.R2$id == i)] <- Mode(BER.R2$region[(BER.R2$surveyQ %in% korrek) & (BER.R2$id == i)]) 
    }
}
BER.R2$region <- factor(BER.R2$region)

BER.R2 <- BER.R2[BER.R2$Latecomer == FALSE | is.na(BER.R2$Latecomer),]
BER.R2 <- BER.R2[,1:23]
BER.R2 <- BER.R2[,!grepl("X",colnames(BER.R2))]    

for(i in 9:23) {
    BER.R2[,i] <- replace(BER.R2[,i], BER.R2[,i]==2, 0)
    BER.R2[,i] <- replace(BER.R2[,i], BER.R2[,i]==3,-1)
}

#Maak factor reg
Ej <- aggregate(BER.R2$firmw, by=list(BER.R2$surveyQ,BER.R2$sector), FUN=sum)
BER.R2 <-  merge(BER.R2, Ej, by.x=c("surveyQ","sector"), by.y=c("Group.1","Group.2"),all = TRUE)
BER.R2$factor <- BER.R2$factor/BER.R2$x*100
BER.R2 <- BER.R2[,c(3,4,2,5:8,1,9:23)]

#RETAIL
retailsd <- c(3110,3120,3160,3140,3130,3170,3150)
retailnd <- c(3230,3210,3240,3220)
retaild <- c(3330,3370,3310,3340,3350,3320,3380,3360)
retailo <- c(3410,3420)
hardware <- 3330 
other_duarbles <- c(3370,3310,3340,3350,3320,3380,3360)
all_r <- as.numeric(as.character(unique(BER.R$sector)))
streke <- unique(BER.R$region)

#RETAIL
Retail <- geweeg(BER.R,all_r,streke,2:102)
Retail_u <- ongeweeg(BER.R,all_r,streke,2:102)

Retailsd <- geweeg(BER.R,retailsd,streke,2:102)
Retailnd <- geweeg(BER.R,retailnd,streke,2:102)
Retaild <- geweeg(BER.R,retaild,streke,2:102)
#retailo <- geweeg(BER.R,retailo,streke,2:102)

Hardware <- geweeg(BER.R,hardware,streke,2:102)
Other_duarbles <- geweeg(BER.R,other_duarbles,streke,2:102)

WC.R <- geweeg(BER.R,all_r,1,2:102)
KZN.R <- geweeg(BER.R,all_r,5,2:102)
GP.R <- geweeg(BER.R,all_r,6,2:102)

#Interpolasie
Retail[3,c(4,seq(5,17,by=2),18)] <- ad_r[3,2:10]
Retail[6,c(4,seq(5,17,by=2),18)] <- ad_r[6,2:10]
Retail[55,c(4,seq(5,17,by=2),18)] <- ad_r[55,2:10]
Retailsd[3,c(4,seq(5,17,by=2),18)] <- ad_r[55,2:10]
Retailsd[6,c(4,seq(5,17,by=2),18)] <- ad_r[6,11:19]
Retailsd[55,c(4,seq(5,17,by=2),18)] <- ad_r[55,11:19]
Retailnd[3,c(4,seq(5,17,by=2),18)] <- ad_r[3,20:28]
Retailnd[6,c(4,seq(5,17,by=2),18)] <- ad_r[6,20:28]
Retailnd[55,c(4,seq(5,17,by=2),18)] <- ad_r[55,20:28]
Retaild[3,c(4,seq(5,17,by=2),18)] <- ad_r[3,29:37]
Retaild[6,c(4,seq(5,17,by=2),18)] <- ad_r[6,29:37]
Retaild[55,c(4,seq(5,17,by=2),18)] <- ad_r[55,29:37]

WC.R[55,c(4,seq(5,17,by=2),18)] <- ad_r[55,38:46]
GP.R[55,c(4,seq(5,17,by=2),18)] <- ad_r[55,47:55]
KZN.R[55,c(4,seq(5,17,by=2),18)] <- ad_r[55,56:64]

#------------------
#New faktor
Retail_n <- geweeg(BER.Rn,all_r,streke,2:102)

Retailsd_n <- geweeg(BER.Rn,retailsd,streke,2:102)
Retailnd_n <- geweeg(BER.Rn,retailnd,streke,2:102)
Retaild_n <- geweeg(BER.Rn,retaild,streke,2:102)
#Retailo_n <- geweeg(BER.Rn,retailo,streke,2:102)

Hardware_n <- geweeg(BER.Rn,hardware,streke,2:102)
Other_duarbles_n <- geweeg(BER.Rn,other_duarbles,streke,2:102)

WC.R_n <- geweeg(BER.Rn,all_r,1,2:102)
KZN.R_n <- geweeg(BER.Rn,all_r,5,2:102)
GP.R_n <- geweeg(BER.Rn,all_r,6,2:102)

#Interpolasie
Retail_n[3,c(4,seq(5,17,by=2),18)] <- ad_r[3,2:10]
Retail_n[6,c(4,seq(5,17,by=2),18)] <- ad_r[6,2:10]
Retail_n[55,c(4,seq(5,17,by=2),18)] <- ad_r[55,2:10]
Retailsd_n[3,c(4,seq(5,17,by=2),18)] <- ad_r[55,2:10]
Retailsd_n[6,c(4,seq(5,17,by=2),18)] <- ad_r[6,11:19]
Retailsd_n[55,c(4,seq(5,17,by=2),18)] <- ad_r[55,11:19]
Retailnd_n[3,c(4,seq(5,17,by=2),18)] <- ad_r[3,20:28]
Retailnd_n[6,c(4,seq(5,17,by=2),18)] <- ad_r[6,20:28]
Retailnd_n[55,c(4,seq(5,17,by=2),18)] <- ad_r[55,20:28]
Retaild_n[3,c(4,seq(5,17,by=2),18)] <- ad_r[3,29:37]
Retaild_n[6,c(4,seq(5,17,by=2),18)] <- ad_r[6,29:37]
Retaild_n[55,c(4,seq(5,17,by=2),18)] <- ad_r[55,29:37]

WC.R_n[55,c(4,seq(5,17,by=2),18)] <- ad_r[55,38:46]
GP.R_n[55,c(4,seq(5,17,by=2),18)] <- ad_r[55,47:55]
KZN.R_n[55,c(4,seq(5,17,by=2),18)] <- ad_r[55,56:64]

#------------------
#2-step
#Retail_n2 <- maak.index(all_r)[1:100,]
BER.R2 <- BER.R2[,-5:-6]
Retail_2 <- geweeg(BER.R2,all_r,streke,2:102)
Retailsd_2 <- geweeg(BER.R2,retailsd,streke,2:102)
Retailnd_2 <- geweeg(BER.R2,retailnd,streke,2:102)
Retaild_2 <- geweeg(BER.R2,retaild,streke,2:102)
#Retailo_2 <- geweeg(BER.R2,retailo,streke,2:102)
Hardware_2 <- geweeg(BER.R2,hardware,streke,2:102)
Other_duarbles_2 <- geweeg(BER.R2,other_duarbles,streke,2:102)

WC.R_2 <- geweeg(BER.R2,all_r,1,2:102)
KZN.R_2 <- geweeg(BER.R2,all_r,5,2:102)
GP.R_2 <- geweeg(BER.R2,all_r,6,2:102)

#Interpolasie
Retail_2[3,c(4,seq(5,17,by=2),18)] <- ad_r[3,2:10]
Retail_2[6,c(4,seq(5,17,by=2),18)] <- ad_r[6,2:10]
Retail_2[55,c(4,seq(5,17,by=2),18)] <- ad_r[55,2:10]
Retailsd_2[3,c(4,seq(5,17,by=2),18)] <- ad_r[55,2:10]
Retailsd_2[6,c(4,seq(5,17,by=2),18)] <- ad_r[6,11:19]
Retailsd_2[55,c(4,seq(5,17,by=2),18)] <- ad_r[55,11:19]
Retailnd_2[3,c(4,seq(5,17,by=2),18)] <- ad_r[3,20:28]
Retailnd_2[6,c(4,seq(5,17,by=2),18)] <- ad_r[6,20:28]
Retailnd_2[55,c(4,seq(5,17,by=2),18)] <- ad_r[55,20:28]
Retaild_2[3,c(4,seq(5,17,by=2),18)] <- ad_r[3,29:37]
Retaild_2[6,c(4,seq(5,17,by=2),18)] <- ad_r[6,29:37]
Retaild_2[55,c(4,seq(5,17,by=2),18)] <- ad_r[55,29:37]

WC.R_2[55,c(4,seq(5,17,by=2),18)] <- ad_r[55,38:46]
GP.R_2[55,c(4,seq(5,17,by=2),18)] <- ad_r[55,47:55]
KZN.R_2[55,c(4,seq(5,17,by=2),18)] <- ad_r[55,56:64]
```

This section presents the results for the Retail surveys. Table 14 reports some characteristics of the Retail survey microdata. The Retail microdata are missing for the following quarters: 1997Q4, 2000Q1 and 2005Q4. Table 15 reports the new subsector codes that are used to calculate balances. Balances are calculated for *total retail*, *durable*, *semi-durable* and *non-durable goods*. In addition, we calculate separate series for *hardware* and *other durable goods*. Figure 29 illustrates the number of respondents by subsector, according to these sector classifications. 

```{r table14, echo=FALSE, results='asis', warning=FALSE, message=FALSE, cache = TRUE}
ave <- mean(aggregate(BER.R$id, by=list(BER.R$surveyQ), FUN = length)[,2])
tafel <- cbind("1992Q2-2017Q2",length(BER.R$id),round(ave,2),
               "1992Q4,1993Q3,2005Q4")
colnames(tafel) <- c("Sample","Total Obs","Obs/Quarter","Missing Quarters")     
row.names(tafel) <- "Retail Survey"
xt <- xtable(tafel, caption="Sample characteristics")
print(xt, "latex",comment=FALSE, caption.placement = getOption("xtable.caption.placement", "top"), scalebox = 0.8,
      include.rownames=TRUE)
```

\begin{table}[]
\centering
\caption{Retail Sector Codes}
\label{my-label}
\scalebox{0.8}{
\begin{tabular}{|l|l|l|}
\hline
\textbf{Sector}           & \textbf{Subsector} & \textbf{Code}                                                                       \\ \hline
Semi-Durables             &                    & \begin{tabular}[c]{@{}l@{}}3110, 3120, 3160, 3140,\\ 3130, 3170, 3150\end{tabular}  \\ \hline
Non-Durables             &                    & 3230, 3210, 3240, 3220                                                              \\ \hline
\multirow{2}{*}{Durables} & Hardware           & 3330                                                                                \\ \cline{2-3} 
                          & Other              & \begin{tabular}[c]{@{}l@{}}3370, 3310, 3340, 3350, \\ 3320, 3380, 3360\end{tabular} \\ \hline
Other                     &                    & 3410, 3420                                                                          \\ \hline
\end{tabular}}
\end{table}


```{r figure29, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="The number of respondents by subsector (1992Q2-2017Q2)"}
BERplot <- BER.R
BERplot$Sector[BERplot$sector %in% retailsd] <- "Retail (semi-durable)" 
BERplot$Sector[BERplot$sector %in% retailnd] <- "Retail (non-durable)"  
BERplot$Sector[BERplot$sector %in% retaild] <- "Retail (durable)" 
BERplot$Sector[BERplot$sector %in% retailo] <- "Retail (other)"  
BERplot$sectorw <- BERplot$factor/BERplot$weight

BERplot1 <- aggregate(BERplot$id, by=list(BERplot$surveyQ,BERplot$Sector), FUN = length)
BERplot1$Group.1 <- as.Date(as.yearqtr(BERplot1$Group.1, format = "%YQ%q"))
g <- ggplot(BERplot1, aes(x=Group.1, y=x,fill=Group.2))
g <- g + geom_bar(stat="identity")
g <- g + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g <- g + scale_fill_discrete(name="Subsector")
g <- g + scale_y_continuous(labels=comma)
g <- g + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g <- g + ylab("Number of Respondents")
g <- g + xlab("Date")
g
```

###The Retail Indicators
Similar to the Manufacturing survey we have created three versions of the balance statistics for all of the questions. The baseline balance statistics are calculated in the same way as the normal BER procedure. The weights are calculated as: $w_{it} = f_{it} s_{jt} ,$ where $f_{it}$ the firm size weight (i.e. the inner weight reflecting turnover or number of employees) for firm $i$ at time $t$; and $s_{jt}$ is the subsector weight (i.e. the outer weight reflecting the share of total value added) for subsector $j$ at time $t$. These series are then compared to the BER's published series to ensure that the microdata is correct.

The second set of indicators is based on a new 4-part firm classification, which are less exponential than the previous weights. The final set of indicators is based on the two-step weighting procedure, where the weights are calculated as: $w_{it} = f_{it} s_{jt} / F_{jt} ,$ where $f_{it}$ the firm size weight (i.e. the new 4-part classification) for firm $i$ at time $t$; $s_{jt}$ is the subsector weight for subsector $j$ at time $t$; and $F_{jt} = \sum^N_{i=1} f_{it}$ is the total firm weight for subsector $j$ at time $t$. 

####Published Series
In this section the published results are compared to the balances calculated with the microdata. However, the comparison is complicated by the revisions to the published results in 1997Q1 and 2008Q3, when the sector weights were adjusted. To chain the old and new series together, an adjustment factor was added to all the quarters before the revisions. The adjustment factor was calculated as the difference between the results using the existing and revised weights in the quarter when the revision was done. This adjustment was then added to the historical series. 

To make a comparison, therefore, the adjustment factors were subtracted from the published series for comparison to the microdata. The adjustment factors are available in the Excel files on Dropbox. Thus, the microdata series should correspond to the published series before the revisions and adjustment factors. 

Figure 30 illustrates the results for total Retail, comparing the published series (with and without adjustment) to the balances based on the microdata. Figure 31 illustrates the comparison for a selection of questions. The series are almost identical, except for 1997Q2-1998Q2 and 2010Q4. Figure 32 illustrates the comparisons for the three main regions. The series are very similar, especially after 2001. The microdata therefore seems to correspond to the published series (before adjustment factors), and the microdata therefore seems to be correct.

```{r figure30, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Total Retail compared to the published series"}
indicator_plot <- cbind(Retail[,c("Datum","Q1")],ad_r[,"Total_Q1"],pub_r[,"Total_Q1"]) 
colnames(indicator_plot) <- c("Date","Weighted","Adjusted","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g <- g + geom_line()
g <- g + geom_point()
g <- g + ylab("Indicator") + xlab("")
g <- g + ggtitle("Retail Q1")
g <- g + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g <- g + theme(legend.title=element_blank()) 
g <- g + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g <- g + theme(legend.position="bottom")
g
```

```{r figure31, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Retail subsectors compared to the published series"}
indicator_plot <- cbind(Retail[,c("Datum","Q1")],ad_r[,"Total_Q1"])#,pub_r[,"Total_Q1"]) 
colnames(indicator_plot) <- c("Date","Weighted","Adjusted")#,"Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Retail: Q1") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Retail[,c("Datum","Q2A")],ad_r[,"Total_Q2A"])#,pub_r[,"Total_Q2A"]) 
colnames(indicator_plot) <- c("Date","Weighted","Adjusted")#,"Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("Retail: Q2A") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(Retail[,c("Datum","Q3A")],ad_r[,"Total_Q3A"])#,pub_r[,"Total_Q3A"]) 
colnames(indicator_plot) <- c("Date","Weighted","Adjusted")#,"Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Retail: Q3A") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))

indicator_plot <- cbind(Retail[,c("Datum","Q8")],ad_r[,"Total_Q8"])#,pub_r[,"Total_Q8"]) 
colnames(indicator_plot) <- c("Date","Weighted","Adjusted")#,"Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Retail: Q8") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

```{r figure32, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Regional Retail compared to the published series"}
indicator_plot <- cbind(WC.R[,c("Datum","Q2A")],ad_r[,"WC_Q2A"])#,pub_r[,"WC_Q2A"]) 
colnames(indicator_plot) <- c("Date","Microdata","Adjusted")#,"Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("WC: Q2A") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(GP.R[,c("Datum","Q2A")],ad_r[,"GP_Q2A"])#,pub_r[,"GP_Q2A"]) 
colnames(indicator_plot) <- c("Date","Microdata","Adjusted")#,"Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("GP: Q2A") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(KZN.R[,c("Datum","Q2A")],ad_r[,"KZN_Q2A"])#,pub_r[,"KZN_Q2A"]) 
colnames(indicator_plot) <- c("Date","Microdata","Adjusted")#,"Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("KZN: Q2A") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))

indicator_plot <- cbind(WC.R[,c("Datum","Q2A")],GP.R[,c("Q2A")],KZN.R[,c("Q2A")]) 
colnames(indicator_plot) <- c("Date","WC","GP","KZN")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Regions: Q2A") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

####New Indicators
This section compares the microdata results using the three different weighting procedures. Figure 33 illustrates the comparison for Total Retail for a selection of questions, comparing the three main weighting procedures. Figure 34 compares the results for a selection of the new Retail subsector classifications, using the three weighting procedures. The new weights produce series that are less volatile than the old series.

```{r figure33, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Total Retail series using different weights"}
indicator_plot <- cbind(Retail[,c("Datum","Q1")],
                        Retail_n[,c("Q1")],Retail_2[,c("Q1")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Q1") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Retail[,c("Datum","Q2A")],
                        Retail_n[,c("Q2A")],Retail_2[,c("Q2A")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("Q2A") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(Retail[,c("Datum","Q3A")],
                        Retail_n[,c("Q3A")],Retail_2[,c("Q3A")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Q3A") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom")

indicator_plot <- cbind(Retail[,c("Datum","Q9")],
                        Retail_n[,c("Q9")],Retail_2[,c("Q9")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Q9") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom")
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

```{r figure34, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Retail subsectors using different weights"}
indicator_plot <- cbind(Retaild[,c("Datum","Q2A")],
                        Retaild_n[,c("Q2A")],Retaild_2[,c("Q2A")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Q2A: Durable") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Retailnd[,c("Datum","Q2A")],
                        Retailnd_n[,c("Q2A")],Retailnd_2[,c("Q2A")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("Q2A: Non-Durable") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(Retailsd[,c("Datum","Q2A")],
                        Retailsd_n[,c("Q2A")],Retailnd_2[,c("Q2A")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Q2A: Semi-Durable") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom")

indicator_plot <- cbind(Hardware[,c("Datum","Q2A")],
                        Hardware_n[,c("Q2A")],Hardware_2[,c("Q2A")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Q2A: Hardware") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom")
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

###Reference Series
This section compares the series to their respective reference series. Stats SA and the SARB calculate series for total retail sales, but the old retail series ceased in 2003 and only resumed again in 2008 (constant prices). George used additional data to fill in this gap, to create a continuous complete reference series, at least for total retail sales. Unfortunately, we do not have a complete reference series for the subsectors, which complicates the comparison and the evaluation of the tracking record. The "other" component is not allocated to the durable, semi-durable and non-durable sectors, as it does not have a large impact on the growth rates of the components.

Figure 35 compares the Total Retail activity series (Q2A and Q3A) to the SARB and Stats SA reference series. Table 16 reports the contemporaneous correlations between the series. The correlations are generally relatively high and significant. This significant positive correlation is confirmed by the cross-correlations illustrated in Figure 36. The new weights also seem to improve the tracking record of the balance statistics, compared to the old weights from the published series.

```{r figure35, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Total Retail compared to the reference series"}
indicator_plot <- cbind(Retail_n[,c("Datum","Q2A","Q3A")],ref_r[,c("Total_SARB","Total_StatsSA")]) 
colnames(indicator_plot)[1] <- c("Date")#,"Microdata","Published")
indicator_plot[,-1] <- scale(indicator_plot[,-1])
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g <- g + geom_line()
g <- g + ylab("Indicator") + xlab("")
#g <- g + ggtitle("Retail Reference Series")
g <- g + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g <- g + theme(legend.title=element_blank()) 
g <- g + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g <- g + theme(legend.position="bottom")
g
```

\begin{table}[ht]
\centering
\caption{Correlations of retail series}
\scalebox{0.8}{
\begin{tabular}{|r|llll|llll|}
  \hline
 & Q2A & Q2A\_u & Q2A\_new & Q2A\_2s & Q3A & Q3A\_u & Q3A\_new & Q3A\_2s \\ 
  \hline
Total\_SARB &  0.71*** &  0.76*** &  0.74*** &  0.77*** &  0.51*** &  0.57*** &  0.52*** &  0.59*** \\ 
  Total\_StatsSA &  0.69*** &  0.74*** &  0.73*** &  0.75*** &  0.56*** &  0.57*** &  0.55*** &  0.60*** \\ 
   \hline
\end{tabular}
}
\end{table}

```{r figure36, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Retail cross-correlations to the reference series"}
retail_trade <- cbind(Retail[,c("Q2A","Q3A")],Retail_u[,c("Q2A","Q3A")],
                      Retail_n[,c("Q2A","Q3A")],Retail_2[,c("Q2A","Q3A")],
                      ref_r[,c("Total_SARB","Total_StatsSA")]) 
colnames(retail_trade) <- c("Q2A","Q3A","Q2A_u","Q3A_u","Q2A_new","Q3A_new",
                            "Q2A_2s","Q3A_2s","Total_SARB","Total_StatsSA")

Q2A <- retail_trade[,1]
Q2A_u <- retail_trade[,3] 
Q2A_n <- retail_trade[,5] 
Q2A_2s <- retail_trade[,7] 
Sales_StatsSA <- retail_trade[,10]

par(mfrow=c(2,2))
ccf(Q2A, Sales_StatsSA, na.action = na.pass, ylim=c(-0.2, 0.8))
ccf(Q2A_u, Sales_StatsSA, na.action = na.pass, ylim=c(-0.2, 0.8))
ccf(Q2A_n, Sales_StatsSA, na.action = na.pass, ylim=c(-0.2, 0.8))
ccf(Q2A_2s, Sales_StatsSA, na.action = na.pass, ylim=c(-0.2, 0.8))
```

Figure 37 compares the three retail subsectors to their reference series. Notice that there are missing values in the reference series between 2003 and 2008, which confounds the comparison to some extent. Nevertheless, Table 17 reports that the correlations for Durable and Semi-Durable goods are still relatively high and significant. The new weights again seem to improve this tracking record, even to the point where one of the series for Non-Durable goods has a somewhat significant positive correlation to its erratic reference series.

```{r figure37, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Retail subsectors compared to the reference series"}
indicator_plot <- cbind(Retaild[,c("Datum","Q2A","Q3A")],ref_r[,c("Durable")])
indicator_plot[,-1] <- scale(indicator_plot[,-1])
colnames(indicator_plot) <- c("Date","Q2A","Q3A","StatsSA")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Durable Goods") + theme(plot.title = element_text(hjust = 0.5))
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Retailsd[,c("Datum","Q2A","Q3A")],ref_r[,c("Semi")])
indicator_plot[,-1] <- scale(indicator_plot[,-1])
colnames(indicator_plot) <- c("Date","Q2A","Q3A","StatsSA")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("Semi-Durable Goods") + theme(plot.title = element_text(hjust = 0.5))
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(Retailnd[,c("Datum","Q2A","Q3A")],ref_r[,c("NonD")])
indicator_plot[,-1] <- scale(indicator_plot[,-1])
colnames(indicator_plot) <- c("Date","Q2A","Q3A","StatsSA")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Non-Durable Goods") + theme(plot.title = element_text(hjust = 0.5))
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))

library(gridExtra)
grid.arrange(g1, g2, g3, ncol=2, nrow =2)
```

\begin{table}[ht]
\centering
\caption{Correlations of Retail subsector series} 
\scalebox{0.8}{
\begin{tabular}{|r|lll|lll|}
  \hline
 & Q2A & Q2A\_n & Q2A\_2s & Q3A & Q3A\_n & Q3A\_2s \\ 
  \hline
Durable Goods &  0.57*** &  0.60*** &  0.61*** &  0.61*** &  0.61*** &  0.61*** \\ 
  Semi-Durable Goods &  0.43*** &  0.51*** &  0.49*** &  0.46*** &  0.49*** &  0.47*** \\ 
  Non-Durable Goods &  0.13  &  0.25**  &  0.28**  & -0.14  & -0.09  & -0.06  \\ 
   \hline
\end{tabular}
}
\end{table}

###Optimum Weights
In this section we investigate whether there are more optimum weights that can be used to combine the retail subsector series, in order to improve the tracking record of the total retail series. We briefly investigate three possibilities. The first is to combine the subsector series using simple averages (i.e. equal weights). The second is to use principal components analysis to combine the series. PCA is used to reduce the dimensionality of a dataset consisting of a large number of variables, while retaining as much of the variation as possible [@Jolliffe2002]. The transformation is defined in such a way that the first principal component accounts for as much of the variability in the data as possible. We therefore use the first principal component as a combined measure of the total retail series. The third possibility is to use regression analysis to calculate a predicted series for total retail.

Table 18 reports the results from the regression analysis using the complete subsector series. The results show that most contemporaneous sector series are not significant, due to their high standard errors. Only subsectors 3160 exhibits a significant positive coefficient. Subsectors 3310, 3160 and 3230 receive the largest weights, while one sector (3130) has a slightly negative weight.

```{r tablereg, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE}
#New 2-step weighting 
BER.R2 <- read.csv("Retail_new faktor_sep.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
colnames(BER.R2)[1:8] <- c("region","id","sector","weight","firmw","sectorw","factor","surveyQ")
BER.R2$surveyQ <- toupper(BER.R2$surveyQ)
BER.R2$sector <- factor(BER.R2$sector) #could include labels
BER.R2$id <- factor(BER.R2$id)

BER.R2$firmw <- as.numeric(as.character(BER.R2$firmw))
BER.R2$sectorw <- as.numeric(as.character(BER.R2$sectorw))
BER.R2$factor <- as.numeric(as.character(BER.R2$factor))    

#Clean SurveyQ variable
BER.R2$temp <- NULL
for(i in 1:nrow(BER.R2)) {
    ifelse(substr(BER.R2$surveyQ[i], 1, 1)==9, 
           BER.R2$temp[i] <- paste0("19",BER.R2$surveyQ[i],sep=""),
           BER.R2$temp[i] <- paste0("20",BER.R2$surveyQ[i],sep=""))
}
BER.R2$surveyQ <- BER.R2$temp
BER.R2 <- BER.R2[,-ncol(BER.R2)]
BER.R2$surveyQ <- factor(BER.R2$surveyQ)

#Clean regions
foute <- c("1997Q2")#,"2000Q3","2000Q4","2001Q1")
korrek <- c("1996Q1","1996Q2","1996Q3","1996Q4","1997Q1",
            "1997Q3","1997Q4","1998Q1","1998Q2","1998Q3",
            "1998Q4")#,"2004Q1","2004Q2","2004Q3","2004Q4",
#"2005Q1","2005Q2","2005Q3","2006Q1","2006Q2","2006Q3","2006Q4")
for(i in levels(BER.R2$id)) {
    if(!is.na(Mode(BER.R2$region[(BER.R2$surveyQ %in% korrek) & (BER.R2$id == i)]))) {
        BER.R2$region[(BER.R2$surveyQ %in% foute) & (BER.R2$id == i)] <- Mode(BER.R2$region[(BER.R2$surveyQ %in% korrek) & (BER.R2$id == i)]) 
    }
}
BER.R2$region <- factor(BER.R2$region)

BER.R2 <- BER.R2[BER.R2$Latecomer == FALSE | is.na(BER.R2$Latecomer),]
BER.R2 <- BER.R2[,1:23]
BER.R2 <- BER.R2[,!grepl("X",colnames(BER.R2))]    

for(i in 9:23) {
    BER.R2[,i] <- replace(BER.R2[,i], BER.R2[,i]==2, 0)
    BER.R2[,i] <- replace(BER.R2[,i], BER.R2[,i]==3,-1)
}

#Maak factor reg
Ej <- aggregate(BER.R2$firmw, by=list(BER.R2$surveyQ,BER.R2$sector), FUN=sum)
BER.R2 <-  merge(BER.R2, Ej, by.x=c("surveyQ","sector"), by.y=c("Group.1","Group.2"),all = TRUE)
BER.R2$factor <- BER.R2$factor/BER.R2$x*100
BER.R2 <- BER.R2[,c(3,4,2,5:8,1,9:23)]

geweeg2 <- function(sektor=all_r,streek=streke) {
    weeg2 <- function(temp) {  
        sectorw=temp$sectorw[1]
        temp <- cbind(firmw=temp$firmw,temp$firmw*temp[(match("surveyQ",colnames(temp))+1):ncol(temp)])
         temp <- colSums(temp, na.rm=TRUE, dims = 1)/    
            sapply(colnames(temp), function(x) sum(temp$firmw[!is.na(temp[colnames(temp) == x])]))
        temp <- c(sectorw,temp)
        #weight only by those that responded to a specific question
        return(temp)
    }
    man <- BER.R2[BER.R2$sector %in% sektor & BER.R2$region %in% streek,-24]
    sector <- data.frame()
    for(kwartaal in levels(man$surveyQ)) {
        sector <- rbind(sector,weeg2(man[man$surveyQ==kwartaal,]))
    }
    sector <- sector *100
    sector[,2] <- levels(man$surveyQ)
    colnames(sector) <- colnames(man)[c(7:ncol(man))]
    sector <- merge(datums,sector, by.x="Date", by.y="surveyQ", all=TRUE)
    #sector <- as.data.frame(t(sapply(levels(man$surveyQ), function(kwartaal) weeg(man[man$surveyQ==kwartaal,]))))
    sector[,3:18] <- na.approx(sector[,3:18],na.rm = FALSE)
    return(sector)
}

sektor <- all_r
lys <- list()
t <- 0
for(k in sektor) {
    t <- t+1
    lys[[t]] <- geweeg2(k)
}
    
saam <- lys[[1]]
for(t in 1:length(sektor)) {
    saam[,t+2] <- lys[[t]][,5]
}
colnames(saam)[-1:-2] <- sektor
saam <- saam[-1,]

saam$Retail_ref <- ref_r$Total_StatsSA
saam1 <- saam[,c(-1:-2,-5,-14,-16:-23)]
saam1 <- saam1[complete.cases(saam1),]

m1 <- lm(Retail_ref ~ ., data = saam1)
#stargazer(m1, header=FALSE)
```


\begin{table}[!h] \centering 
  \caption{Regression output} 
  \label{} 
  \scalebox{0.8}{
\begin{tabular}{@{\extracolsep{5pt}}lc} 
\\[-2.8ex]\hline 
\hline \\[-1.8ex] 
 & \multicolumn{1}{c}{\textit{Dependent variable:}} \\ 
\cline{2-2} 
\\[-1.8ex] & Retail\_ref \\ 
\hline \\[-1.8ex] 
 `3310` & 0.015 (0.012) \\ 
  `3160` & 0.023$^{**}$ (0.012) \\ 
  `3230` & 0.027 (0.017) \\ 
  `3120` & 0.007 (0.008) \\ 
  `3330` & 0.011 (0.012) \\ 
  `3130` & $-$0.0002 (0.006) \\ 
  `3140` & 0.005 (0.009) \\ 
  `3220` & 0.003 (0.017) \\ 
  `3370` & 0.003 (0.010) \\ 
  `3210` & 0.008 (0.007) \\ 
  `3110` & 0.011 (0.012) \\ 
  Constant & 6.257$^{***}$ (0.504) \\ 
 \hline \\[-1.8ex] 
Observations & 99 \\ 
R$^{2}$ & 0.576 \\ 
Adjusted R$^{2}$ & 0.523 \\ 
Residual Std. Error & 2.815 (df = 87) \\ 
F Statistic & 10.759$^{***}$ (df = 11; 87) \\ 
\hline 
\hline \\[-1.8ex] 
\textit{Note:}  & \multicolumn{1}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\ 
\end{tabular} }
\end{table} 

Figure 38 illustrates these series along with the total retail sales reference series from Stats SA. The three methods seem to produce very similar results to the series derived with the new survey results. Table 19 reports that they have high correlations with one another. They also improve the tracking record with the reference series to some degree, as expected. Nevertheless, our new weights and the 2-step weighting procedure seem to be an adequate way of summarising the survey responses in this case.

```{r figure38, echo=FALSE, warning=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Retail subsectors compared to the reference series"}
#plot(predict(m1))
Fitted <- predict(m1)
Average <- rowMeans(saam1[,1:11])
un <- scale(saam1[,1:11])
PCA <- princomp(un)$scores[,1]*-1
Reference <- saam1$Retail_ref

BERplot1 <- cbind(Retail_2[-1:-2,c(1,5)],Reference,Fitted,Average,PCA)
BERplot1$Date <- as.Date(as.yearqtr(BERplot1$Date, format = "%YQ%q"))
BERplot1[,-1] <- scale(BERplot1[,-1])
index_plot <- melt(BERplot1, id="Date")
g <- ggplot(data=index_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g <- g + geom_line()
g <- g + ylab("Indicator") + xlab("")
g <- g + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g <- g + theme(legend.title=element_blank()) 
g <- g + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g <- g + theme(legend.position="bottom")
g
```

\begin{table}[ht]
\centering
\caption{Correlations between the Total Retail Series} 
\scalebox{0.8}{
\begin{tabular}{|r|llll|}
  \hline
 & Reference & Q2A & Fitted & Average \\ 
  \hline
  Q2A     &  0.61*** &         &         &  \\ 
  Fitted  &  0.76*** & 0.65*** &         &  \\ 
  Average &  0.73*** & 0.62*** & 0.96*** &  \\ 
  PCA     &  0.75*** & 0.65*** & 0.98*** &  0.99*** \\ 
   \hline
\end{tabular}
}
\end{table}

###Volatility
Finally, we can compare the series in terms of volatility. Table 20 reports the volatilities of the series over time. The new weights and weighting procedures again produce balance series that are substantially less volatile than the original series.

\begin{table}[ht]
\centering
\caption{Volatility of Retail series} 
\scalebox{0.8}{
\begin{tabular}{|r|rrr|rrr|}
  \hline
 & Q2A & Q2A\_New & Q2A\_2s & Q3A & Q3A\_New & Q3A\_2s \\ 
  \hline
Total Retail & 31.16 & 24.51 & 24.43 & 25.78 & 21.40 & 21.01 \\ 
  Durable Goods & 36.66 & 30.79 & 30.07 & 33.91 & 27.55 & 27.90 \\ 
  Semi-Durable Goods & 44.38 & 32.17 & 31.26 & 38.55 & 29.68 & 29.30 \\ 
  Non-Durable Goods & 35.68 & 25.20 & 24.73 & 29.65 & 21.86 & 21.18 \\ 
   \hline
\end{tabular}
}
\end{table}

\newpage
##The Wholesale Survey
```{r W.whole, echo=FALSE, results='hide', message=FALSE, warning=FALSE, cache = TRUE}
pub_w <- read.csv("Wholesale_BER_Published.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
#ref_w <- read.csv("Ref Series_Wholesale.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
ad_w <- read.csv("Wholesale_Adjustment.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
ad_w[,-1] <- ad_w[,-1]+pub_w[,-1]


#-------------------
#WHOLESALE
BER.W <- read.csv("Wholesale_92Q2-17Q2.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
colnames(BER.W)[1:6] <- c("region","id","sector","weight","factor","surveyQ")
BER.W$surveyQ <- toupper(BER.W$surveyQ)
BER.W$sector <- factor(BER.W$sector) #could include labels
BER.W$id <- factor(BER.W$id)
BER.W$region <- factor(BER.W$region)

#Clean SurveyQ variable
BER.W$temp <- NULL
for(i in 1:nrow(BER.W)) {
    ifelse(substr(BER.W$surveyQ[i], 1, 1)==9, 
           BER.W$temp[i] <- paste0("19",BER.W$surveyQ[i],sep=""),
           BER.W$temp[i] <- paste0("20",BER.W$surveyQ[i],sep=""))
}
BER.W$surveyQ <- BER.W$temp
BER.W <- BER.W[,-ncol(BER.W)]
BER.W$surveyQ <- factor(BER.W$surveyQ)

BER.W <- BER.W[BER.W$Latecomer == FALSE | is.na(BER.W$Latecomer),]
BER.W <- BER.W[,1:21]
BER.W <- BER.W[,!grepl("X",colnames(BER.W))]    

for(i in 7:21) {
    BER.W[,i] <- replace(BER.W[,i], BER.W[,i]==2, 0)
    BER.W[,i] <- replace(BER.W[,i], BER.W[,i]==3,-1)
}
#New faktor variable 
BER.Wn <- read.csv("Wholesale_new faktor.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
colnames(BER.Wn)[1:6] <- c("region","id","sector","weight","factor","surveyQ")
BER.Wn$surveyQ <- toupper(BER.Wn$surveyQ)
BER.Wn$sector <- factor(BER.Wn$sector) #could include labels
BER.Wn$id <- factor(BER.Wn$id)

#Clean SurveyQ variable
BER.Wn$temp <- NULL
for(i in 1:nrow(BER.Wn)) {
    ifelse(substr(BER.Wn$surveyQ[i], 1, 1)==9, 
           BER.Wn$temp[i] <- paste0("19",BER.Wn$surveyQ[i],sep=""),
           BER.Wn$temp[i] <- paste0("20",BER.Wn$surveyQ[i],sep=""))
}
BER.Wn$surveyQ <- BER.Wn$temp
BER.Wn <- BER.Wn[,-ncol(BER.Wn)]
BER.Wn$surveyQ <- factor(BER.Wn$surveyQ)
BER.Wn$region <- factor(BER.Wn$region)

BER.Wn <- BER.Wn[BER.Wn$Latecomer == FALSE | is.na(BER.Wn$Latecomer),]
BER.Wn <- BER.Wn[,1:21]
BER.Wn <- BER.Wn[,!grepl("X",colnames(BER.Wn))]    

for(i in 7:21) {
    BER.Wn[,i] <- replace(BER.Wn[,i], BER.Wn[,i]==2, 0)
    BER.Wn[,i] <- replace(BER.Wn[,i], BER.Wn[,i]==3,-1)
}

#--------------------
#New 2-step weighting 
BER.W2 <- read.csv("Wholesale_new faktor_sep.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
colnames(BER.W2)[1:8] <- c("region","id","sector","weight","firmw","sectorw","factor","surveyQ")
BER.W2$surveyQ <- toupper(BER.W2$surveyQ)
BER.W2$sector <- factor(BER.W2$sector) #could include labels
BER.W2$id <- factor(BER.W2$id)

BER.W2$firmw <- as.numeric(as.character(BER.W2$firmw))
BER.W2$sectorw <- as.numeric(as.character(BER.W2$sectorw))
BER.W2$factor <- as.numeric(as.character(BER.W2$factor))    

#Clean SurveyQ variable
BER.W2$temp <- NULL
for(i in 1:nrow(BER.W2)) {
    ifelse(substr(BER.W2$surveyQ[i], 1, 1)==9, 
           BER.W2$temp[i] <- paste0("19",BER.W2$surveyQ[i],sep=""),
           BER.W2$temp[i] <- paste0("20",BER.W2$surveyQ[i],sep=""))
}
BER.W2$surveyQ <- BER.W2$temp
BER.W2 <- BER.W2[,-ncol(BER.W2)]
BER.W2$surveyQ <- factor(BER.W2$surveyQ)
BER.W2$region <- factor(BER.W2$region)

BER.W2 <- BER.W2[BER.W2$Latecomer == FALSE | is.na(BER.W2$Latecomer),]
BER.W2 <- BER.W2[,1:23]
BER.W2 <- BER.W2[,!grepl("X",colnames(BER.W2))]    

for(i in 9:23) {
    BER.W2[,i] <- replace(BER.W2[,i], BER.W2[,i]==2, 0)
    BER.W2[,i] <- replace(BER.W2[,i], BER.W2[,i]==3,-1)
}

#Maak factor reg
Ej <- aggregate(BER.W2$firmw, by=list(BER.W2$surveyQ,BER.W2$sector), FUN=sum)
BER.W2 <-  merge(BER.W2, Ej, by.x=c("surveyQ","sector"), by.y=c("Group.1","Group.2"),all = TRUE)
BER.W2$factor <- BER.W2$factor/BER.W2$x*100
BER.W2 <- BER.W2[,c(3,4,2,5:8,1,9:23)]


#WHOLESALE
wholenc <- c(2120,2110,2130,2140)
wholec <- c(2250,2220,2230,2240,2210,2270,2260)
all_w <- as.numeric(as.character(unique(BER.W$sector)))
#streke <- unique(BER.W$region)

#WHOLESALE
Wholesale <- geweeg(BER.W,all_w,streke,2:102)
Wholesale_u <- ongeweeg(BER.W,all_w,streke,2:102)
Wholec <- geweeg(BER.W,wholec,streke,2:102)
Wholenc <- geweeg(BER.W,wholenc,streke,2:102)
WC.W <- geweeg(BER.W,all_w,1,2:102)
GP.W <- geweeg(BER.W,all_w,6,2:102)
KZN.W <- geweeg(BER.W,all_w,5,2:102)

Wholesale[3,c(4,seq(5,17,by=2),18)] <- ad_w[3,2:10]
Wholesale[6,c(4,seq(5,17,by=2),18)] <- ad_w[6,2:10]
Wholesale[55,c(4,seq(5,17,by=2),18)] <- ad_w[55,2:10]
Wholec[3,c(4,seq(5,17,by=2),18)] <- ad_w[3,11:19]
Wholec[6,c(4,seq(5,17,by=2),18)] <- ad_w[6,11:19]
Wholec[55,c(4,seq(5,17,by=2),18)] <- ad_w[55,11:19]
Wholenc[3,c(4,seq(5,17,by=2),18)] <- ad_w[3,20:28]
Wholenc[6,c(4,seq(5,17,by=2),18)] <- ad_w[6,20:28]
Wholenc[55,c(4,seq(5,17,by=2),18)] <- ad_w[55,20:28]
WC.W[55,c(4,seq(5,17,by=2),18)] <- ad_w[55,29:37]
GP.W[55,c(4,seq(5,17,by=2),18)] <- ad_w[55,38:46]
KZN.W[55,c(4,seq(5,17,by=2),18)] <- ad_w[55,47:55]

#New faktor
Wholesale_n <- geweeg(BER.Wn,all_w,streke,2:102)
Wholec_n <- geweeg(BER.Wn,wholec,streke,2:102)
Wholenc_n <- geweeg(BER.Wn,wholenc,streke,2:102)
WC.W_n <- geweeg(BER.Wn,all_w,1,2:102)
GP.W_n <- geweeg(BER.Wn,all_w,6,2:102)
KZN.W_n <- geweeg(BER.Wn,all_w,5,2:102)

Wholesale_n[3,c(4,seq(5,17,by=2),18)] <- ad_w[3,2:10]
Wholesale_n[6,c(4,seq(5,17,by=2),18)] <- ad_w[6,2:10]
Wholesale_n[55,c(4,seq(5,17,by=2),18)] <- ad_w[55,2:10]
Wholec_n[3,c(4,seq(5,17,by=2),18)] <- ad_w[3,11:19]
Wholec_n[6,c(4,seq(5,17,by=2),18)] <- ad_w[6,11:19]
Wholec_n[55,c(4,seq(5,17,by=2),18)] <- ad_w[55,11:19]
Wholenc_n[3,c(4,seq(5,17,by=2),18)] <- ad_w[3,20:28]
Wholenc_n[6,c(4,seq(5,17,by=2),18)] <- ad_w[6,20:28]
Wholenc_n[55,c(4,seq(5,17,by=2),18)] <- ad_w[55,20:28]
WC.W_n[55,c(4,seq(5,17,by=2),18)] <- ad_w[55,29:37]
GP.W_n[55,c(4,seq(5,17,by=2),18)] <- ad_w[55,38:46]
KZN.W_n[55,c(4,seq(5,17,by=2),18)] <- ad_w[55,47:55]

#2-step
Wholesale_2 <- geweeg(BER.W2,all_w,streke,2:102)
Wholec_2 <- geweeg(BER.W2,wholec,streke,2:102)
Wholenc_2 <- geweeg(BER.W2,wholenc,streke,2:102)
WC.W_2 <- geweeg(BER.W2,all_w,1,2:102)
GP.W_2 <- geweeg(BER.W2,all_w,6,2:102)
KZN.W_2 <- geweeg(BER.W2,all_w,5,2:102)

Wholesale_2[3,c(4,seq(5,17,by=2),18)] <- ad_w[3,2:10]
Wholesale_2[6,c(4,seq(5,17,by=2),18)] <- ad_w[6,2:10]
Wholesale_2[55,c(4,seq(5,17,by=2),18)] <- ad_w[55,2:10]
Wholec_2[3,c(4,seq(5,17,by=2),18)] <- ad_w[3,11:19]
Wholec_2[6,c(4,seq(5,17,by=2),18)] <- ad_w[6,11:19]
Wholec_2[55,c(4,seq(5,17,by=2),18)] <- ad_w[55,11:19]
Wholenc_2[3,c(4,seq(5,17,by=2),18)] <- ad_w[3,20:28]
Wholenc_2[6,c(4,seq(5,17,by=2),18)] <- ad_w[6,20:28]
Wholenc_2[55,c(4,seq(5,17,by=2),18)] <- ad_w[55,20:28]
WC.W_2[55,c(4,seq(5,17,by=2),18)] <- ad_w[55,29:37]
GP.W_2[55,c(4,seq(5,17,by=2),18)] <- ad_w[55,38:46]
KZN.W_2[55,c(4,seq(5,17,by=2),18)] <- ad_w[55,47:55]
```

```{r table21, echo=FALSE, results='asis', warning=FALSE, message=FALSE, cache = TRUE}
ave <- mean(aggregate(BER.W$id, by=list(BER.W$surveyQ), FUN = length)[,2])
tafel <- cbind("1992Q2-2017Q2",length(BER.W$id),round(ave,2),
               "1992Q4,1993Q3,2005Q4")
colnames(tafel) <- c("Sample","Total Obs","Obs/Quarter","Missing Quarters")     
row.names(tafel) <- "Wholesale Survey"
xt <- xtable(tafel, caption="Sample characteristics")
print(xt, "latex",comment=FALSE, caption.placement = getOption("xtable.caption.placement", "top"), scalebox = 0.8,
      include.rownames=TRUE)
```

\begin{table}[]
\centering
\caption{Wholesale Sector Codes}
\label{my-label}
\scalebox{0.8}{
\begin{tabular}{|l|l|}
\hline
\textbf{Sector}    & \textbf{Code}                                                                      \\ \hline
Non-Consumer Goods & 2120, 2110, 2130, 2140                                                             \\ \hline
Consumer Goods     & \begin{tabular}[c]{@{}l@{}}2250, 2220, 2230, 2240,\\ 2210, 2270, 2260\end{tabular} \\ \hline
\end{tabular}}
\end{table}

```{r figure39, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Number of respondents in the wholesale sector (1992Q2-2017Q2)"}
BERplot <- BER.W
BERplot$Sector[BERplot$sector %in% wholenc] <- "Wholesale (non-consumer)" 
BERplot$Sector[BERplot$sector %in% wholec] <- "Wholesale (consumer)"  
BERplot$sectorw <- BERplot$factor/BERplot$weight

BERplot1 <- aggregate(BERplot$id, by=list(BERplot$surveyQ,BERplot$Sector), FUN = length)
BERplot1$Group.1 <- as.Date(as.yearqtr(BERplot1$Group.1, format = "%YQ%q"))
g <- ggplot(BERplot1, aes(x=Group.1, y=x,fill=Group.2))
g <- g + geom_bar(stat="identity")
g <- g + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g <- g + scale_fill_discrete(name="Subsector")
g <- g + scale_y_continuous(labels=comma)
g <- g + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g <- g + ylab("Number of Respondents")
g <- g + xlab(" ")
g
```

###The Wholesale Indicators
Similar to the Manufacturing and Retail surveys we have created three versions of the balance statistics for all of the questions. The baseline balance statistics are calculated in the same way as the normal BER procedure. The second set of indicators is based on a new 4-part firm classification, although in the case of wholesale none of the firms are classified as large (category 4). The final set of indicators is based on the two-step weighting procedure, using the new 4-part firm size weights. 

####Published Series
In this section the published results are compared to the balances calculated with the microdata. Similar to the Retail surveys, however, the comparison is complicated by the revisions to the published results in 1997Q1 and 2008Q3. To make a comparison, the adjustment factors were again subtracted from the published series for comparison to the microdata. The adjustment factors are available in the Excel files on Dropbox. 

Figure 40 illustrates the results for a selection of questions for total wholesale, consumer and non-consumer goods. In this case, the adjustments were relatively minor and the series seem to correspond well to the published data, except for a few minor deviations. Figure 41 illustrates the comparisons for the three main regions. The series are very similar, especially after 2001. The microdata therefore seems to correspond to the published series, and the microdata therefore seems to be correct.

```{r figure40, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Wholesale subsectors compared to the published series"}
indicator_plot <- cbind(Wholesale[,c("Datum","Q1")],ad_w[,"Total_Q1"],pub_w[,"Total_Q1"]) 
colnames(indicator_plot) <- c("Date","Weighted","Adjusted","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Total Wholesale: Q1") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Wholesale[,c("Datum","Q2A")],ad_w[,"Total_Q2A"],pub_w[,"Total_Q2A"]) 
colnames(indicator_plot) <- c("Date","Weighted","Adjusted","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("Indicator") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("Total Wholesale: Q2A") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="bottom")

indicator_plot <- cbind(Wholec[,c("Datum","Q2A")],ad_w[,"CG_Q2A"],pub_w[,"CG_Q2A"]) 
colnames(indicator_plot) <- c("Date","Weighted","Adjusted","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Wholesale Consumer Goods: Q3A") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom")

indicator_plot <- cbind(Wholenc[,c("Datum","Q2A")],ad_w[,"NonCG_Q2A"],pub_w[,"NonCG_Q2A"]) 
colnames(indicator_plot) <- c("Date","Weighted","Adjusted","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Non-Consumer Goods: Q2A") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g4 <- g4 + theme(legend.position="none")

library(gridExtra)
grid.arrange(g1, g4, g3, g2, ncol=2, nrow =2)
```

```{r figure41, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Wholesale regions compared to the published series"}
indicator_plot <- cbind(WC.W[,c("Datum","Q2A")],ad_w[,"WC_Q2A"])#,pub_w[,"WC_Q2A"]) 
colnames(indicator_plot) <- c("Date","Microdata","Adjusted")#,"Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("WC: Q2A") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(GP.W[,c("Datum","Q2A")],ad_w[,"GP_Q2A"])#,pub_w[,"GP_Q2A"]) 
colnames(indicator_plot) <- c("Date","Microdata","Adjusted")#,"Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("GP: Q2A") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(KZN.W[,c("Datum","Q2A")],ad_w[,"KZN_Q2A"])#,pub_w[,"KZN_Q2A"]) 
colnames(indicator_plot) <- c("Date","Microdata","Adjusted")#,"Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("KZN: Q2A") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))

indicator_plot <- cbind(WC.W[,c("Datum","Q2A")],GP.W[,c("Q2A")],KZN.W[,c("Q2A")]) 
colnames(indicator_plot) <- c("Date","WC","GP","KZN")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Regions: Q2A") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

####New Indicators
This section compares the microdata results using the three different weighting procedures. Figure 42 illustrates the comparison for Total Wholesale for a selection of questions, comparing the three main weighting procedures. Figure 43 compares the results for a selection of the new Wholesale subsector classifications, using the three weighting procedures. The new weights produce series that are less volatile than the old series.

```{r figure42, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Total Wholesale series using different weights"}
indicator_plot <- cbind(Wholesale[,c("Datum","Q1")],
                        Wholesale_n[,c("Q1")],Wholesale_2[,c("Q1")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Q1") + theme(plot.title = element_text(hjust = 0.5))
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Wholesale[,c("Datum","Q2A")],
                        Wholesale_n[,c("Q2A")],Wholesale_2[,c("Q2A")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("Q2A") + theme(plot.title = element_text(hjust = 0.5))
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(Wholesale[,c("Datum","Q3A")],
                        Wholesale_n[,c("Q3A")],Wholesale_2[,c("Q3A")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Q3A") + theme(plot.title = element_text(hjust = 0.5))
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))

indicator_plot <- cbind(Wholesale[,c("Datum","Q9")],
                        Wholesale_n[,c("Q9")],Wholesale_2[,c("Q9")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Q9") + theme(plot.title = element_text(hjust = 0.5))
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

```{r figure43, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Wholesale subsectors using different weights"}
indicator_plot <- cbind(Wholec[,c("Datum","Q1")],
                        Wholec_n[,c("Q1")],Wholec_2[,c("Q1")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Q1: Wholesale (c)") + theme(plot.title = element_text(hjust = 0.5))
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Wholec[,c("Datum","Q2A")],
                        Wholec_n[,c("Q2A")],Wholec_2[,c("Q2A")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("Q2A: Wholesale (c)") + theme(plot.title = element_text(hjust = 0.5))
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(Wholenc[,c("Datum","Q1")],
                        Wholenc_n[,c("Q1")],Wholenc_2[,c("Q1")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Q1: Wholesale (nc)") + theme(plot.title = element_text(hjust = 0.5))
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))

indicator_plot <- cbind(Wholenc[,c("Datum","Q2A")],
                        Wholenc_n[,c("Q2A")],Wholenc_2[,c("Q2A")])
colnames(indicator_plot) <- c("Date","Microdata","New","2-step")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Q2A: Wholesale (nc)") + theme(plot.title = element_text(hjust = 0.5))
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

###Reference Series
We still need to choose reference series for the wholesale sector. The Wholesale sector data is only available in current prices since 2005. Stats SA's sector classification has a large "other" component, which may have a large impact on the growth rates. Once we have chosen reference series we can evaluate the wholesale series in terms of tracking record and volatility. 

##The Motor Vehicle Survey
```{r V.motor, echo=FALSE, results='hide', message=FALSE, warning=FALSE, cache = TRUE}
pub_v <- read.csv("Motor_BER_Published.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
ref_v <- read.csv("Ref Series_Vehicles.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)

#MOTOR VEHICLES
BER.V <- read.csv("Motor_92Q2-17Q2.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
colnames(BER.V)[1:6] <- c("region","id","sector","weight","factor","surveyQ")
BER.V$surveyQ <- toupper(BER.V$surveyQ)
BER.V$sector <- factor(BER.V$sector) #could include labels
BER.V$id <- factor(BER.V$id)
BER.V$region <- factor(BER.V$region)

#Clean SurveyQ variable
BER.V$temp <- NULL
for(i in 1:nrow(BER.V)) {
    ifelse(substr(BER.V$surveyQ[i], 1, 1)==9, 
           BER.V$temp[i] <- paste0("19",BER.V$surveyQ[i],sep=""),
           BER.V$temp[i] <- paste0("20",BER.V$surveyQ[i],sep=""))
}
BER.V$surveyQ <- BER.V$temp
BER.V <- BER.V[,-ncol(BER.V)]
BER.V$surveyQ <- factor(BER.V$surveyQ)

#Latecomers and old questions excluded
BER.V <- BER.V[BER.V$Latecomer == FALSE | is.na(BER.V$Latecomer),]
BER.V <- BER.V[,1:28]
BER.V <- BER.V[,!grepl("X",colnames(BER.V))]    

#Replace Values
for(i in 7:28) {
    BER.V[,i] <- replace(BER.V[,i], BER.V[,i]==2, 0)
    BER.V[,i] <- replace(BER.V[,i], BER.V[,i]==3,-1)
}

#----------
#New faktor
BER.Vn <- read.csv("Motor_new faktor.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
colnames(BER.Vn)[1:6] <- c("region","id","sector","weight","factor","surveyQ")
BER.Vn$surveyQ <- toupper(BER.Vn$surveyQ)
BER.Vn$sector <- factor(BER.Vn$sector) #could include labels
BER.Vn$id <- factor(BER.Vn$id)
BER.Vn$region <- factor(BER.Vn$region)

BER.Vn$temp <- NULL
for(i in 1:nrow(BER.Vn)) {
    ifelse(substr(BER.Vn$surveyQ[i], 1, 1)==9, 
           BER.Vn$temp[i] <- paste0("19",BER.Vn$surveyQ[i],sep=""),
           BER.Vn$temp[i] <- paste0("20",BER.Vn$surveyQ[i],sep=""))
}
BER.Vn$surveyQ <- BER.Vn$temp
BER.Vn <- BER.Vn[,-ncol(BER.Vn)]
BER.Vn$surveyQ <- factor(BER.Vn$surveyQ)

BER.Vn <- BER.Vn[BER.Vn$Latecomer == FALSE | is.na(BER.Vn$Latecomer),]
BER.Vn <- BER.Vn[,1:28]
BER.Vn <- BER.Vn[,!grepl("X",colnames(BER.Vn))]    

for(i in 7:28) {
    BER.Vn[,i] <- replace(BER.Vn[,i], BER.Vn[,i]==2, 0)
    BER.Vn[,i] <- replace(BER.Vn[,i], BER.Vn[,i]==3,-1)
}

#MOTOR
all_v <- as.numeric(as.character(unique(BER.V$sector)))

Motor <- geweeg(BER.V,all_v,streke,2:102)
Motor_u <- ongeweeg(BER.V,all_v,streke,2:102)
WC.V <- geweeg(BER.V,all_v,1,2:102)
GP.V <- geweeg(BER.V,all_v,6,2:102)
KZN.V <- geweeg(BER.V,all_v,5,2:102)
#Interpolasie
p.inter <- c(4,5,7,9,11,12,13,15,17,18,19,21,23,25)
Motor[3,p.inter] <- pub_v[3,2:15]
Motor[6,p.inter] <- pub_v[6,2:15]
Motor[55,p.inter] <- pub_v[55,2:15]
p.inter <- c(4,5,7,9,11)
WC.V[55,p.inter] <- pub_v[55,16:20]
GP.V[55,p.inter] <- pub_v[55,21:25]
KZN.V[55,p.inter] <- pub_v[55,26:30]

#New faktor
Motor_n <- geweeg(BER.Vn,all_v,streke,2:102)
WC.V_n <- geweeg(BER.Vn,all_v,1,2:102)
GP.V_n <- geweeg(BER.Vn,all_v,6,2:102)
KZN.V_n <- geweeg(BER.Vn,all_v,5,2:102)

p.inter <- c(4,5,7,9,11,12,13,15,17,18,19,21,23,25)
Motor_n[3,p.inter] <- pub_v[3,2:15]
Motor_n[6,p.inter] <- pub_v[6,2:15]
Motor_n[55,p.inter] <- pub_v[55,2:15]
p.inter <- c(4,5,7,9,11)
WC.V_n[55,p.inter] <- pub_v[55,16:20]
GP.V_n[55,p.inter] <- pub_v[55,21:25]
KZN.V_n[55,p.inter] <- pub_v[55,26:30]
```

This section presents the results for the Motor Vehicle surveys. Table 23 reports some characteristics of the Motor survey microdata. The Motor microdata is available from 2005Q2-2017Q2 and 2005Q4 is missing. There is only one sector in these survey, i.e. 3510, so Figure 44 illustrates the number of respondents by region. 

```{r table23, echo=FALSE, results='asis', warning=FALSE, message=FALSE, cache = TRUE}
ave <- mean(aggregate(BER.V$id, by=list(BER.V$surveyQ), FUN = length)[,2])
tafel <- cbind("1992Q2-2017Q2",length(BER.V$id),round(ave,2),
               "1992Q4,1993Q3,2005Q4")
colnames(tafel) <- c("Sample","Total Obs","Obs/Quarter","Missing Quarters")     
row.names(tafel) <- "Motor Vehicle Survey"
xt <- xtable(tafel, caption="Sample characteristics")
print(xt, "latex",comment=FALSE, caption.placement = getOption("xtable.caption.placement", "top"), scalebox = 0.8,
      include.rownames=TRUE)
```

```{r figure44, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Number of Motor Vehicle respondents by region (1992Q2-2017Q2)"}
BERplot <- BER.V
BERplot1 <- aggregate(BERplot$id, by=list(BERplot$surveyQ,BERplot$region), FUN = length)
BERplot1$Group.1 <- as.Date(as.yearqtr(BERplot1$Group.1, format = "%YQ%q"))
g <- ggplot(BERplot1, aes(x=Group.1, y=x,fill=Group.2))
g <- g + geom_bar(stat="identity")
g <- g + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g <- g + scale_fill_discrete(name="Region")
g <- g + scale_y_continuous(labels=comma)
g <- g + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g <- g + ylab("Number of Respondents")
g <- g + xlab(" ")
g
```

###The Motor Vehicle Indicators
Similar to the previous surveys, we calculate balance statistics in the same way as the normal BER procedure, in order to compare the results to the published series. The second set of indicators is based on a new 4-part firm classification. Because there is only one subsector in the Motor surveys, the 2-step weighting procedure is not necessary (i.e. the subsector series are identical). 

####Published Series
In this section the published results are compared to the balances calculated with the microdata. Figure 45 illustrates the results for a selection of questions for new and used vehicles, as well as spare parts. Similar to the Retail and Wholesale surveys, there seem to have been adjustment factors added at the start of the period. These adjustment factors seem to have been relatively minor and the series seem to correspond well to the published data. Figure 46 illustrates that the published and microdata series for the three main regions and are very similar. The microdata therefore seems to be correct.

```{r figure45, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Motor Vehicle series compared to the published series"}
#New Vehicles
indicator_plot <- cbind(Motor[,c("Datum","Q1")],pub_v[,"New_Q1"]) 
colnames(indicator_plot) <- c("Date","Weighted","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("New Vehicles: Q1") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Motor[,c("Datum","Q2A")],pub_v[,"New_Q2A"]) 
colnames(indicator_plot) <- c("Date","Weighted","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("New Vehicles: Q2A") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(Motor[,c("Datum","Q8A")],pub_v[,"Used_Q3A"]) 
colnames(indicator_plot) <- c("Date","Weighted","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Used Vehicles: Q3A") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom")

indicator_plot <- cbind(Motor[,c("Datum","Q12A")],pub_v[,"Spare_Q3A"]) 
colnames(indicator_plot) <- c("Date","Weighted","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("Indicator") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Spare Parts: Q3A") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g4 <- g4 + theme(legend.position="bottom")

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

```{r figure46, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Motor Vehicle regional series compared to the published series"}
indicator_plot <- cbind(WC.V[,c("Datum","Q2A")],pub_v[,"WC_Q2A"]) 
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("WC: Q2A") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(GP.V[,c("Datum","Q2A")],pub_v[,"GP_Q2A"]) 
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("GP: Q2A") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(KZN.V[,c("Datum","Q2A")],pub_v[,"KZN_Q2A"]) 
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("KZN: Q2A") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))

indicator_plot <- cbind(WC.V[,c("Datum","Q2A")],GP.V[,c("Q2A")],KZN.V[,c("Q2A")]) 
colnames(indicator_plot) <- c("Date","WC","GP","KZN")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Regions: Q2A") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

####New Indicators
This section compares the microdata results using the old and new firm weights. Figure 47 illustrates the comparison for New Motor Vehicles for a selection of questions and Figure 48 compares the results for a selection of the new vehicles for the three main regions. The new weights produce series that are slightly less volatile than the old series.

```{r figure47, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Motor Vehicle series using different weights"}
indicator_plot <- cbind(Motor[,c("Datum","Q1")],Motor_n[,c("Q1")]) 
colnames(indicator_plot) <- c("Date","Microdata","New Weights")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("New Vehicles: Q1") + theme(plot.title = element_text(hjust = 0.5))
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Motor[,c("Datum","Q2A")],Motor_n[,"Q2A"]) 
colnames(indicator_plot) <- c("Date","Microdata","New Weights")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("New Vehicles: Q2A") + theme(plot.title = element_text(hjust = 0.5))
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(Motor[,c("Datum","Q3A")],Motor_n[,"Q3A"]) 
colnames(indicator_plot) <- c("Date","Microdata","New Weights")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("New Vehicles: Q3A") + theme(plot.title = element_text(hjust = 0.5))
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))

indicator_plot <- cbind(Motor[,c("Datum","Q5")],Motor_n[,"Q5"]) 
colnames(indicator_plot) <- c("Date","Microdata","New Weights")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("New Vehicles: Q5") + theme(plot.title = element_text(hjust = 0.5))
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

```{r figure48, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Motor Vehicle regions using different weights"}
indicator_plot <- cbind(WC.V[,c("Datum","Q1")],WC.V_n[,"Q1"]) 
colnames(indicator_plot) <- c("Date","Microdata","New Weights")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("WC: Q1") + theme(plot.title = element_text(hjust = 0.5))
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(GP.V[,c("Datum","Q1")],GP.V_n[,"Q1"]) 
colnames(indicator_plot) <- c("Date","Microdata","New Weights")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("GP: Q1") + theme(plot.title = element_text(hjust = 0.5))
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(KZN.V[,c("Datum","Q1")],KZN.V_n[,"Q1"]) 
colnames(indicator_plot) <- c("Date","Microdata","New Weights")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("KZN: Q1") + theme(plot.title = element_text(hjust = 0.5))
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))

indicator_plot <- cbind(WC.V_n[,c("Datum","Q1")],GP.V_n[,c("Q1")],KZN.V_n[,c("Q1")]) 
colnames(indicator_plot) <- c("Date","WC","GP","KZN")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Regions: Q1") + theme(plot.title = element_text(hjust = 0.5))
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

###Reference Series
This section compares the series to their respective reference series. The reference series that we use in this case are the NAAMSA total and passenger car sales. Figure 49 compares the balance series for total New Vehicle sales to the NAAMSA total and passenger car sales. Table 24 reports the contemporaneous correlations between the series. The correlations are very high and significant, which is confirmed by the cross-correlations illustrated in Figure 50. The new weights are produces series that are less volatile than the published data, as reported in Table 25.

```{r figure49, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="New Motor Vehicle sales compared to the reference series"}
indicator_plot <- cbind(Motor[,c("Datum","Q2A","Q3A")],ref_v[,c("Total_Sales","Passenger_Sales")]) 
colnames(indicator_plot) <- c("Date","Q2A","Q3A","Total_Sales","Passenger_Sales")
indicator_plot[,-1] <- scale(indicator_plot[,-1])
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g <- g + geom_line()
g <- g + ylab("Indicator") + xlab("")
#g <- g + ggtitle("Motor Reference Series")
g <- g + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g <- g + theme(legend.title=element_blank()) 
g <- g + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g <- g + theme(legend.position="bottom")
g
```

\begin{table}[ht]
\centering
\caption{Correlations of new vehicles sales with reference series} 
\scalebox{0.8}{
\begin{tabular}{|r|lll|lll|}
  \hline
 & Q2A & Q2A\_u & Q2A\_n & Q3A & Q3A\_u & Q3A\_n \\ 
  \hline
Total\_Sales &  0.89*** &  0.90*** &  0.90*** &  0.89*** &  0.90*** &  0.90*** \\ 
  Passenger\_Sales &  0.88*** &  0.90*** &  0.89*** &  0.89*** &  0.90*** &  0.90*** \\ 
   \hline
\end{tabular}
}
\end{table}

```{r figure50, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Cross-correlations of new vehicle sales"}
motor_trade <- cbind(Motor[,c("Q2A","Q3A")],Motor_u[,c("Q2A","Q3A")],
                     Motor_n[,c("Q2A","Q3A")],ref_v[,c("Total_Sales","Passenger_Sales")]) 
colnames(motor_trade) <- c("Q2A","Q3A","Q2A_u","Q3A_u","Q2A_n","Q3A_n",
                           "Total_Sales","Passenger_Sales")

Q2A <- motor_trade[,1]
Q3A <- motor_trade[,2] 
Q2A_n <- motor_trade[,5] 
Q3A_n <- motor_trade[,6] 
Passenger_Sales <- motor_trade[,6]

par(mfrow=c(2,2))
ccf(Q2A, Passenger_Sales, na.action = na.pass, ylim=c(-0.2, 1))
ccf(Q3A, Passenger_Sales, na.action = na.pass, ylim=c(-0.2, 1))
ccf(Q2A_n, Passenger_Sales, na.action = na.pass, ylim=c(-0.2, 1))
ccf(Q3A_n, Passenger_Sales, na.action = na.pass, ylim=c(-0.2, 1))
```

\begin{table}[ht]
\centering
\caption{Volatility of new motor vehicle series} 
\scalebox{0.8}{
\begin{tabular}{|r|rrr|rrr|}
  \hline
 & Q2A & Q2A\_u & Q2A\_n & Q3A & Q3A\_u & Q3A\_n \\ 
  \hline
Volatility & 47.50 & 43.13 & 44.92 & 46.15 & 41.53 & 43.35 \\ 
   \hline
\end{tabular}
}
\end{table}

Figure 51 compares the regional series for total New Vehicle sales to the regional NAAMSA total and passenger car sales. Table 26 reports that the correlations between these series are also high and significant. In general the new weights increase these correlations compared to the old weights.

```{r figure51, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Motor Vehicle regions compared to the reference series"}
indicator_plot <- cbind(WC.V[,c("Datum","Q2A","Q3A")],ref_v[,c("WC_Passenger")])
indicator_plot[,-1] <- scale(indicator_plot[,-1])
colnames(indicator_plot) <- c("Date","Q2A","Q3A","Passenger_Sales")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("WC") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(GP.V[,c("Datum","Q2A","Q3A")],ref_v[,c("GP_Passenger")])
indicator_plot[,-1] <- scale(indicator_plot[,-1])
colnames(indicator_plot) <- c("Date","Q2A","Q3A","Passenger_Sales")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("GP") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(KZN.V[,c("Datum","Q2A","Q3A")],ref_v[,c("KZN_Passenger")])
indicator_plot[,-1] <- scale(indicator_plot[,-1])
colnames(indicator_plot) <- c("Date","Q2A","Q3A","Passenger_Sales")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("KZN") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))

library(gridExtra)
grid.arrange(g1, g2, g3, ncol=2, nrow =2)
```

\begin{table}[ht]
\centering
\caption{Regional correlations with reference series}
\scalebox{0.8}{
\begin{tabular}{|r|ll|ll|}
  \hline
 & WC\_Q2A & WC\_Q2A\_n & WC\_Q3A & WC\_Q3A\_n \\ 
  \hline
Total Sales &  0.77*** &  0.83*** &  0.75*** &  0.81*** \\ 
  Passenger Sales &  0.77*** &  0.82*** &  0.75*** &  0.80*** \\ 
   \hline

 & GP\_Q2A & GP\_Q2A\_n & GP\_Q3A & GP\_Q3A\_n \\ 
  \hline
Total Sales &  0.74*** &  0.77*** &  0.73*** &  0.76*** \\ 
  Passenger Sales &  0.76*** &  0.78*** &  0.75*** &  0.78*** \\ 
   \hline

 & KZN\_Q2A & KZN\_Q2A\_n & KZN\_Q3A & KZN\_Q3A\_n \\ 
  \hline
Total Sales &  0.80*** &  0.80*** &  0.77*** &  0.78*** \\ 
  Passenger Sales &  0.80*** &  0.78*** &  0.76*** &  0.76*** \\ 
   \hline
\end{tabular}
}
\end{table}

##Summary
After some corrections the microdata seems to provide series that correspond very closely to the published series. We have calculated new series and compared them to the reference series, for the retail and motor vehicles surveys. In general, the new weights and the 2-step weighting procedure produce series that are less volatile and exhibit an improved tracking record, in the sense they have higher correlations with the reference series. We still have to choose the reference series for the wholesale sector. The final series still have to be written to an Excel file, in a format that is convenient for processing. The updates can and should be fully automated.


\newpage
#The Services Survey
```{r S.services, echo=FALSE, results='hide', message=FALSE, warning=FALSE, cache = TRUE}
pub_s <- read.csv("Services_BER_Published.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
#ref_s <- read.csv("Ref Series_Services.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)

#SERVICES

BER.S <- read.csv("Services_05Q2-17Q2.csv", header=TRUE, sep=",",na.strings = "", skipNul = TRUE)
colnames(BER.S)[1:6] <- c("region","id","sector","weight","factor","surveyQ")
BER.S$surveyQ <- toupper(BER.S$surveyQ)
BER.S$sector <- factor(BER.S$sector) #could include labels
BER.S$id <- factor(BER.S$id)
BER.S$region <- factor(BER.S$region)

#Clean SurveyQ variable
BER.S$temp <- NULL
for(i in 1:nrow(BER.S)) {
    ifelse(substr(BER.S$surveyQ[i], 1, 1)==9, 
           BER.S$temp[i] <- paste0("19",BER.S$surveyQ[i],sep=""),
           BER.S$temp[i] <- paste0("20",BER.S$surveyQ[i],sep=""))
}
BER.S$surveyQ <- BER.S$temp
BER.S <- BER.S[,-ncol(BER.S)]
BER.S$surveyQ <- factor(BER.S$surveyQ)

#Eclude Latecomers and old quesions
BER.S <- BER.S[BER.S$Latecomer == FALSE | is.na(BER.S$Latecomer),]
BER.S <- BER.S[,1:21]
BER.S <- BER.S[,!grepl("X",colnames(BER.S))]    

#Replace Values
for(i in 7:21) {
    BER.S[,i] <- replace(BER.S[,i], BER.S[,i]==2, 0)
    BER.S[,i] <- replace(BER.S[,i], BER.S[,i]==3,-1)
}

for(i in 18:21) {
    BER.S[,i] <- replace(BER.S[,i], BER.S[,i]==0, 0.5)
    BER.S[,i] <- replace(BER.S[,i], BER.S[,i]==-1, 0)
}

#SERVICES
catering <- c(6000,6001,6020,6030,6011)
transport.s <- c(7020,7010,7070,7090,7080,7060,7000,7040,7100,7120,7110,7050)
realestate <- c(8000,8010,8020)
business <- c(8040,8080,8070,8090,8060,8050,8030,
              8150,8120,8210,8180,8140,8160,8190,8100,8200,8230,8130,8110,8170,8240,8220)
community <- c(9000,9010,9030,9050,9060,9020,9040)
all_s <- as.numeric(as.character(unique(BER.S$sector)))
#streke <- unique(BER.S$region)

#SERVICES
Services_w <- geweeg(BER.S,all_s,streke,54:102)
Services <- ongeweeg(BER.S,all_s,streke,54:102)

ServicesC <- ongeweeg(BER.S,catering,streke,54:102)
ServicesT <- ongeweeg(BER.S,transport.s,streke,54:102)
ServicesR <- ongeweeg(BER.S,realestate,streke,54:102)
ServicesB <- ongeweeg(BER.S,business,streke,54:102)

WC.S <- ongeweeg(BER.S,all_s,1,54:102)
GP.S <- ongeweeg(BER.S,all_s,6,54:102)
KZN.S <- ongeweeg(BER.S,all_s,5,54:102)

#Interpolasie
p.inter <- c(4,5,7,9,11,13)
Services[3,p.inter] <- pub_s[3,2:7]
ServicesC[3,p.inter] <- pub_s[3,13:18]
ServicesT[3,p.inter] <- pub_s[3,24:29]
ServicesR[3,p.inter] <- pub_s[3,35:40]
ServicesB[3,p.inter] <- pub_s[3,46:51]

p.inter <- c(4,5,7,9,11,13)
WC.S[3,p.inter] <- pub_s[3,79:84]
GP.S[3,p.inter] <- pub_s[3,68:73]
KZN.S[3,p.inter] <- pub_s[3,90:95]

```

##Collating and Cleaning the Microdata
Table 27 reports some characteristics of the Services survey microdata. The Building microdata are missing for 2005Q4. Where published series were available, we used the published values for those missing values. Where they were unavailable, we used simple linear interpolation to create complete continuous series. 

```{r table27, echo=FALSE, results='asis', warning=FALSE, message=FALSE, cache = TRUE}
ave <- mean(aggregate(BER.S$id, by=list(BER.S$surveyQ), FUN = length)[,2])
tafel <- cbind("2005Q2-2017Q2",length(BER.S$id),round(ave,2),
               "2005Q4")
colnames(tafel) <- c("Sample","Total Obs","Obs/Quarter","Missing Quarters")     
row.names(tafel) <- "Services Survey"
xt <- xtable(tafel, caption="Sample characteristics")
print(xt, "latex",comment=FALSE, caption.placement = getOption("xtable.caption.placement", "top"), scalebox = 0.8,
      include.rownames=TRUE)
```

Table 28 reports the subsector codes that were used to split the sample. The subsectors are *Hotels and Restaurants (Catering)*, *Transport and Storage*, *Real Estate*, *Business Services*, and *Community Services*. Figure 52 illustrates the number of respondents to the Services survey, by subsector. Because the number of respondents for Community and Personal Services are so low, we do not calculate separate balance statistics for this subsector.

\begin{table}[]
\centering
\caption{Services Sector Codes}
\label{my-label}
\scalebox{0.9}{
\begin{tabular}{|l|l|}
\hline
\textbf{Sector}                                                              & \textbf{Code}                                                                                                                                                                          \\ \hline
\begin{tabular}[c]{@{}l@{}}Hotels and Restaurants \\ (Catering)\end{tabular} & 6000, 6001, 6020, 6030, 6011                                                                                                                                                           \\ \hline
Transport and Storage                                                        & \begin{tabular}[c]{@{}l@{}}7020, 7010, 7070, 7090, 7080, \\ 7060, 7000, 7040, 7100, 7120, \\ 7110, 7050\end{tabular}                                                                   \\ \hline
Real Estate                                                                  & 8000, 8010, 8020                                                                                                                                                                       \\ \hline
Business Services                                                            & \begin{tabular}[c]{@{}l@{}}8040, 8080, 8070, 8090, 8060, \\ 8050, 8030, 8150, 8120, 8210, \\ 8180, 8140, 8160, 8190, 8100, \\ 8200, 8230, 8130, 8110, 8170, \\ 8240, 8220\end{tabular} \\ \hline
Community Services                                                           & \begin{tabular}[c]{@{}l@{}}9000, 9010, 9030, 9050, 9060, \\ 9020, 9040\end{tabular}                                                                                                    \\ \hline
\end{tabular}}
\end{table}

```{r figure52, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Number of respondents in the services sector (2005Q2-2017Q2)"}
BERplot <- BER.S
BERplot$Sector[BERplot$sector %in% catering] <- "Catering" 
BERplot$Sector[BERplot$sector %in% transport.s] <- "Transport and Storage" 
BERplot$Sector[BERplot$sector %in% realestate] <- "Real Estate" 
BERplot$Sector[BERplot$sector %in% business] <- "Business Services" 
#BERplot$Sector[BERplot$sector %in% other] <- "Other Business Activities" 
BERplot$Sector[BERplot$sector %in% community] <- "Community Services" 

BERplot1 <- aggregate(BERplot$id, by=list(BERplot$surveyQ,BERplot$Sector), FUN = length)
BERplot1$Group.1 <- as.Date(as.yearqtr(BERplot1$Group.1, format = "%YQ%q"))
g <- ggplot(BERplot1, aes(x=Group.1, y=x,fill=Group.2))
g <- g + geom_bar(stat="identity")
g <- g + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g <- g + scale_fill_discrete(name="Sector")
g <- g + scale_y_continuous(labels=comma)
g <- g + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g <- g + ylab("Number of Respondents")
g <- g + xlab(" ")
g
```

##The Survey Indicators
Similar to the Building survey, the Services sector survey responses do not receive weights (i.e. responses are weighted equally). The results are similar when the firm size weights are used. In order to be consistent throughout all the BER surveys, I would suggest that in future research we should create a weighted version of the Services indicators. We would need to calculate subsector size weights and the firm size weights should also be converted to four categories, as we have done with the other surveys. Once we have these weights we can apply the 2-step weighting procedure. The old sector codes (e.g. 6020, 6030, 8020, 8050, 8060, 8220, 8230, 8240 and 9060) also need to be converted to the new sector codes.

###Published Series
In this section the published results are compared to the balances calculated with the microdata. Figure 53 illustrates the Total Services series compared to the BER's published series.[^6] In many cases the published series are only available for the first few years of the sample period. Figure 54 compares the Services subsectors to the published series, and Figure 55 compares the regional total Services series compared to the published series. 

[^6]: As far as I understand, the BER does not really publish the results from the services surveys.

Although the results do not seem to match up perfectly, the balances from the microdata seem to at least follow the same pattern as the published data. The serious exceptions are the responses to questions on constraints.[^7] These questions are weighted slightly differently from the normal balances, whereby the responses receive a weighted of 1, 0.5 and 0, instead of the standard 1, 0 and -1 quantification system. It is possible that the published series did not follow this weighting convention consistently. Be that as it may, we think that the microdata is probably correct and can be used to calculate new balance series for the Services sector.

[^7]: Since 2015Q2, the word "skilled" has been added to the "shortage of labour constraint" question. This change in the wording of the question should be taken into account when using the time series.

```{r figure53, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Total Services series compared to the published series"}
#Total Services
indicator_plot <- cbind(Services[,c("Datum","Q1")],pub_s[,"Total_Q1"]) 
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Services: Q1") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(Services[,c("Datum","Q2A")],pub_s[,"Total_Q2A"]) 
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("Services: Q2A") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(Services[,c("Datum","Q3A")],pub_s[,"Total_Q3A"]) 
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Services: Q3A") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom")

indicator_plot <- cbind(Services[,c("Datum","Q8")],pub_s[,"Total_Q8"]) 
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Services: Q8") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom")
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

```{r figure54, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Services subsectors compared to the published series"}
#Sales Volumes
indicator_plot <- cbind(ServicesC[,c("Datum","Q2A")],pub_s[,"Accom_Q2A"]) 
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("Catering: Q2A") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(ServicesR[,c("Datum","Q2A")],pub_s[,"RE_Q2A"]) 
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("Real Estate: Q2A") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(ServicesT[,c("Datum","Q2A")],pub_s[,"Trans_Q2A"]) 
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("Transport: Q2A") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom")

indicator_plot <- cbind(ServicesB[,c("Datum","Q2A")],pub_s[,"BS_Q2A"]) 
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Business: Q2A") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom")
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

```{r figure55, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE, fig.height=4.5, fig.width=7.5, fig.cap="Services regional series compared to the published series"}
indicator_plot <- cbind(WC.S[,c("Datum","Q2A")],pub_s[,"WC_Q2A"]) 
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g1 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g1 <- g1 + geom_line()
g1 <- g1 + ylab("Indicator") + xlab("")
g1 <- g1 + theme(legend.title=element_blank())
g1 <- g1 + ggtitle("WC: Q2A") 
g1 <- g1 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g1 <- g1 + theme(legend.title=element_blank()) 
g1 <- g1 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g1 <- g1 + theme(legend.position="none")

indicator_plot <- cbind(GP.S[,c("Datum","Q2A")],pub_s[,"GP_Q2A"]) 
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g2 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g2 <- g2 + geom_line()
g2 <- g2 + ylab("") + xlab("")
g2 <- g2 + theme(legend.title=element_blank())
g2 <- g2 + ggtitle("GP: Q2A") 
g2 <- g2 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g2 <- g2 + theme(legend.title=element_blank()) 
g2 <- g2 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g2 <- g2 + theme(legend.position="none")

indicator_plot <- cbind(KZN.S[,c("Datum","Q2A")],pub_s[,"KZN_Q2A"]) 
colnames(indicator_plot) <- c("Date","Microdata","Published")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g3 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g3 <- g3 + geom_line()
g3 <- g3 + ylab("Indicator") + xlab("")
g3 <- g3 + theme(legend.title=element_blank())
g3 <- g3 + ggtitle("KZN: Q2A") 
g3 <- g3 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g3 <- g3 + theme(legend.title=element_blank()) 
g3 <- g3 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))
g3 <- g3 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))

indicator_plot <- cbind(WC.S[,c("Datum","Q2A")],GP.S[,c("Q2A")],KZN.S[,c("Q2A")]) 
colnames(indicator_plot) <- c("Date","WC","GP","KZN")
indicator_plot <- melt(indicator_plot, id="Date")  # convert to long format
g4 <- ggplot(data=indicator_plot,aes(x=Date, y=value, group=variable, colour=variable)) 
g4 <- g4 + geom_line()
g4 <- g4 + ylab("") + xlab("")
g4 <- g4 + theme(legend.title=element_blank())
g4 <- g4 + ggtitle("Regions: Q2A") 
g4 <- g4 + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
g4 <- g4 + theme(legend.title=element_blank()) 
g4 <- g4 + theme(legend.position="bottom",plot.margin=unit(c(-0.5,0.4,0,0.4), "cm"))
g4 <- g4 + scale_x_date(labels = date_format("%Y"),breaks = date_breaks("year"))

library(gridExtra)
grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)
```

##Reference Series
We still need to choose reference series for the Services sector. Once we have chosen reference series we can evaluate the services series in terms of tracking record and volatility. 

#Future Research
-	I would suggest that we automate the entire process (potentially in R, which is freeware), all the way from the cleaning, processing, calculations and analysis, to the presentation of the survey data. This would significantly speed up the update each quarter. 
-	Although the weights do not seem to make a huge difference to the final results, I would suggest that we use a consistent weighting procedure for all of the surveys. This should probably be based on the 2-step procedure recommended in the textbooks (e.g. @UN2015). 
-	We could investigate all the series based on forward-looking questions, i.e. expected conditions. These potentially include important information and arguably reflect "confidence" more than those of current conditions. We could also combine the series, to form more stable composite indicators, as is done in most other jurisdictions, e.g. the European Commission Economic Sentiment Index.
-	We could include latecomers in the following quarter, going back to the start of the period (2001). 
-	We could investigate the seasonality of the balance statistics. A seasonal adjustment might improve the tracking record of the series.
-	We could investigate whether there are cyclical differences between different subsectors. For example, does the sub-contractor activity follow contractor activity?
-	We should chain the new series to the old series, in the period before the microdata are available. 
-	We could look at drivers of the balance series and investigate their usefulness in terms of forecasting and nowcasting.
-	We should try to present the results in a user-friendly way. For instance, when are changes significant? Should we look at moving averages or standardised series? We can compare changes to their averages, or create confidence intervals.
-	We could investigate which series to focus on, perhaps using PCA. Specific series may capture most of the important information; otherwise combined composite series may be even more useful.
-	We still need to find reference series for the Wholesale Survey results.
-	We still need to update the weights and find reference series for the Services Surveys.


#References






